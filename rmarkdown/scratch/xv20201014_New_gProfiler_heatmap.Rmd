---
title: "xv20200708_gProfiler_heatmap"
output: html_document
---

# I will import gProfiler app and analyse hits based on this. 
## General hits
## Hits within LADs and iLADs
## Hits in different types of chromatin

```{r, include = FALSE}
library(tidyverse) 
library(ggbeeswarm)
library(corrplot)
library(pheatmap)
library(viridis)
library(factoextra)
library(NbClust)
library(ggpubr)
library(ggbiplot)
library(ggrepel)
library(readxl)
library(gridExtra)
library(gprofiler2)
library(readxl)
library(RColorBrewer)
```

```{r}
chip.dt = readRDS('/DATA/projects/DSBrepair/data/R/cl20191219_ChIP_zscore_selection_chipmentation.RDS')
clone5bcs <- gsub(".B", "" ,unique(screen.detail$barcode))
chip_clone5 = chip.dt[pool=='clone5' & ID %in% clone5bcs,c('ID','LMNB1', 'late_replicating', 'H3K9me2', 'H3K27me3', 'H3K4me1',
                                    'H3K4me2', 'H3K4me3', 'H3K27ac',
                                     'H3K36me3', 'POL2AS2',
                                    'POL2')] %>% column_to_rownames('ID')

pheatmap(t(chip_clone5), cluster_rows=T,
         color = colorRampPalette(rev(brewer.pal(n = 11, name="RdBu")))(100), breaks = myBreaks(t(chip_clone5),100))
```

```{r}
#functions
#mybreaks
myBreaks <- function(test, p) {c(seq(min(test), 0, length.out=ceiling(p/2) + 1), 
              seq(max(test)/p, max(test), length.out=floor(p/2)))}
```
#Import data tables
```{r setup, include=FALSE}
screen.score <- readRDS("~/XV_P3_ChromDSBScreen/xv20200421_ChromDSBscreen/data/xv20201014_frozen_chz_scores_dcast.rds")
screen.detail <- readRDS("~/XV_P3_ChromDSBScreen/xv20200421_ChromDSBscreen/data/xv20201014_frozen_chz_scores_mmej.rds")
screen.score.totals <-  readRDS("~/XV_P3_ChromDSBScreen/xv20200421_ChromDSBscreen/data/xv20201014_frozen_chz_scores_dcast.rds")

screen.controls <- readRDS("~/XV_P3_ChromDSBScreen/xv20200421_ChromDSBscreen/data/xv20201014_frozen_chz_scores_controls.rds")
```

#General plots
```{r}
chromatin.colors <- c("#00983A","#FFDE00","#D91F5D","#63328A","#838688")
chromatin.levels <- c("euchromatin-transcription","transcription","H3K27me3","late_replicating-LAD-H3K9me2","other-heterochromatin")

# WT vs. POLQ
pdf(file = "~/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/export/xv20201014_control_effect.pdf", height = 3, useDingbats = F)
ggplot(screen.controls %>% select(gene,mmej.SCscore,chromatin) %>% distinct()) + geom_quasirandom(aes(gene,mmej.SCscore, color = fct_relevel(chromatin,chromatin.levels))) + theme_bw() + coord_cartesian() + ylab("z-score (MMEJscore)") + scale_color_manual(values = chromatin.colors) + coord_fixed(ratio = 0.15, ylim = c(-20,6))
dev.off()

# Effect in each chromatin type
pdf(file = "~/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/export/xv20201014_library_effect.pdf", height = 3, width = 6,useDingbats = F)
ggplot(screen.detail %>% select(gene, mmej.SCscore, chromatin) %>% distinct()) +
  geom_quasirandom(aes(fct_relevel(chromatin,chromatin.levels),mmej.SCscore, color = abs(mmej.SCscore) > 1.65), size = 0.25) + theme_bw() + scale_color_manual(values = c("grey80", "black")) + stat_summary(aes(fct_relevel(chromatin,chromatin.levels),mmej.SCscore), fun = "mean", geom = "crossbar", color = "red", fatten = 1) + ylab("z-score (MMEJscore)") + theme(legend.position = "none") + coord_fixed(ratio = 0.1,ylim = c(-20,6))
dev.off()
```

## Heat map of hits: Plot z-scores as a heatmap
```{r}
gene.hits.hmap <- screen.score.totals
CI.90.hits.list <- apply(gene.hits.hmap[2:length(gene.hits.hmap)],2, function(x){gene.hits.hmap %>% filter(x > 1.65 | x < -1.65) %>% pull(gene)})
CI.90.hits <- Reduce(union,CI.90.hits.list)
gene.hits.hmap.b <- gene.hits.hmap %>% filter(gene %in% CI.90.hits) %>% column_to_rownames(var = "gene")

pheatmap(as.matrix(gene.hits.hmap.b), breaks = c(min(gene.hits.hmap.b), -1.65,1.65,max(gene.hits.hmap.b)), color = c("blue", "grey90", "red"), cellwidth = 10,cellheight = 2, treeheight_row = 50, treeheight_col = 5, fontsize_row = 5)

#Change colnames
colnames(gene.hits.hmap.b) <- c("Regulatory elements (4 IPRs)","H3K27me3 (4 IPRs)","Triple heterochromatin (4 IPRs)","Others (5 IPRs)","Gene bodies (2 IPRs)")

# The dendrogram for rows
dst <- dist(gene.hits.hmap.b)
hc_row <- hclust(dst)
row_dend <- as.dendrogram(hc_row)
row_dend <- seriate_dendrogram(row_dend, dst, method="OLO")

pdf(file = "~/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/export/xv20201015_gene_heatmap_horizontal.pdf", width = 20)
pheatmap(as.matrix(t(gene.hits.hmap.b)), breaks = seq(-5,5, by = 0.1), cellwidth = 7,cellheight = 7, treeheight_row = 30, treeheight_col = 80, fontsize_col = 7, fontsize_row = 7, border_color = NA)
dev.off()

pdf(file = "~/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/export/xv20201019_gene_heatmap_horizontal.pdf", width = 10)
pheatmap((as.matrix(t(gene.hits.hmap.b %>% select('Regulatory elements (4 IPRs)','Gene bodies (2 IPRs)','H3K27me3 (4 IPRs)','Triple heterochromatin (4 IPRs)','Others (5 IPRs)')))), breaks = seq(-5,5, by = 0.1), cellwidth = 3,cellheight = 12, treeheight_col = 80, show_colnames = F, border_color = NA, cluster_row = F, cluster_cols=as.hclust(row_dend), color=colorRampPalette(c("#EB2030","grey90","#2E358F"))(100))
dev.off()

pdf(file = "~/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/export/xv20201019_gene_heatmap_horizontal_names.pdf", width = 20)
pheatmap((as.matrix(t(gene.hits.hmap.b %>% select('Regulatory elements (4 IPRs)','Gene bodies (2 IPRs)','H3K27me3 (4 IPRs)','Triple heterochromatin (4 IPRs)','Others (5 IPRs)')))), breaks = seq(-5,5, by = 0.1), cellwidth = 8,cellheight = 12, treeheight_col = 80, show_colnames = T, border_color = NA, cluster_row = F, cluster_cols=as.hclust(row_dend), color=colorRampPalette(c("#EB2030","grey90","#2E358F"))(100))
dev.off()

```


## Extract hits to it per chromatin type

```{r cars}
# Filter NHEJ complexes
screen.score.totals.filter <- screen.score.totals

# CI > 1.65
NHEJ.hits <- apply(screen.score.totals.filter[2:length(screen.score.totals.filter)],2,function(x) {filter(screen.score.totals.filter, x > 1.65) %>% pull(gene)})
MMEJ.hits <- apply(screen.score.totals.filter[2:length(screen.score.totals.filter)],2,function(x) {filter(screen.score.totals.filter, x < -1.65) %>% pull(gene)})
hits <- apply(screen.score.totals.filter[2:length(screen.score.totals.filter)],2,function(x) {filter(screen.score.totals.filter, abs(x) > 1.65) %>% pull(gene)})

# run gProfiler
NHEJ.gost <- gost(NHEJ.hits,source = "CORUM")
MMEJ.gost <- gost(MMEJ.hits,source = "CORUM")
hits.gost <- gost(hits,source = "CORUM")

#Get link to webtool
NHEJ.gost.link <- gost(NHEJ.hits,source = "CORUM", as_short_link = T)
MMEJ.gost.link <- gost(MMEJ.hits,source = "CORUM", as_short_link = T)
hits.gost.link <- gost(hits,source = "CORUM", as_short_link = T)

#Plot gostplot
gostplot(NHEJ.gost)
gostplot(MMEJ.gost)
gostplot(hits.gost)

# Select variables that are interesting for us
NHEJ.complex <- NHEJ.gost$result %>% select(query,p_value,term_name) %>% mutate(effect = -log10(p_value))
MMEJ.complex <- MMEJ.gost$result %>% select(query, p_value, term_name) %>% mutate(effect = log10(p_value)) 
hit.complexes <- bind_rows(NHEJ.complex,MMEJ.complex) %>% select(- p_value) %>% distinct() %>% reshape2::dcast(term_name ~ query, value.var = "effect", fun.aggregate = mean) %>% column_to_rownames(var = "term_name")
hit.complexes[is.na(hit.complexes)] <- 0

#Plot everything
hit.complex <- hits.gost$result %>% select(query, p_value, term_name) %>% mutate(effect = -log10(p_value)) %>% select(- p_value) %>% distinct() %>% reshape2::dcast(term_name ~ query, value.var = "effect", fun.aggregate = mean) %>% column_to_rownames(var = "term_name")

#Change colnames
colnames(hit.complexes) <- c("Regulatory elements (4 IPRs)","H3K27me3 (4 IPRs)","Triple heterochromatin (4 IPRs)","Others (5 IPRs)","Gene bodies (2 IPRs)")


# Plot heatmap for chromatin types
pdf(file = "~/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/export/xv20201019_CORUM_complex_heatmap.pdf")

pheatmap(as.matrix(hit.complexes %>% select('Regulatory elements (4 IPRs)','Gene bodies (2 IPRs)','H3K27me3 (4 IPRs)','Triple heterochromatin (4 IPRs)','Others (5 IPRs)')), color = c("#EB2030","grey90","#2E358F"), breaks = c(-1,-0.95,0.95,1), cellheight = 15, cellwidth = 15,border_color = NA, treeheight_row = 15, cluster_cols = F)

dev.off()
```

## MLL protein plots

```{r}
MLL.proteins <- filter(screen.detail, gene %in% c("KMT2A","ASH2L", "RBBP5","KDM6A","PAXIP1"))

MLL.prot.level <- c("KMT2A","ASH2L","RBBP5","KDM6A","PAXIP1","WT","POLQ")

#Arrange dt
MLL.and.controls <- screen.controls %>% bind_rows(MLL.proteins) %>% select(chromatin, MMEJscore, t.rep, gene) %>% dplyr::group_by(chromatin,t.rep,gene) %>% dplyr::summarise(MMEJ.p = mean(MMEJscore)) %>% ungroup() %>% dplyr::group_by(chromatin,gene) %>% dplyr::mutate(MMEJ = mean(MMEJ.p))%>% mutate(NHEJ = 1 - MMEJ) %>% reshape2::melt(id.vars = c("chromatin","t.rep","gene", "MMEJ.p"), variable.name = "pathway")

MLL.and.controls.chr <- filter(MLL.and.controls, !chromatin %in% c("euchromatin","transcription","other-heterochromatin"))

chrom.labs <- c("Regulatory elements (4 DSBs)","H3K27me3 (4 DSBs)","Triple heterochromatin (4 DSBs)","Gene bodies (2 DSBs)","Others (5 DSBs)")
names(chrom.labs) <- c("euchromatin-transcription","H3K27me3","late_replicating-LAD-H3K9me2","transcription","other-heterochromatin")

#plot
pdf(file = "~/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/export/xv20200722_balances.pdf", height = 3, width = 9)
ggplot() + geom_col(data = MLL.and.controls.chr %>% select(-t.rep,-MMEJ.p) %>% distinct(),aes(fct_relevel(gene,MLL.prot.level), value, fill = pathway)) + geom_quasirandom(data = MLL.and.controls.chr %>% select(gene, MMEJ.p,chromatin) %>% distinct, aes(gene, 1 - MMEJ.p), size = 1, color = "grey70") + facet_wrap(~ chromatin, labeller = labeller(chromatin = chrom.labs)) + scale_fill_manual(values = c("#2E358F","#EB2030")) + theme_bw() + coord_cartesian(expand = F) + ylab("Pathway Frequency")+ theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5), axis.title.x = element_blank())
dev.off()

#Control balances
pdf(file = "~/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/export/xv20200909_control_balances.pdf", height = 9, width = 9)
ggplot() + geom_col(data = MLL.and.controls.chr %>% filter(gene %in% c("WT","POLQ"))%>% select(-t.rep,-MMEJ.p) %>% distinct(),aes(fct_relevel(gene,MLL.prot.level), value, fill = pathway)) + geom_quasirandom(data = MLL.and.controls.chr %>% filter(gene %in% c("WT","POLQ"))%>% select(gene, MMEJ.p,chromatin) %>% distinct, aes(gene, 1 - MMEJ.p), size = 1, color = "grey70") + facet_wrap(~ chromatin, labeller = labeller(chromatin = chrom.labs)) + scale_fill_manual(values = c("#2E358F","#EB2030")) + theme_bw() + coord_cartesian(expand = F) + ylab("Pathway Frequency")+ theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5), axis.title.x = element_blank())
dev.off()

#Make z-score plots
MLL1 <- c("KMT2A","ASH2L")
MLL3.4 <- c("KDM6A","PAXIP1","RBBP5")

z.score.dt <- screen.detail %>% filter(chromatin %in% c("late_replicating-LAD-H3K9me2", "euchromatin-transcription")) %>% select(gene,mmej.SCscore, chromatin) %>% distinct()
intercept <- intersect((z.score.dt %>% filter(chromatin == "late_replicating-LAD-H3K9me2" & abs(mmej.SCscore) > 1.65))$gene, (z.score.dt %>% filter(chromatin == "euchromatin-transcription" & abs(mmej.SCscore) > 1.65))$gene)

z.score.plot <- screen.detail %>% filter(chromatin %in% c("late_replicating-LAD-H3K9me2", "euchromatin-transcription")) %>% select(gene,mmej.SCscore, chromatin) %>% distinct() %>% sample()

pdf("~/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/export/xv20201014_MLL_prots.pdf", height = 2.5, useDingbats = F)
ggplot(z.score.plot) + 
  geom_hline(yintercept = c(1.65,-1.65),linetype = "dashed") +
  geom_point(aes(gene,mmej.SCscore, alpha = abs(mmej.SCscore) > 1.65), size = 1) + 
  geom_point(data = . %>% filter(gene %in% intercept), aes(gene,mmej.SCscore, alpha = abs(mmej.SCscore) > 1.65), color = "orange", size = 1) + 
  geom_point(data = . %>% filter(gene %in% MLL1), aes(gene, mmej.SCscore), color = "#EB2030", size = 2) + 
  geom_text_repel(data = . %>% filter(gene %in% c(MLL1,MLL3.4)), aes(gene, mmej.SCscore, label = gene), force = 3) +
  geom_point(data = . %>% filter(gene %in%  MLL3.4), aes(gene, mmej.SCscore), color = "#2E358F", size = 2) + 
  facet_wrap(~ chromatin, labeller = labeller(chromatin = chrom.labs), nrow = 1) + 
  theme_bw() + theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), panel.grid.major.x = element_blank(), legend.position = "none") + 
  ylab("z-score") + xlab("Genes in the library (n = 590)") + coord_fixed(ratio = 30)
dev.off()

#Ne plot KDM6A
KDM6A.z.score.plot <- screen.detail %>% select(gene,mmej.SCscore, chromatin) %>% distinct() %>% sample()

pdf("~/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/export/xv20201127_KDM6A.pdf", height = 5, width = 10, useDingbats = F)
ggplot(KDM6A.z.score.plot) + 
  geom_hline(yintercept = c(1.65,-1.65),linetype = "dashed") +
  geom_point(aes(gene,mmej.SCscore),alpha = 0.1, size = 1) + 
  geom_point(data = . %>% filter(gene %in% intercept), aes(gene,mmej.SCscore, alpha = abs(mmej.SCscore) > 1.65), color = "orange", size = 1) + 
  geom_point(data = . %>% filter(gene == "KDM6A"), aes(gene, mmej.SCscore), color = "red", size = 2) + 
  geom_text_repel(data = . %>% filter(gene == "KDM6A"), aes(gene, mmej.SCscore, label = gene), force = 4) +
  facet_wrap(~ chromatin, labeller = labeller(chromatin = chrom.labs), nrow = 1) + 
  theme_bw() + theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), panel.grid.major.x = element_blank(), legend.position = "none") + 
  ylab("z-score (Repair pathway balance)") + xlab("Genes in the library (n = 590)") + coord_fixed(ratio = 30)
dev.off()
```

```{r}
# Heatmap with top 10 hits
hit.genes <- c("JARID2","ING1","HMNGN4","HMG20B","DPF3","SUPT3H","RSF1","JADE3","JADE2","HMGB3","KMT2A","ASH2L","RBBP5","KDM6A","PAXIP1", "PICK1","KDM3A","HDAC5","HMGA1","PSMA1")
hits.category <- tibble(gene = hit.genes, class = c(rep("Chromatin effects",10),rep("MLL complexes",5), rep("Random genes", 5)))

pdf(file = "~/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/export/xv20201204_heatmap_selected.pdf", useDingbats = F)
ggplot(screen.detail %>% inner_join(hits.category) %>% select(gene, chromatin, mmej.SCscore, class) %>% distinct()) + 
  geom_tile(aes(gene,fct_relevel(chromatin,chromatin.levels), fill = mmej.SCscore)) +
  facet_wrap(~ class, drop = T, scales = "free_x") + 
  scale_fill_gradient2(low = "#EB2030", mid = "grey90",high = "#2E358F", midpoint = 0, limits = c(-5,5)) +
  theme_bw() + theme(aspect.ratio = 0.7, axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1), legend.position = "top") + 
  coord_cartesian(expand = F)


dev.off()
```
Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
