---
title: "Parsing_QC"
author: "Ruben Schep"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output: 
  html_document:
    theme: journal #cerulean
    highlight: monochrome
    toc: true
    toc_float: true
    code_folding: show
  editor_options:
    chunk_output_type: console
---

knitr document van Steensel lab

# Parsing and starcode quality control
# Introduction
After demultiplexing all the samples from the sequencing data, the data has been processed by the CRISPR-TRIP snakemake script. This script maps the barcodes from the iPCR (iPCR from 5 feb 2018). It calls the true barcodes with the starcode script for both the mutation and mapping reads. It call the mutations on all the mutation samples and spits them in mapped, unmapped and non genuine.

Here we want to do a QC of the parsing of the mapping, the barcodes and mutations. We will load the statistics data of all the files. We will also look at barcode counts from the table files (those list the barcodes from the starcode stript). I obtained the counts though shell with 
`cd ~/mydata/projects/CRISPR_TRIP/20180918_TRIP_5106/data/processed_20181107/mutation`
`wc -l * > ~/mydata/projects/CRISPR_TRIP/20180918_TRIP_5106/data/processed_20181107/rs20181107_starcode_barcode_counts.txt`

Pasted the result in a text editor and changes all `^ ` and changed the spaces to `\t`, removed the last total row, removed `.table` at the end and saved as text file. 
I will export a bed file also containing the broad integrations for the generation of mean chip values over the integration sites. 

## Description of Data
The statistics files look like this for the mutations : 
```{r table2, echo=FALSE, message=FALSE, warnings=FALSE, results='asis'}
tabl <- "
|	reads	|	bp	|	reads_written	|	bp_written	|	n_tooshort	|	pat1	|	barcode	|	pat2|
|----|----|----|----|----|----|----|----|
|	1917323	|	268435236	|	1523275	|	146262106	|	0	|	1802163	|	1802150	|	1523275|
"
cat(tabl) # output the table in a format good for HTML/PDF/docx conversion
```

# Data loading and processing  

## Path, Libraries, Parameters and Useful Functions  

```{r system setup, message=FALSE}
StartTime <-Sys.time()

# 6-digit Date tag:
Date <- substr(gsub("-","",Sys.time()),1,8) 

# libraries:
library(plyr)
library(dplyr)
library(GenomicRanges)
library(RColorBrewer)
library(ggplot2)
library(magrittr)
library(data.table)
library(grid)
library(gridExtra)
library(platetools)
library(tidyverse)
```


## Data loading  

These are data from the crispr-trip.snake script, and a text file that has has been obtained as explained above.  

```{r load and process the data}
# First I load the statistics data from the mapping.
setwd("/DATA/projects/DSBrepair/data/xv20210430_CRISPR_follow_up/parsed")
file.list <- list.files(pattern='statistics.txt', full.names = TRUE)
getwd()
indel.statistics.list <- lapply(file.list, 
                                read.table, 
                                header = TRUE)

names(indel.statistics.list)<- gsub('mutation.(.*?).statistics.txt', 
                                    '', 
                                    file.list)
# we need to remove the index column for the time being
indel.statistics.list <- lapply(indel.statistics.list, function(x) { x["index"] <- NULL; x })
indel.statistics.df <- do.call(rbind.data.frame, 
                               indel.statistics.list)
# Extract the information from the sample names
indel.statistics.df.tmp <- indel.statistics.df %>% mutate(sample.well = str_extract(rownames(indel.statistics.df),"(?<=R.).*(?=.stat)")) %>% separate(sample.well, into = c("plate","t.rep","b.rep","well"), remove = F) %>% mutate(sample = paste0(b.rep,"_",t.rep,"_",plate))

#Plot written_reads per well
ggplot(indel.statistics.df.tmp) + geom_quasirandom(aes(b.rep,log10(reads_written))) + facet_grid(t.rep ~ plate)
```


```{r plotting the reads per plate}
getwd()
pdf("~/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/export/xv20210403_follow_up_screen.pdf", width = 12, height = 4)
for (i in unique(indel.statistics.df.tmp$sample)) {
  
  # Select the flowjo data set
  data <- indel.statistics.df.tmp %>% filter(sample== i)
  
  limits <- c(5000,max(data$reads))

  # Plot this, first the PI staining with a custom color-coded density
  y <- density(data$reads)
  plt1 <- ggplot(data.frame(x = y$x, y = y$y),
                 aes(x = x, y = y)) +
    geom_line() +
    geom_segment(aes(xend = x, yend = 0, colour = x)) +
    xlim(limits) + xlab("reads") + ylab("frequency") +
    ggtitle(paste("Read counts -",
                unique(data$sample))) +
    scale_color_distiller(type = "div", limits = limits, name = "PI_area") +
    theme_bw() +
    theme(legend.position="none")
  
  # Then the plate with color-coded wells
  plt2 <- raw_map(data$reads, 
                 data$well) +
    ggtitle(unique(data$sample)) +
    scale_fill_distiller(type = "div", limits = limits, name = "reads")
  grid.arrange(plt1, plt2, ncol = 2, widths = c(1, 1.3))
}
dev.off()
```

# Session Info  
```{r}
sessionInfo()
getwd()
date()
paste("Run time: ",format(Sys.time()-StartTime))

```