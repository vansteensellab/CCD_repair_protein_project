---
title: "xv20211007_5_POLL"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Libraries
```{r libraries}
# libraries:
library(tidyverse)
library(data.table)
library(parallel)
library(gtools)
library(pheatmap)
library(ggbeeswarm)
library(reshape2)
library(gridExtra)
library(broom)
library(ggrepel)
library(gprofiler2)
library(dendextend)
library(Hmisc)
```

# Aesthetic legend for the whole paper
```{r}
# Pathway color palette (MMEJ, wt/no_effect, NHEJ)
pathway.colors <- c("#EB2030","grey90","#2E358F")
# Pathway symbol palette ()
pathway.symbol <- c(19,17)

# Chromatin color palette
#chrom_colors = c( c("euchromatin" = "#F7941D", "other" = "#838687",  "H3K27me3" = "#D21F8A", "triple" = "#662D91"))
chromatin.colors <- c("#D21F8A","#838687","#F7941D","#662D91")
```

# Import data tables

```{r libraries}
#dcast table
#ddr
ddr.screen.dcast <- readRDS("/home/x.vergara/XV_P3_ChromDSBScreen/xv20201204_agm_ddr_screen/data/xv20210609_screen_ddr_dcast.rds")
#chromatin
chr.screen.dcast <- readRDS("/home/x.vergara/XV_P3_ChromDSBScreen/xv20200421_ChromDSBscreen/data/xv20201014_frozen_chz_scores_dcast.rds")
  
#detailed table
#ddr
ddr.screen.detail <- readRDS("/home/x.vergara/XV_P3_ChromDSBScreen/xv20201204_agm_ddr_screen/data/xv20210609_screen_ddr_scores.rds")
colnames(ddr.screen.detail)[9] <- "b.rep"
colnames(ddr.screen.detail)[10] <- "t.rep"
ddr.screen.detail$library <- "DNA_repair"
#chromatin
chr.screen.detail <- readRDS("/home/x.vergara/XV_P3_ChromDSBScreen/xv20200421_ChromDSBscreen/data/xv20201014_frozen_chz_scores_mmej.rds")
chr.screen.detail$library <- "Chromatin"


# I think I don't need these ones for this figure
#Control table (WT & POLQ)
#ddr
ddr.screen.controls <- readRDS("/home/x.vergara/XV_P3_ChromDSBScreen/xv20201204_agm_ddr_screen/data/xv20210609_screen_ddr_controls.rds")
colnames(ddr.screen.controls)[9] <- "b.rep"
colnames(ddr.screen.controls)[10] <- "t.rep"
ddr.screen.controls$library <- "DNA_repair"

#chromatin
chr.screen.controls <- readRDS("/home/x.vergara/XV_P3_ChromDSBScreen/xv20200421_ChromDSBscreen/data/xv20201014_frozen_chz_scores_controls.rds")
chr.screen.controls$library <- "Chromatin"


#indel data
indel.data.ddr <- readRDS(file = "/home/x.vergara/XV_P3_ChromDSBScreen/xv20201204_agm_ddr_screen/data/xv20210526_screen_DDR_indel_data.rds")

# Chromatin follow up data
chromatin.followup <- readRDS("/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/data/xv20211005_chromatin_follow_up.rds")

# Put both screens together
#detailed table with all the variables
both.screen.detail <- bind_rows(ddr.screen.detail, chr.screen.detail) %>% mutate(ID_gene = paste(gene, library, sep = "_")) %>% filter(sample == "KO" & !ID_gene %in% c("DMSO_DNA_repair","LBR_ctrl_DNA_repair"))

# Inhibitor experiment
inhibitor.data <- readRDS("~/XV_P3_ChromDSBScreen/xv20210716_E1627_ATR_inhibitor/data/xv20210716_E1627_indel_script_ATRi.rds") %>% left_join(inhibitor.table)
```


# figure 5A: POLL, POLQ and RAD50

```{r}
# 
stronghits <- both.screen.detail %>% 
  filter(gene %in% c("POLQ","POLL","RAD50")) %>% 
  dplyr::group_by(ID_gene, barcode) %>% 
  dplyr::summarise(IPR.MMEJscore = sum(mmej.z.score, na.rm = T)/sqrt(n()), counts = n())

#plot

ggplot(stronghits) + 
  geom_quasirandom(aes(ID_gene,IPR.MMEJscore)) +
  theme_bw() +
  ylab("MMEJ:NHEJ balance pertubation (z-score)") +
  geom_hline(yintercept = 0, linetype = 2) +
  stat_mean(aes(ID_gene,IPR.MMEJscore), geom = "point", color = "red", size = 2) +
  coord_cartesian(ylim = c(-20,40))
```


# figure 5A: POLL correlates with CRISPR parameters but not chromatin

```{r}
# Correlation with chromatin data
clone5_chrom_tib <- readRDS("/DATA/projects/DSBrepair/data/R/rs20200519_clone5_newdoms_chromatin.RDS")

# Control MMEJ values 
mmej.freq.ctr <- ddr.screen.controls %>% 
  filter(gene == "WT") %>% dplyr::group_by(barcode) %>% 
  dplyr::summarise(MMEJ.freq = mean(MMEJscore, na.rm = T), gene.editing.freq = mean(freqCut,na.rm = T)) %>%
  mutate(z.wt.mmej = scale(MMEJ.freq), z.gene.editing = scale(gene.editing.freq))

# Combination mmej
cor.values <- clone5_chrom_tib %>% select(barcode,H3K4me1,H3K27me3,LMNB1,H3K9me2,POL2,late_replicating) %>% left_join(mmej.freq.ctr %>% select(barcode,z.wt.mmej,z.gene.editing))

# Filter POLL & POLQ (z-scores)
stronghits.screen <- both.screen.detail %>% 
  filter(gene %in% c("POLQ","POLL","RAD50")) %>% 
  dplyr::group_by(ID_gene, barcode) %>% 
  dplyr::summarise(IPR.MMEJscore = sum(mmej.z.score, na.rm = T)/sqrt(n()), counts = n()) %>%
  reshape2::dcast(barcode ~ ID_gene, value.var = "IPR.MMEJscore")

# Fillter follow up experiment
stronghits.followup <- chromatin.followup %>%
  filter(gene %in% c("POLQ","SUPT5H","SAP130") & gRNA == "Combo") %>%
  dplyr::group_by(gene, barcode) %>% 
  dplyr::summarise(IPR.MMEJscore = abs(sum(z.score, na.rm = T)/sqrt(n())), counts = n()) %>%
  reshape2::dcast(barcode ~ gene, value.var = "IPR.MMEJscore")

stronghits <- left_join(stronghits.screen, stronghits.followup)

# Correlation plot where x & y are not similar
correlation.POLL <- cor(left_join(cor.values,stronghits.screen) %>% column_to_rownames(var = "barcode"), method = "pearson")[9:11,1:8] %>% as.data.frame()%>%  rownames_to_column(var = "gene") %>% reshape2::melt(value.name = "coefficient")
p.tmp <- rcorr(as.matrix(left_join(cor.values,stronghits.screen) %>% column_to_rownames(var = "barcode")),type ="pearson")$P[9:11,1:8] %>% as.data.frame() %>% rownames_to_column(var = "gene") %>% reshape2::melt(value.name = "p.val")
POLL.cor.pvalue <- left_join(correlation.POLL,p.tmp)

#Plot correlations
ggplot(POLL.cor.pvalue) + 
  geom_tile(aes(variable,gene, fill = coefficient)) + 
  scale_fill_gradient2(limits = c(-1,1)) + 
  geom_point(data = subset(POLL.cor.pvalue, p.val < 0.05), aes(variable, gene)) + 
  coord_fixed(expand = F) + theme_bw() + theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))

#Plot POLQ and POLL correlations
ggplot(data = POLL_POLQ,aes(IPR.MMEJscore, MMEJ.freq)) + 
  geom_point() + 
  facet_wrap(~ ID_gene, scales = "free", ncol = 4) + 
  theme_bw() + geom_smooth(method = "lm") + 
  stat_cor() + ylab("MMEJscore") + 
  xlab("abs(z-score)")

```

# Re-do for all chromatin marks and all proteins
# figure 5A: POLL correlates with CRISPR parameters but not chromatin

```{r}
# Correlation with chromatin data
clone5_chrom_tib <- readRDS("/DATA/projects/DSBrepair/data/R/rs20200519_clone5_newdoms_chromatin.RDS")

# Control MMEJ values 
mmej.freq.ctr <- ddr.screen.controls %>% 
  filter(gene == "WT") %>% dplyr::group_by(barcode) %>% 
  dplyr::summarise(MMEJ.freq = mean(MMEJscore, na.rm = T), gene.editing.freq = mean(freqCut,na.rm = T)) %>%
  mutate(z.wt.mmej = scale(MMEJ.freq), z.gene.editing = scale(gene.editing.freq))

# Combination mmej
cor.values <- clone5_chrom_tib %>% select(-grep("dom", colnames(clone5_chrom_tib)),- IPR, -euchromatin, -transcription, -chrom_group, -chromatin)

#hits in figure 4
per_chrhits <- both.screen.detail %>% dplyr::group_by(ID_gene, mmej.SCscore) %>% dplyr::summarise(counts = n()) %>% filter(abs(mmej.SCscore) > 2.65) %>% pull(ID_gene) %>% unique()

# Filter POLL & POLQ (z-scores)
all.prots <- both.screen.detail %>%
  filter(ID_gene %in% per_chrhits) %>%
  dplyr::group_by(ID_gene, barcode) %>% 
  dplyr::summarise(IPR.MMEJscore = sum(mmej.z.score, na.rm = T)/sqrt(n()), counts = n()) %>%
  reshape2::dcast(barcode ~ ID_gene, value.var = "IPR.MMEJscore")

#Generate a file with rownames barcode
chrom.barcodes <- left_join(cor.values,all.prots) %>% column_to_rownames(var = "barcode")

# Correlation plot where x & y are not similar
correlation.all <- cor(chrom.barcodes, method = "pearson")[25:137,1:24] %>% as.data.frame()%>%  rownames_to_column(var = "gene") %>% reshape2::melt(value.name = "coefficient")

#Get tree structure to arrange tile
dst.cor.hits <- dist(cor(chrom.barcodes, method = "pearson")[28:139,1:26])
hc_row.cor.hits <- hclust(dst.cor.hits)
row_dend.cor.hits <- as.dendrogram(hc_row.cor.hits)
row_dend.cor.hits <- seriate_dendrogram(row_dend.cor.hits, dst.cor.hits, method="OLO")

#Plot correlations
ggplot(correlation.all) + 
  geom_tile(aes(variable,gene, fill = coefficient)) + 
  scale_fill_gradient2(limits = c(-1,1)) + 
  geom_point(data = subset(correlation.all, abs(coefficient) > 0.6), aes(variable, gene)) + 
  coord_fixed(expand = F) + theme_bw() + theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))

#Plot POLQ and POLL correlations
ggplot(data = POLL_POLQ,aes(IPR.MMEJscore, MMEJ.freq)) + 
  geom_point() + 
  facet_wrap(~ ID_gene, scales = "free", ncol = 4) + 
  theme_bw() + geom_smooth(method = "lm") + 
  stat_cor() + ylab("MMEJscore") + 
  xlab("abs(z-score)")

```

# figure 5B: NHEJ perturbation is compensated with MMEJ increase while MMEJ loss is not

```{r pressure, echo=FALSE}
POLL_POLQ.screen <- both.screen.detail %>% 
  filter(gene %in% c("POLQ","POLL","RAD50","FANCM","FANCG")) %>% 
  select(gene,t.rep,barcode,MMEJscore,freqCut) %>% 
  distinct() %>% 
  mutate(MMEJfreq = MMEJscore*freqCut,
                     NHEJfreq = freqCut - (MMEJscore*freqCut),
                     WT = 1 - freqCut) %>%
  group_by(gene,barcode) %>%
  dplyr::summarise(MMEJ = mean(MMEJfreq, na.rm = T), WT = mean(WT, na.rm = T),NHEJ = mean(NHEJfreq,na.rm = T))

 norm.fetures <- POLL_POLQ.screen %>%
  reshape2::melt(value.name = "frequency") %>%
  left_join((ddr.screen.controls %>% 
              filter(gene == "WT") %>% 
              ungroup() %>% 
              select(barcode, MMEJscore,freqCut) %>%
              distinct() %>% 
              mutate(MMEJfreq = MMEJscore*freqCut,
                     NHEJfreq = freqCut - (MMEJscore*freqCut),
                     WT = 1 - freqCut) %>%
              group_by(barcode) %>% 
              dplyr::summarise(MMEJ = mean(MMEJfreq, na.rm = T), WT = mean(WT, na.rm = T),NHEJ = mean(NHEJfreq,na.rm = T)) %>%
              reshape2::melt(value.name = "WT.frequency"))) %>%
  mutate(diff = frequency - WT.frequency)

ggplot(norm.fetures) + 
  geom_quasirandom(aes(fct_relevel(variable,c("MMEJ","NHEJ","WT")), diff)) + 
  facet_wrap(~gene) + 
  theme_bw() + 
  theme(axis.text.x = (element_text(angle = 90, vjust = 0.5, hjust = 1))) + 
  coord_cartesian() +
  geom_hline(yintercept = 0, linetype = 2) + 
  ylab("Pathway frequency difference") +
  coord_cartesian(ylim = c(-0.3,0.3))

# Statistics
```
# Figure 5C: Kinase inhibitors
```{r}
# Get frequencies for each mutation
processed.inhibitor.data <- inhibitor.data %>% 
                                  mutate(freqMMEJ = pct_del_7,
                                         freqNHEJ = pct_ins_1,
                                         freqWT = pct_wt,
                                         freqOthers = 1 - (pct_del_7 + pct_ins_1 + pct_wt),
                                         MMEJ_other_mut = pct_del_7/(pct_ins_1 + freqOthers+ pct_del_7),
                                         NHEJ_other_mut = pct_ins_1/(pct_ins_1 + freqOthers+ pct_del_7),
                                         MMEJ_score = pct_del_7/(pct_del_7 + pct_ins_1)) %>%
                                select(-grep("pct", colnames(.)), -grep("ins",colnames(.)),-grep("del",colnames(.)), -c("wt","Inf")) %>% distinct()

# Calculate relative frequencies
DMSO.data.inhibitors <- processed.inhibitor.data %>% 
  filter(drug == "DMSO") %>% 
  select(barcode,freqWT, freqNHEJ, freqMMEJ, freqOthers) %>%
  group_by(barcode) %>%
  summarise_all(mean, na.rm = T) %>%
  reshape2::melt(value.name = "DMSO.freq", variable.name = "pathway")
  

# Calculate relative differences
diff.inhibitor.data <- processed.inhibitor.data %>%
  select(-replicate, -exp) %>%
  group_by(barcode,drug) %>%
  summarise_all(mean, na.rm = T) %>%
  reshape2::melt(value.name = "frequency", variable.name = "pathway") %>%
  left_join(DMSO.data.inhibitors) %>%
  mutate(diff = frequency - DMSO.freq)

# 
ggplot(diff.inhibitor.data %>% filter(!drug %in% c("GFP","DMSO"))) + 
  geom_quasirandom(aes(pathway, diff)) + 
  facet_wrap(~fct_relevel(drug, "DNAPKi")) + 
  theme_bw() + theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
    geom_hline(yintercept = 0, linetype = 2)

test.pathway.diff <- diff.inhibitor.data %>%
  filter(!drug %in% c("GFP","DMSO") & complete.cases(.)) %>%
  select(pathway, drug,frequency,DMSO.freq) %>%
  group_by(pathway,drug) %>%
  t_test(frequency ~ DMSO.freq) %>%
  adjust_pvalue() %>%
  mutate(y.position = 35)
```


```{r}
# Plot MMEJ to other mutations
MMEJvsothers <- processed.inhibitor.data %>%
  filter(drug %in% c("DNAPKi","DMSO")) %>%
  select(barcode,drug,replicate,MMEJ_other_mut) %>% 
  left_join(clone5_chrom_tib) %>%
  group_by(barcode,drug,chromatin) %>% 
  dplyr::summarise(mMMEJ_bal = mean(MMEJ_other_mut))

# Plot (I will plot it as stacked bar plot with NHEJ, MMEJ and others)
ggplot(MMEJvsothers) + geom_quasirandom(aes(chromatin,mMMEJ_bal)) + facet_wrap(~drug) + coord_cartesian(ylim = c(0,1))

#DMSO ANOVA test
DMSO.test <- aov(mMMEJ_bal ~ chromatin,data = MMEJvsothers %>% filter(drug == "DMSO")) %>% tidy()

#DNAPK inhibitor ANOVA test
DNAPKi.test <- aov(mMMEJ_bal ~ chromatin,data = MMEJvsothers %>% filter(drug == "DNAPKi")) %>% tidy()

# Plot NHEJ to other mutations
NHEJvsothers <- processed.inhibitor.data %>%
  filter(!drug %in% c("DNAPKi","GFP")) %>%
  select(barcode,drug,replicate,NHEJ_other_mut) %>% 
  left_join(clone5_chrom_tib) %>%
  group_by(barcode,drug,chromatin) %>% 
  dplyr::summarise(mNHEJ_bal = mean(NHEJ_other_mut))

# Plot (I will plot it as stacked bar plot with NHEJ, MMEJ and others)
ggplot(NHEJvsothers) + geom_quasirandom(aes(chromatin,mNHEJ_bal)) + facet_wrap(~drug) + coord_cartesian(ylim = c(0,1))

#DMSO ANOVA test
DMSO.NHEJ.test <- aov(mNHEJ_bal ~ chromatin,data = NHEJvsothers %>% filter(drug == "DMSO")) %>% tidy()
#DNAPK inhibitor ANOVA test
ATMi.NHEJ.test <- aov(mNHEJ_bal ~ chromatin,data = NHEJvsothers %>% filter(drug == "ATMi")) %>% tidy()
#VE821 inhibitor ANOVA test
VE821.NHEJ.test <- aov(mNHEJ_bal ~ chromatin,data = NHEJvsothers %>% filter(drug == "ATRi_VE821")) %>% tidy()
#VE822 inhibitor ANOVA test
VE822.NHEJ.test <- aov(mNHEJ_bal ~ chromatin,data = NHEJvsothers %>% filter(drug == "ATRi_VE822")) %>% tidy()
#VE822 inhibitor ANOVA test
PARPi.NHEJ.test <- aov(mNHEJ_bal ~ chromatin,data = NHEJvsothers %>% filter(drug == "PARPi")) %>% tidy()
```

# DNAPKi vs ATMi pathway balance
```{r}
# Mutation balance
stacked.inhibitor <- processed.inhibitor.data %>%
  left_join(clone5_chrom_tib) %>%
  filter(drug != "GFP") %>%
  select(chromatin,drug,MMEJ = freqMMEJ, NHEJ = freqNHEJ, others = freqOthers) %>%
  group_by(chromatin,drug) %>%
  summarise_all(mean, na.rm = T) %>%
  reshape2::melt(value.name = "frequency", variable.name = "pathway")

# Plot stacked bars MMEJ (Main figure)
ggplot(stacked.inhibitor %>% filter(drug %in% c("DMSO","DNAPKi"))) + 
  geom_col(aes(fct_relevel(chromatin, by = c("euchromatin-transcription","transcription","other-euchromatin","H3K27me3","other-heterochromatin","late_replicating-LAD-H3K9me2")), frequency, fill = fct_relevel(pathway, c("others","NHEJ","MMEJ"))), position = "fill") + 
  facet_wrap(~ fct_relevel(drug,"DMSO")) + 
  coord_cartesian(expand = F) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
  labs(fill = "Pathway") +
  scale_fill_manual(values = c("grey60","#EB2030","#2E358F"))
  
  # Plot stacked bars NHEJ (Supplementary)
ggplot(stacked.inhibitor %>% filter(drug != "DNAPKi")) + 
  geom_col(aes(fct_relevel(chromatin, by = c("euchromatin-transcription","transcription","other-euchromatin","H3K27me3","other-heterochromatin","late_replicating-LAD-H3K9me2")), frequency, fill = fct_relevel(pathway, c("others","MMEJ","NHEJ"))), position = "fill") + 
  facet_wrap(~ fct_relevel(drug,"DMSO")) + 
  coord_cartesian(expand = F) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
  labs(fill = "Pathway") +
  scale_fill_manual(values = c("grey60","#2E358F","#EB2030"))
```
# Figure 5: Correlation POLL activity
```{r}
# mmej values
mmej.freq.ctr <- ddr.screen.controls %>% filter(gene == "WT") %>% dplyr::group_by(barcode) %>% dplyr::summarise(MMEJ.freq = mean(MMEJscore, na.rm = T), gene.editing.freq = mean(freqCut,na.rm = T))

# POLL & POLQ controls
correlation.plots <- POLL_POLQ %>% filter(ID_gene %in% c("POLL_DNA_repair","POLQ_DNA_repair")) %>% select(-MMEJ.freq) %>% left_join(mmej.freq.ctr, by = c("barcode"))

#corr values
ggplot(correlation.plots,aes(IPR.MMEJscore,gene.editing.freq)) + 
  geom_point() + 
  geom_smooth(method = "lm") +
  stat_cor(label.y = 0.9) +
  facet_wrap(~ ID_gene, scales = "free") +
  theme_bw()  +
  ylab("Gene editing frequency") +
  xlab("KO perturbation (z-score)") +
  coord_cartesian(ylim = c(0,1))

ggplot(correlation.plots,aes(IPR.MMEJscore,MMEJ.freq)) + 
  geom_point() + 
  geom_smooth(method = "lm") +
  stat_cor(label.y = 0.475) +
  facet_wrap(~ ID_gene, scales = "free") +
  theme_bw() +
  ylab("MMEJ::NHEJ pathway balance") +
  xlab("KO perturbation (z-score)") +
  coord_cartesian(ylim = c(0.1,0.5))
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
