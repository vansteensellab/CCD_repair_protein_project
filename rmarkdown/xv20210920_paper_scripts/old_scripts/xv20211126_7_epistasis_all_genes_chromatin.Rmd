---
title: "xv20211121_epistasis_model_bas"
output: html_document
---

In this document, I will go over different calculations of epistasis.4 different workflows:
First decision is whether to use log2 MMEJscore or MMEJscore
Second decision is comparing slopes or statistic differences between WT vs. KO slopes

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Libraries
```{r libraries}
# libraries:
library(tidyverse)
library(data.table)
library(parallel)
library(gtools)
library(pheatmap)
library(ggbeeswarm)
library(reshape2)
library(gridExtra)
library(broom)
library(ggrepel)
library(dendextend)
library(Hmisc)
library(ggpubr)
```

# Aesthetic legend for the whole paper
```{r}
# Pathway color palette (MMEJ, wt/no_effect, NHEJ)
pathway.colors <- c("#EB2030","grey90","#2E358F")
# Pathway symbol palette ()
pathway.symbol <- c(19,17)

# Chromatin color palette
#chrom_colors = c( c("euchromatin" = "#F7941D", "other" = "#838687",  "H3K27me3" = "#D21F8A", "triple" = "#662D91"))
chromatin.colors <- c("#D21F8A","#838687","#F7941D","#662D91")
```

# Import data tables

```{r, include= FALSE}
#dcast table
#ddr
ddr.screen.dcast <- readRDS("/home/x.vergara/XV_P3_ChromDSBScreen/xv20201204_agm_ddr_screen/data/xv20210609_screen_ddr_dcast.rds")
#chromatin
chr.screen.dcast <- readRDS("/home/x.vergara/XV_P3_ChromDSBScreen/xv20200421_ChromDSBscreen/data/xv20201014_frozen_chz_scores_dcast.rds")
  
#detailed table
#ddr
ddr.screen.detail <- readRDS("/home/x.vergara/XV_P3_ChromDSBScreen/xv20201204_agm_ddr_screen/data/xv20210609_screen_ddr_scores.rds")
colnames(ddr.screen.detail)[9] <- "b.rep"
colnames(ddr.screen.detail)[10] <- "t.rep"
ddr.screen.detail$library <- "DNA_repair"
#chromatin
chr.screen.detail <- readRDS("/home/x.vergara/XV_P3_ChromDSBScreen/xv20200421_ChromDSBscreen/data/xv20201014_frozen_chz_scores_mmej.rds")
chr.screen.detail$library <- "Chromatin"


# I think I don't need these ones for this figure
#Control table (WT & POLQ)
#ddr
ddr.screen.controls <- readRDS("/home/x.vergara/XV_P3_ChromDSBScreen/xv20201204_agm_ddr_screen/data/xv20210609_screen_ddr_controls.rds")
colnames(ddr.screen.controls)[9] <- "b.rep"
colnames(ddr.screen.controls)[10] <- "t.rep"
ddr.screen.controls$library <- "DNA_repair"

#chromatin
chr.screen.controls <- readRDS("/home/x.vergara/XV_P3_ChromDSBScreen/xv20200421_ChromDSBscreen/data/xv20201014_frozen_chz_scores_controls.rds")
chr.screen.controls$library <- "Chromatin"

#indel data
indel.data.ddr <- readRDS(file = "/home/x.vergara/XV_P3_ChromDSBScreen/xv20201204_agm_ddr_screen/data/xv20210526_screen_DDR_indel_data.rds")

# Chromatin follow up data
chromatin.followup <- readRDS("/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/data/xv20211005_chromatin_follow_up.rds")

#Chromatin data
clone5_chrom_tib <- readRDS("/DATA/projects/DSBrepair/data/R/rs20200519_clone5_newdoms_chromatin.RDS")
clone5_z.score_chrom_tib <- readRDS('/DATA/projects/DSBrepair/data/R/cl20201026_ChIP_zscore_selection.RDS')

# Inhibitor experiment
inhibitor.data <- readRDS("~/XV_P3_ChromDSBScreen/xv20210716_E1627_ATR_inhibitor/data/xv20210716_E1627_indel_script_ATRi.rds") %>% left_join(inhibitor.table)

```

# Put both screens together
```{r}
#detailed table with all the variables
both.screen.detail <- bind_rows(ddr.screen.detail, chr.screen.detail) %>% mutate(ID_gene = paste(gene, library, sep = "_")) %>% filter(sample == "KO" & !ID_gene %in% c("DMSO_DNA_repair","LBR_ctrl_DNA_repair"))

both.screen.controls <- bind_rows(ddr.screen.controls, chr.screen.controls)

# Get heatmap by chromatin type (4 types, but maybe it's better to make 4 "same as RS paper")
clasification.4.chroms <- clone5_chrom_tib %>% select(chromatin,barcode) %>% dplyr::mutate(chrom.4 = case_when(chromatin %in% c("euchromatin-transcription","other-euchromatin","transcription") ~ "euchromatin", T ~ chromatin)) %>% select(-chromatin)

#Number of IPRs per chromatin
summary.4chroms <- clasification.4.chroms %>% dplyr::group_by(chrom.4) %>% dplyr::summarise(counts = n())

# Compute score per 4 chromatin types
both.screen.detail.4chrom <- both.screen.detail %>% 
  left_join(clasification.4.chroms, by = "barcode") %>% 
  select(barcode,chrom.4, mmej.z.score,t.rep,ID_gene)

score.per.4chrom.rep <- both.screen.detail.4chrom %>%
  dplyr::group_by(chrom.4,t.rep,ID_gene) %>%
  dplyr::summarise(chrom4score = mean(mmej.z.score, na.rm = T))

score.per.4chrom <- score.per.4chrom.rep %>%
  dplyr::group_by(chrom.4,ID_gene) %>%
  dplyr::summarise(screen.score = sum(chrom4score, na.rm = T)/sqrt(n()))

combined.data.screen <- left_join(score.per.4chrom,score.per.4chrom.rep)
```

#Example with three genes (POLL, FANCM, POLQ) & I will use "H3K4me1" as example
1st step = Compare POLL, FANCM, POLQ and WT data points vs. H3K4me1 (in lin or log space)

step 1 = plot 

```{r}
# Data table and compute log2MMEJ
log2.MMEJ.screen.detail.all <- both.screen.detail %>% select(t.rep, MMEJscore,library, gene,barcode) %>% mutate(log2MMEJ = log2(MMEJscore)) %>% filter(!(gene == "KAT5" & library == "DNA_repair"))

# WT data table set
wt.set <- filter(both.screen.controls, gene == "WT") %>% select(t.rep, MMEJscore,library, gene,barcode) %>% mutate(log2MMEJ = log2(MMEJscore)) %>% dplyr::group_by(barcode, t.rep,library) %>% dplyr::summarise(wt.log2MMEJ = mean(log2MMEJ, na.rm = T), wt.MMEJ = mean(MMEJscore, na.rm = T))

# Plot differences
data.for.plotting.all <- wt.set %>% mutate(gene = "WT") %>% select(t.rep, MMEJscore = wt.MMEJ, library, gene, barcode,log2MMEJ = wt.log2MMEJ) %>% bind_rows(log2.MMEJ.screen.detail.all) %>% mutate(rep_lib = paste(t.rep,library, sep = "_")) %>% dplyr::group_by(gene,barcode) %>% dplyr::summarise(m.log2MMEJ = mean(log2MMEJ, na.rm = T), m.MMEJ = mean(MMEJscore,na.rm = T)) %>% left_join(clone5_z.score_chrom_tib, by = c("barcode" = "ID"))

# Plot in log2 space
ggplot(data.for.plotting.all %>% filter(gene %in% c("POLL","POLQ","FANCM","WT")), aes(H3K4me1,m.log2MMEJ, color = gene)) +
  geom_point() +
  geom_smooth(method = "lm") +
  stat_cor(method = "spearman") +
  theme_bw()

# Plot in log2 space
ggplot(data.for.plotting.all %>% filter(gene %in% c("POLL","POLQ","FANCM","WT")), aes(H3K4me1,m.MMEJ, color = gene)) +
  geom_point() +
  geom_smooth(method = "lm") +
  stat_cor(method = "spearman") +
  theme_bw()

# Plot in log2 space
ggplot(data.for.plotting.all %>% filter(gene %in% c("KAT5","WT")), aes(H3K9me3,m.MMEJ, color = gene)) +
  geom_point() +
  geom_smooth(method = "lm") +
  stat_cor() +
  theme_bw()
```


# 2nd step check compute distances and plot them
```{r}
# Each replicate has a different value (compute differences by replicate)
log2.distance.mmej.all <- log2.MMEJ.screen.detail.all %>% left_join(wt.set) %>% mutate(log2.dist = sqrt((log2MMEJ - wt.log2MMEJ)^2), lin.dist = sqrt((MMEJscore - wt.MMEJ)^2)) 
mean.log2.distance.mmej.all <- log2.distance.mmej.all %>% dplyr::group_by(barcode,gene) %>% dplyr::summarise(m.log2.dist = mean(log2.dist, na.rm = T), m.lin.dist = mean(lin.dist, na.rm = T)) %>% left_join(clone5_z.score_chrom_tib, by = c("barcode" = "ID"))

#Plot slopes
ggplot(mean.log2.distance.mmej.all %>% 
         filter(gene %in% c("POLL","POLQ","FANCM")),
       aes(H3K4me1,m.log2.dist, color = gene)) + 
  geom_point() + 
  stat_cor(method = "spearman") + 
  geom_smooth(method = "lm") + 
  theme_bw()

ggplot(mean.log2.distance.mmej.all %>% 
         filter(gene %in% c("KAT5")),
       aes(H3K9me2,m.log2.dist, color = gene)) + 
  geom_point() + 
  stat_cor(method = "spearman") + 
  geom_smooth(method = "lm") + 
  theme_bw()

ggplot(mean.log2.distance.mmej.all %>% 
         filter(gene %in% c("KAT5")),
       aes(H3K9me2,m.log2.dist, color = gene)) + 
  geom_point() + 
  stat_cor() + 
  geom_smooth(method = "lm") + 
  theme_bw()


```
# Extract slopes for all genes
```{r}
# Perform analysis across all features for three test genes
chromatin.features <- colnames(mean.log2.distance.mmej.all)[7:31]

slope.protein.features.all <- tibble(gene = NA, feature = NA, slope.log2 = NA, term = NA)

for (i in unique(mean.log2.distance.mmej.all$gene)) {
  for (j in colnames(mean.log2.distance.mmej.all)[7:31]) {
    model.dt <- mean.log2.distance.mmej.all %>% filter(gene == i)
    model.epistasis.log2 <- lm(formula = m.log2.dist ~ unlist(model.dt[j]), data = model.dt) %>% tidy()
    slope.protein.features.all <- slope.protein.features.all %>% add_row(gene = i, feature = j, slope.log2 = model.epistasis.log2 %>% pull(estimate), term = model.epistasis.log2 %>% pull(term))
  }
}

# Plot matrix without scaling
# log2 space
ggplot(slope.protein.features.all %>% filter(term != "(Intercept)" & complete.cases(.))) + geom_tile(aes(gene,feature, fill = slope.log2)) + scale_fill_gradient2() + theme_bw() +theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust =0.5))

# Perform some scaling to plot this 
slope.protein.features.mean.sd <- slope.protein.features %>% filter(term == "unlist(model.dt[j])") %>% dplyr::group_by(feature) %>% dplyr::summarise(mn.log2 = mean(slope.log2, na.rm = T), sd.log2 = sd(slope.log2,na.rm = T), mn.lin = mean(slope.lin, na.rm = T), sd.lin = sd(slope.lin,na.rm = T))

slope.prot.features.scale <- slope.protein.features  %>% filter(term == "unlist(model.dt[j])") %>% left_join(slope.protein.features.mean.sd) %>% mutate(scaled.slope.log2 = (slope.log2 - mn.log2)/sd.log2, scales.slope.lin = (slope.lin - mn.lin)/sd.lin) %>% na.omit()

slope.prot.features.dcast.all <- slope.protein.features.all %>% filter(term != "(Intercept)") %>% reshape2::dcast(gene ~ feature, value.var = "slope.log2") %>% column_to_rownames(var = "gene")

```


#KAT5 example
```{r}
#Step 1: IPR WT vs. KAT5
ggplot(data.for.plotting.all %>% filter(gene %in% c("WT","KAT5"))) + geom_point(aes(fct_reorder(barcode,m.log2MMEJ), m.log2MMEJ, color = gene)) + scale_color_manual(values = c("#EF6817","#21201F")) + theme_bw() +  ylab("log2(MMEJ:NHEJ balance)") + theme(axis.text.x = element_blank(), legend.position = "top")

#Step2: Distance vs H3K9me2
ggplot(mean.log2.distance.mmej.all %>% 
         filter(gene %in% c("KAT5")),
       aes(H3K9me2,m.log2.dist, color = gene)) + 
  geom_point() +
  geom_smooth(method = "lm") +
  scale_color_manual(values = "#EF6817") +
  theme_bw() + ylab("Distance WT vs. KO")

# Gent intercept and slope
slope.protein.features.all %>% filter(gene == "KAT5" & feature == "H3K9me2")

#Plot KAT5 interactions
ggplot(slope.protein.features.all %>% filter(term != "(Intercept)",gene == "KAT5")) +
  geom_col(aes(fct_relevel(feature,heatmap.chromatin.order.slope.diff.hits),slope.log2, fill = gene)) + geom_vline(aes(xintercept = 0)) + theme_bw() + coord_flip() + scale_fill_manual(values = "#EF6817")

```

# Plot matrix as a tile but clustered
```{r}
#Heatmap for slope differences
slope.proteins.all <- slope.protein.features.all  %>% filter(term != "(Intercept)" & complete.cases(.))

slope.prot.features.dcast.all <- slope.proteins.all %>% reshape2::dcast(gene ~ feature, value.var = "slope.log2") %>% column_to_rownames(var = "gene")

heatmap.slope.diff.all <- pheatmap(slope.prot.features.dcast.all, cell_height = 8, cellwidth = 8)
heatmap.gene.order.slope.diff.all <- rownames(slope.prot.features.dcast.all[heatmap.slope.diff.all$tree_row[["order"]],])
heatmap.chromatin.order.slope.diff.all <- colnames(slope.prot.features.dcast.all[,heatmap.slope.diff.all$tree_col[["order"]]])

#cluster chromatin features all together

#Gene order by correlation
cor.genes.epistasis <- cor(t(slope.prot.features.dcast.all))
heatmap.genes.epistasis <- pheatmap(cor.genes.epistasis)
heatmap.genes.epistasis <- rownames(cor.genes.epistasis[heatmap.genes.epistasis$tree_row[["order"]],])

#Plot heatmap with epistatic interactions (as a geom_tile)
ggplot(slope.proteins.all) + 
  geom_tile(aes(fct_relevel(gene,heatmap.genes.epistasis),fct_relevel(feature, heatmap.features.epistasis), fill = slope.log2)) +
  scale_fill_gradient2( low = "#01665e" ,mid = "#f5f5f5", high = "#8c510a")  + theme_bw() + theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), axis.title = element_blank()) + coord_fixed(expand = F,ratio = 20)

# Make correlation plots
melt.cor.genes.epistasis <- melt(cor.genes.epistasis)
ggplot(melt.cor.genes.epistasis) + 
geom_tile(aes(fct_relevel(Var1, heatmap.genes.epistasis), fct_relevel(Var2,heatmap.genes.epistasis), fill = value)) +
  scale_fill_gradient2( low = "#009B9E" ,mid = "#F1F1F1", high = "#C75DAB", limits = c(-1,1), na.value = "#2E358F")  + 
  coord_fixed(expand = F) + theme_bw() + theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5), axis.title = element_blank())
```

# General plots
```{r}
slope.library <- slope.proteins.all %>% left_join(both.screen.gene.value %>% separate(ID_gene, into = "gene", remove = T)) %>% filter(library %in% c("Chromatin","DNA_repair"))

# Plot per library(all)
ggplot(slope.library) + geom_quasirandom(aes(library,abs(slope.log2), color = library)) + theme_bw() + scale_color_manual(values = library.colors) + theme(legend.position = "top")

#Only hits
ggplot(slope.library %>% filter(pathway != "NA")) + geom_quasirandom(aes(library,abs(slope.log2), color = library)) + theme_bw() + scale_color_manual(values = library.colors) + theme(legend.position = "top")

# Wilkoxon test 
wilc.test.all <- wilcox.test(abs(slope.log2) ~ library, data = slope.library, alternative = "two.sided")
wilc.test.hits <- wilcox.test(abs(slope.log2) ~ library, data = slope.library %>% filter(pathway != "NA"), alternative = "two.sided")

# Plot per library 
ggplot(slope.library %>% filter(pathway != "NA")) + geom_quasirandom(aes(pathway, abs(slope.log2), color = pathway)) + theme_bw() + scale_color_manual(values = c("#EB2030","#2E358F")) + theme(legend.position = "top")

# Wilkoxon test 
wilc.test <- wilcox.test(abs(slope.log2) ~ pathway, data = slope.library %>% filter(pathway != "NA"))


#
effect.size <- slope.protein.features.all %>% filter(complete.cases(.)) %>% dcast(gene + feature ~ term, value.var = "slope.log2") %>% select(gene, feature, intercept= '(Intercept)', slope = "unlist(model.dt[j])")

# Plot slope vs effect size
summ.slope.library <- effect.size %>% dplyr::group_by(gene) %>% dplyr::summarise(med.slope = mean(abs(slope), na.rm = T), mean.intercept = mean(intercept))
ggplot(summ.slope.library, aes(med.slope, mean.intercept)) + geom_point() + stat_cor(method = "spearman")

#Plot this for POLL, POLQ and RAD50
# Plot per library 
POLQ.POLL.RAD50 <- slope.library %>% filter(gene %in% c("POLL","POLQ","RAD50")) %>% select(gene,slope.log2, library) %>% distinct()

ggplot(POLQ.POLL.RAD50, aes(gene,abs(slope.log2))) + geom_quasirandom() + theme_bw() + scale_color_manual(values = library.colors)

wilc.test.POLL.POLQ <- wilcox.test(abs(slope.log2) ~ gene, data = POLQ.POLL.RAD50 %>% filter(gene %in% c("POLL","POLQ")))
wilc.test.RAD50.POLQ <- wilcox.test(abs(slope.log2) ~ gene, data = POLQ.POLL.RAD50 %>% filter(gene %in% c("RAD50","POLQ")))
```

#plot geom_tile
```{r}
#genes to select
hit.genes <- filter(slope.library, pathway != "NA") %>% pull(gene) %>% unique()

# dcaast with selected
slope.prot.features.dcast.hits <- slope.proteins.all %>% filter(gene %in% hit.genes) %>% reshape2::dcast(gene ~ feature, value.var = "slope.log2") %>% column_to_rownames(var = "gene")

heatmap.slope.diff.hits <- pheatmap(slope.prot.features.dcast.hits, cell_height = 8, cellwidth = 8)
heatmap.gene.order.slope.diff.hits <- rownames(slope.prot.features.dcast.hits[heatmap.slope.diff.hits$tree_row[["order"]],])
heatmap.chromatin.order.slope.diff.hits <- colnames(slope.prot.features.dcast.hits[,heatmap.slope.diff.hits$tree_col[["order"]]])

# heatmap
ggplot(slope.proteins.all %>% filter(gene %in% hit.genes)) + 
  geom_tile(aes(fct_relevel(gene,heatmap.gene.order.slope.diff.hits),fct_relevel(feature, heatmap.chromatin.order.slope.diff.hits), fill = slope.log2)) +
  scale_fill_gradient2( low = "#8c510a",mid = "#f5f5f5", high = "#01665e")  + theme_bw() + theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5), axis.title = element_blank(), legend.position = "top") + coord_fixed(expand = F,ratio = 1)

# Dendrogram
ggdendrogram(heatmap.slope.diff.hits$tree_row)
```

# Plot correlations: Are they conserved aren't they?
```{r}

#Feature order by correlation
cor.features.epistasis <- cor(slope.prot.features.dcast.all, method = "spearman")
heatmap.features.epistasis <- pheatmap(cor.features.epistasis)
heatmap.features.epistasis.rows <- rownames(cor.features.epistasis[heatmap.features.epistasis$tree_row[["order"]],])

# Calculate p-values
#rcorr.features.z.score <- rcorr(as.matrix(clone5_z.score_chrom_tib %>% filter(barcode %in% clone5bcs) %>% select(-ID, -barcode,-binsize, -pool,-binsize)), type = "spearman")
#p.value.adj <- as.data.frame(rcorr.features.z.score$P) %>% rownames_to_column(var = "feature_1") %>% reshape2::melt() %>% filter(complete.cases(.)) %>% mutate(p.adj = p.adjust(value, method = "BH"))

# corr.features.z.score


corr.features.z.score <- cor(clone5_z.score_chrom_tib %>% filter(ID %in%  unique(both.screen.detail$barcode)) %>% select(-ID,-binsize, -pool,-binsize), method = "spearman") %>% as.data.frame()%>% rownames_to_column(var = "feature_1") %>% reshape2::melt() %>% filter(complete.cases(.)) %>%select(feature_1, feature_2 = variable, cor_chrom = value)
melt.cor.features.epistasis <- melt(cor.features.epistasis) %>% select(feature_1 = Var1, feature_2 = Var2, cor_ep = value)


# get a value column with values that are Both, only in one or the other
corr_names <- corr.features.z.score  %>% left_join(melt.cor.features.epistasis ) %>% mutate(classes = case_when((abs(cor_chrom) > 0.6 & abs(cor_ep) < 0.6) ~ "Chrom", (abs(cor_chrom) < 0.6 & abs(cor_ep) > 0.6) ~ "Epistasis", (abs(cor_chrom) >0.6 & abs(cor_ep) >0.6) ~ "Both", T ~ "NA")) %>% mutate(diff = cor_ep - cor_chrom)


ggplot(corr_names) + 
geom_tile(aes(fct_relevel(feature_1, heatmap.features.epistasis), fct_relevel(feature_2,heatmap.features.epistasis), fill = diff)) +
  scale_fill_gradient2( low = "#009B9E" ,mid = "#F1F1F1", high = "#C75DAB", na.value = "#2E358F")  + 
  coord_fixed(expand = F) + theme_bw() + theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5), axis.title = element_blank()) + 
  geom_point(data = subset(corr_names, classes != "NA"), aes(fct_relevel(feature_1, heatmap.features.epistasis), fct_relevel(feature_2,heatmap.features.epistasis), shape = classes)) + scale_shape_manual(values = c(4,17,16))



# Make correlation plots for features

ggplot(melt.cor.features.epistasis) + 
geom_tile(aes(fct_relevel(feature_1, heatmap.features.epistasis.rows), fct_relevel(feature_2,heatmap.features.epistasis.rows), fill = cor_ep)) +
  scale_fill_gradient2( low = "#009B9E" ,mid = "#F1F1F1", high = "#C75DAB", limits = c(-1,1), na.value = "#2E358F")  + 
  coord_fixed(expand = F) + theme_bw() + theme(axis.text.x = element_text(angle = 90, hjust = 0, vjust = 0.5), axis.title = element_blank()) + 
  geom_point(data = subset(corr_names, classes != "NA"), aes(fct_relevel(feature_1, heatmap.features.epistasis.rows), fct_relevel(feature_2,heatmap.features.epistasis.rows), shape = classes)) + scale_shape_manual(values = c(4,17,16)) + scale_x_discrete(position = "top")

ggdendrogram(heatmap.features.epistasis$tree_row, rotate = T)

#Correlations with chromatin values themselves
ggplot(corr.features.z.score) + geom_tile(aes(fct_relevel(feature_1,heatmap.features.epistasis), fct_relevel(feature_2, heatmap.features.epistasis), fill = cor_chrom)) + scale_fill_gradient2() +
  geom_point(data = subset(corr_names, classes != "NA"), aes(fct_relevel(feature_1, heatmap.features.epistasis), fct_relevel(feature_2,heatmap.features.epistasis), shape = classes)) + scale_shape_manual(values = c(4,17,16)) + 
  coord_fixed(expand = F) + theme_bw() + theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5), axis.title = element_blank())

```
# Correlate similar features (select couple of correlations)
```{r}
# H3K27me3 and EZH2
ggplot(slope.prot.features.dcast.all, aes(LMNB1,POL2AS2)) + geom_point(size = 0.5) + stat_cor(method = "spearman", cor.coef.name = "rho") + geom_smooth(method = "lm") + theme_bw()  + coord_fixed(ratio = 1)

# CTCF and SMC3
ggplot(slope.prot.features.dcast.all, aes(CTCF,SMC3)) + geom_point(size = 0.5) + stat_cor(method = "spearman", cor.coef.name = "rho") + geom_smooth(method = "lm") + theme_bw() + coord_fixed(ratio = 1)

# LMNB1 and late_replication
ggplot(slope.prot.features.dcast.all, aes(LMNB1,late_replicating)) + geom_point(size = 0.5) + stat_cor(method = "spearman", cor.coef.name = "rho") + geom_smooth(method = "lm") + theme_bw()  + coord_fixed(ratio = 1)

# TTseq and H3K4me1
ggplot(slope.prot.features.dcast.all, aes(TTseq, H3K4me1)) + geom_point(size = 0.5) + stat_cor(method = "spearman", cor.coef.name = "rho") + geom_smooth(method = "lm") + theme_bw()

```

# Extract top 100 & 150 genes with higher range
```{r}
# Summarise and extract range
summ.slope <- slope.proteins.all %>% dplyr::group_by(gene) %>% dplyr::summarise(min.val = min(slope.log2), max.val = max(slope.log2), range = max.val - min.val) %>% arrange(desc(range))

#Select top 100 
top.100.genes.slope <- summ.slope %>% top_n(100, range) %>% pull(gene)

#Gene order by correlation
slope.prots.dcast.top100 <- slope.proteins.all %>% filter(gene %in% top.100.genes.slope) %>% reshape2::dcast(gene ~ feature, value.var = "slope.log2") %>% column_to_rownames(var = "gene")
cor.genes.epistasis.top100 <- cor(t(slope.prots.dcast.top100))
heatmap.genes.epistasis.top100 <- pheatmap(cor.genes.epistasis.top100)
heatmap.genes.epistasis.top100 <- rownames(cor.genes.epistasis.top100[heatmap.genes.epistasis.top100$tree_row[["order"]],])
cor.features.epistasis.top100 <- cor(slope.prots.dcast.top100)
heatmap.features.epistasis.top100 <- pheatmap(cor.features.epistasis.top100)
heatmap.features.epistasis.top100 <- rownames(cor.features.epistasis.top100[heatmap.features.epistasis.top100$tree_row[["order"]],])

#Plot heatmap with epistatic interactions (as a geom_tile)
ggplot(slope.proteins.all %>% filter(gene %in% top.100.genes.slope)) + 
  geom_tile(aes(fct_relevel(gene,heatmap.genes.epistasis.top100),fct_relevel(feature, heatmap.features.epistasis.top100), fill = slope.log2)) +
  scale_fill_gradient2( low = "#01665e" ,mid = "#f5f5f5", high = "#8c510a")  + theme_bw() + theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5), axis.ticks.x = element_blank(), axis.title = element_blank()) + coord_fixed(expand = F,ratio = 1)

#Select top 150 
top.150.genes.slope <- summ.slope %>% top_n(150, range) %>% pull(gene)

#Gene order by correlation
slope.prots.dcast.top150 <- slope.proteins.all %>% filter(gene %in% top.150.genes.slope) %>% reshape2::dcast(gene ~ feature, value.var = "slope.log2") %>% column_to_rownames(var = "gene")
cor.genes.epistasis.top150 <- cor(t(slope.prots.dcast.top100))
heatmap.genes.epistasis.top150 <- pheatmap(cor.genes.epistasis.top150)
heatmap.genes.epistasis.top150 <- rownames(cor.genes.epistasis.top150[heatmap.genes.epistasis.top150$tree_row[["order"]],])
cor.features.epistasis.top150 <- cor(slope.prots.dcast.top150)
heatmap.features.epistasis.top150 <- pheatmap(cor.features.epistasis.top150)
heatmap.features.epistasis.top150 <- rownames(cor.features.epistasis.top150[heatmap.features.epistasis.top150$tree_row[["order"]],])

#Plot heatmap with epistatic interactions (as a geom_tile)
ggplot(slope.proteins.all %>% filter(gene %in% top.150.genes.slope)) + 
  geom_tile(aes(fct_relevel(gene,heatmap.genes.epistasis.top150),fct_relevel(feature, heatmap.features.epistasis.top150), fill = slope.log2)) +
  scale_fill_gradient2( low = "#01665e" ,mid = "#f5f5f5", high = "#8c510a")  + theme_bw() + theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5), axis.ticks.x = element_blank(), axis.title = element_blank()) + coord_fixed(expand = F,ratio = 1)

```


# Correlation matrices within genes and chromatin features
```{r}
# Correlations(chromatin features)
chrom.correlations.data <- slope.protein.features.all %>% filter(term != "(Intercept)") %>% reshape2::dcast(gene ~ feature, value.var = "slope.log2") %>% column_to_rownames(var = "gene")
cor.chrom <- cor(chrom.correlations.data)

# Correlations(genes features)
gene.correlations.data <- slope.prot.features.scale %>% reshape2::dcast(feature ~ gene, value.var = "scaled.slope.log2") %>% column_to_rownames(var = "feature")
gene.chrom <- cor(gene.correlations.data)

```

# I will plot graphs separately without p-values
```{r}
# TTseq
TTseq.interactions <- slope.protein.features.all %>% filter(feature == "TTseq" & term != "(Intercept)")
ggplot(TTseq.interactions) + geom_point(aes(fct_reorder(gene, slope.log2), slope.log2)) + geom_text_repel(data = subset(TTseq.interactions, abs(slope.log2) > 0.05),aes(fct_reorder(gene, slope.log2), slope.log2, label = gene))

# H3K27me3
H3K27me3.interactions <- slope.protein.features.all %>% filter(feature == "TTseq" & term != "(Intercept)")
ggplot(slope.protein.features.all %>% filter(term != "(Intercept)")) + geom_point(aes(fct_reorder(gene, slope.log2), slope.log2)) + geom_text_repel(data = subset(slope.protein.features.all %>% filter(term != "(Intercept)"), abs(slope.log2) > 0.05),aes(fct_reorder(gene, slope.log2), slope.log2, label = gene)) + facet_wrap(~ feature)

```


##Option one but get t-statistics ()
```{r}
# Combine both dataframes
wt.set.mod <- wt.set %>% mutate(gene = "WT") %>% select(t.rep, MMEJscore = wt.MMEJ, library, gene, barcode,log2MMEJ = wt.log2MMEJ)
wt.ko.log2MMEJscreen.all<-log2.MMEJ.screen.detail.all %>% bind_rows(wt.set.mod) %>% left_join(clone5_z.score_chrom_tib) %>% mutate(rep_lib = paste(t.rep,library, sep = "_"))

test.data.all <- wt.ko.log2MMEJscreen.all 

slope.diff.dt.all <- tibble(gene = NA, feature = NA, slope = NA, term = NA, replicate = NA)

for (i in unique(test.data.all$gene)) {
  for (j in colnames(test.data.all)[10:34]) {
    for (k in unique(test.data.all$rep_lib)) {
    model.dt <- test.data.all %>% filter(rep_lib == k) %>% filter(gene == i)
    if (nrow(model.dt) < 1) {
      next
    }
    model.epistasis <- lm(formula = log2MMEJ ~ unlist(model.dt[j]), data = model.dt) %>% tidy()
    slope.diff.dt.all <- slope.diff.dt.all %>% add_row(gene = i, feature = j,replicate = k, slope = model.epistasis %>% pull(estimate), term = model.epistasis %>% pull(term))
    }
  }
}

slope.diff.dt.bis.all <- slope.diff.dt.all %>% filter(term != "(Intercept)") %>% separate(replicate, into = c("rep","library"))


genes.test <- slope.diff.dt.bis.all %>% filter(gene != "WT") %>% pull(gene) %>% unique()
 
# test for differences in slope
test.t.slope.all <- tibble()

tmp <- filter(slope.diff.dt.bis.all, gene %in% c("POLL","FANCM","WT"))

for (x in unique(slope.diff.dt.bis.all$library)) {
  library.filtered <- slope.diff.dt.bis.all %>% filter(library == x)
  for (i in unique(library.filtered$gene)) {
    if (i == "WT") {
      next
    }
  for (k in unique(library.filtered$feature)) {
    t.test.dt<-library.filtered%>%
    filter(gene %in% c(i, "WT") & feature == k)
     if (nrow(t.test.dt) < 6){
      next
     }
    t.test <- t.test.dt %>%
    t.test(slope ~ gene,paired = T, data = .) %>%
    tidy() %>%
    mutate(gene = i, feature = k)
    test.t.slope.all<-bind_rows(test.t.slope.all,t.test)
    }
  }
}

test.tmp.slope<- test.t.slope %>% mutate(p.cor = p.adjust(p.value, method = "BH"))

wt.slope.per.feature.all <- slope.diff.dt.bis.all %>% filter(gene == "WT") %>% select( feature,wt.slope = slope,rep,library)
slope.for.plot.all <- slope.diff.dt.bis.all %>% left_join(wt.slope.per.feature.all) %>% mutate(diff.slope = log2(slope/wt.slope)) %>% dplyr::group_by(gene,feature) %>% dplyr::summarise(m.slope = mean(diff.slope,na.rm = T))
slope.dt.corr.all <- test.t.slope.all %>% mutate(p.cor = p.adjust(p.value, method = "BH")) %>% select(p.cor, gene, feature,p.value) %>% left_join(slope.for.plot.all)

```
# Check highest outliers per chromatin
```{r}
ggplot(slope.dt.corr.all %>% filter(feature == "H3K27me3")) + geom_point(aes(m.slope, -log10(p.value))) + geom_text_repel(data = subset(slope.dt.corr.all %>% filter(feature == "H3K27me3"), p.value < 0.05), aes(m.slope, -log10(p.value), label = gene))

```

```{r}
# test for intercept (not so informative)
intercept.diff.dt <- slope.diff.dt %>% filter(term == "(Intercept)") %>% separate(replicate, into = c("rep","library"))

test.t.intercept <- tibble()

tmp <- filter(intercept.diff.dt, gene %in% c("POLL","FANCM","WT"))

for (x in unique(intercept.diff.dt$library)) {
  library.filtered <- intercept.diff.dt %>% filter(library == x)
  for (i in unique(library.filtered$gene)) {
    if (i == "WT") {
      next
    }
  for (k in unique(library.filtered$feature)) {
    t.test.dt<-library.filtered%>%
    filter(gene %in% c(i, "WT") & feature == k)
     if (nrow(t.test.dt) < 6){
      next
     }
    t.test <- t.test.dt %>%
    t.test(slope ~ gene,paired = T, data = .) %>%
    tidy() %>%
    mutate(gene = i, feature = k)
    test.t.intercept<-bind_rows(test.t.intercept,t.test)
    }
  }
}
 
 test.tmp.intercept<- test.t.intercept %>% mutate(p.cor = p.adjust(p.value, method = "BH"))

 
# For plotting
  wt.intercept.per.feature <- intercept.diff.dt %>% filter(gene == "WT") %>% select( feature,wt.slope = slope,rep,library)
intercept.for.plot <- intercept.diff.dt %>% left_join(wt.intercept.per.feature) %>% mutate(diff.slope = slope - wt.slope) %>% dplyr::group_by(gene,feature) %>% dplyr::summarise(m.slope = mean(diff.slope,na.rm = T))
intercept.dt.corr <- test.t.intercept %>% mutate(p.cor = p.adjust(p.value, method = "BH")) %>% select(p.cor, gene, feature,p.value) %>% left_join(intercept.for.plot)

# Plot this
ggplot(intercept.dt.corr) + 
  geom_point(aes(m.slope,-log10(p.cor), color = p.cor < 0.05)) + 
  geom_text_repel(data = subset(intercept.dt.corr,p.cor < 0.05), aes(m.slope, -log10(p.cor), label = paste(gene,feature,sep = "_"))) +
  theme_bw()
```
# Common epistasis analysis
```{r}
### Compute epistasis for all genes and domains (for plotting) per IPR and pool later for testing

# Prepare all the data tables that I will need for the loop
# mean dt
mean.mmej.dt <- both.screen.controls %>% filter(gene == "WT") %>% dplyr::group_by(t.rep,library) %>% dplyr::summarise(WT_mean = mean(log2(MMEJscore), na.rm = T)) %>% distinct() %>% ungroup()
# mean dt per chromatin domain
#Merge with barcodes and get values per chromatin type
chrom.mmej.dt <- both.screen.controls %>% filter(gene == "WT") %>% select(barcode,MMEJscore,t.rep, library) %>%  dplyr::group_by(t.rep,library,barcode) %>% dplyr::summarise(WT_chrom = mean(log2(MMEJscore), na.rm = T)) %>% distinct() %>% ungroup()
#Create a dt per gene
gene.mmej.dt <- both.screen.detail %>% filter(gene %in% str_extract(per_4chrhits, "^.*(?=_[A-Z])")) %>% select(gene,barcode,MMEJscore,t.rep, library) %>% dplyr::group_by(t.rep,library,gene) %>% dplyr::summarise(KO_mean = mean(log2(MMEJscore), na.rm = T)) %>% distinct() %>% ungroup()
#Create a dt per gene & chromatin
gene.chrom.mmej.dt <- both.screen.detail %>% filter(gene %in% str_extract(per_4chrhits, "^.*(?=_[A-Z])")) %>% dplyr::group_by(t.rep,library,barcode,gene) %>% dplyr::summarise(KO_chrom = mean(log2(MMEJscore), na.rm = T)) %>% distinct() %>% ungroup()

# Empty data table to add all columns in the right order
epistasis.mmej.dt <- tibble()

# Loop to iterate over gene & chromatin feature (This takes very long to run)
for (i in unique(gene.mmej.dt$gene)){
  for (j in unique(chrom.domain.dt$barcode)) {
  tmp <- gene.chrom.mmej.dt %>% 
  filter(barcode == j & gene == i) %>% 
  left_join(mean.mmej.dt,by = c("t.rep", "library")) %>%
  left_join(chrom.mmej.dt, c("t.rep", "library", "barcode")) %>%
  left_join(gene.mmej.dt, c("t.rep", "library", "gene"))
  
  epistasis.mmej.dt <- bind_rows(epistasis.mmej.dt,tmp)
  
  }
}

# Keeping three replicates separated
calc.epistasis.mmej.dt <- epistasis.mmej.dt %>% mutate(KO_diff = KO_mean - WT_mean, chrom_diff = WT_chrom - WT_mean, add_eff = KO_diff + chrom_diff, KO_chrom_diff = KO_chrom - WT_mean, tmp_res =(abs(KO_chrom_diff) - abs(add_eff)))

# Simple t-test
tmp.t.test.trip_het_dom <- calc.epistasis.mmej.dt %>% left_join(clasification.4.chroms) %>% mutate(euchr = case_when(chrom.4 == "euchromatin" ~ "euchromatin", T ~ "heterochromatin"))

#make empty tibble
tmp.test.euchr.heterochromatin <-tibble()
 
#loop over identity of enhancers and do aov test per enhancer
for (i in unique(tmp.t.test.trip_het_dom$gene)) {
  for(j in unique(tmp.t.test.trip_het_dom$euchr)){
  gene.filt<-tmp.t.test.trip_het_dom%>%
  filter(gene==i & euchr ==j)
  
  t.test <- t.test(gene.filt$KO_chrom_diff,gene.filt$add_eff, paired = T) %>% tidy() %>% mutate(gene = i, euchr = j)
 
  tmp.test.euchr.heterochromatin<-tmp.test.euchr.heterochromatin%>%
  bind_rows(t.test)
}}

tmp <- tmp.test.euchr.heterochromatin %>% distinct() %>% mutate(p.cor = p.adjust(p.value, method = "fdr"))

# Pooling replicates together
mean.calc.epistasis.mmej.dt <- calc.epistasis.mmej.dt %>% select(-t.rep,-library) %>% dplyr::group_by(barcode, gene) %>% dplyr::summarise_all(mean) %>% left_join(clasification.4.chroms) %>% mutate(euchr = case_when(chrom.4 == "euchromatin" ~ "euchromatin", T ~ "heterochromatin")) %>% left_join(tmp %>% select(p.cor,p.value, gene, euchr))

epistasis.for.plot <- mean.calc.epistasis.mmej.dt %>% ungroup() %>% select(-barcode, -chrom.4) %>% dplyr::group_by(euchr,gene) %>% dplyr::summarise_all(mean, na.rm = T)

# Plot for epistasis (heterochromatin vs. euchromatin)
ggplot(epistasis.for.plot) + 
  geom_point(aes(abs(KO_chrom_diff) - abs(add_eff), -log10(p.cor), color = p.cor < 0.1))+
  facet_wrap(~ euchr) + 
  theme_bw() +
  geom_text_repel(data = subset(epistasis.for.plot, p.cor < 0.1), aes(abs(KO_chrom_diff) - abs(add_eff), -log10(p.cor), label = gene))

```

```{r}
#make empty tibble
tmp.test.heterochromatin <-tibble()
 
#loop over identity of enhancers and do aov test per enhancer
for (i in unique(tmp.t.test.trip_het_dom$gene)) {
  for(j in unique(tmp.t.test.trip_het_dom$chrom.4)){
  gene.filt<-tmp.t.test.trip_het_dom%>%
  filter(gene==i & chrom.4 ==j)
  if (nrow(gene.filt) < 3) {
    next
  }
  
  t.test <- t.test(gene.filt$KO_chrom_diff,gene.filt$add_eff, paired = T) %>% tidy() %>% mutate(gene = i, chrom.4 = j)
 
  tmp.test.heterochromatin<-tmp.test.heterochromatin%>%
  bind_rows(t.test)
}}

heterochromatin.corr <- tmp.test.heterochromatin %>% filter(chrom.4 != "euchromatin") %>% distinct() %>% mutate(p.cor = p.adjust(p.value, method = "fdr"))

# Pooling replicates together
mean.calc.epistasis.mmej.dt.het <- calc.epistasis.mmej.dt  %>% select(-t.rep,-library) %>% dplyr::group_by(barcode, gene) %>% dplyr::summarise_all(mean) %>% left_join(clasification.4.chroms) %>% filter(chrom.4 != "euchromatin") %>% left_join(heterochromatin.corr %>% select(p.cor,p.value, gene, chrom.4))

epistasis.for.plot.het <- mean.calc.epistasis.mmej.dt.het %>% ungroup() %>% select(-barcode) %>% dplyr::group_by(chrom.4,gene) %>% dplyr::summarise_all(mean, na.rm = T)

# Plot for epistasis (heterochromatin vs. euchromatin)
ggplot(epistasis.for.plot.het) + 
  geom_point(aes(abs(KO_chrom_diff) - abs(add_eff), -log10(p.cor), color = p.cor < 0.1))+
  facet_wrap(~ chrom.4) + 
  theme_bw() +
  geom_text_repel(data = subset(epistasis.for.plot.het, p.cor < 0.1), aes(abs(KO_chrom_diff) - abs(add_eff), -log10(p.cor), label = gene))

```
# Test differences in euchromatin
```{r}
# Simple t-test
tmp.t.test.euchr <- calc.epistasis.mmej.dt %>% left_join(clone5_chrom_tib) %>% filter(euchromatin == 1)

#make empty tibble
tmp.test.euchromatin <-tibble()
 
#loop over identity of enhancers and do aov test per enhancer
for (i in unique(tmp.t.test.euchr$gene)) {
  for(j in unique(tmp.t.test.euchr$transcription)){
  gene.filt<-tmp.t.test.euchr%>%
  filter(gene==i & transcription ==j)
  if (nrow(gene.filt) < 3) {
    next
  }
  
  t.test <- t.test(gene.filt$KO_chrom_diff,gene.filt$add_eff, paired = T) %>% tidy() %>% mutate(gene = i, transcription = j)
 
  tmp.test.euchromatin<-tmp.test.euchromatin%>%
  bind_rows(t.test)
}}

euchromatin.corr <- tmp.test.euchromatin %>% distinct() %>% mutate(p.cor = p.adjust(p.value, method = "fdr"))

# Pooling replicates together
mean.calc.epistasis.mmej.dt.euchr <- calc.epistasis.mmej.dt  %>% select(-t.rep,-library) %>% dplyr::group_by(barcode, gene) %>% dplyr::summarise_all(mean) %>% left_join(clone5_chrom_tib) %>% filter(euchromatin == 1) %>% left_join(euchromatin.corr %>% select(p.cor,p.value, gene, transcription))

epistasis.for.plot.euchr <- mean.calc.epistasis.mmej.dt.euchr %>% ungroup() %>% select(KO_chrom_diff,add_eff,p.cor,p.value,gene,transcription) %>% dplyr::group_by(transcription,gene) %>% dplyr::summarise_all(mean, na.rm = T)

# Plot for epistasis (heterochromatin vs. euchromatin)
ggplot(epistasis.for.plot.euchr) + 
  geom_point(aes(abs(KO_chrom_diff) - abs(add_eff), -log10(p.cor), color = p.cor < 0.1))+
  facet_wrap(~ transcription) + 
  theme_bw() +
  geom_text_repel(data = subset(epistasis.for.plot.euchr, p.cor < 0.1), aes(abs(KO_chrom_diff) - abs(add_eff), -log10(p.cor), label = gene))
```

```
## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
