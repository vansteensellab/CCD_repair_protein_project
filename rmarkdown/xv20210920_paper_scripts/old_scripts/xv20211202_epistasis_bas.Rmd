---
title: "xv20211121_epistasis_model_bas"
output: html_document
---

In this document, I will go over different calculations of epistasis.4 different workflows:
First decision is whether to use log2 MMEJscore or MMEJscore
Second decision is comparing slopes or statistic differences between WT vs. KO slopes

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Libraries
```{r libraries}
# libraries:
library(tidyverse)
library(data.table)
library(parallel)
library(gtools)
library(pheatmap)
library(ggbeeswarm)
library(reshape2)
library(gridExtra)
library(broom)
library(ggrepel)
library(dendextend)
library(Hmisc)
```

# Aesthetic legend for the whole paper
```{r}
# Pathway color palette (MMEJ, wt/no_effect, NHEJ)
pathway.colors <- c("#EB2030","grey90","#2E358F")
# Pathway symbol palette ()
pathway.symbol <- c(19,17)

# Chromatin color palette
#chrom_colors = c( c("euchromatin" = "#F7941D", "other" = "#838687",  "H3K27me3" = "#D21F8A", "triple" = "#662D91"))
chromatin.colors <- c("#D21F8A","#838687","#F7941D","#662D91")
```

# Import data tables

```{r, include= FALSE}
#dcast table
#ddr
ddr.screen.dcast <- readRDS("/home/x.vergara/XV_P3_ChromDSBScreen/xv20201204_agm_ddr_screen/data/xv20210609_screen_ddr_dcast.rds")
#chromatin
chr.screen.dcast <- readRDS("/home/x.vergara/XV_P3_ChromDSBScreen/xv20200421_ChromDSBscreen/data/xv20201014_frozen_chz_scores_dcast.rds")
  
#detailed table
#ddr
ddr.screen.detail <- readRDS("/home/x.vergara/XV_P3_ChromDSBScreen/xv20201204_agm_ddr_screen/data/xv20210609_screen_ddr_scores.rds")
colnames(ddr.screen.detail)[9] <- "b.rep"
colnames(ddr.screen.detail)[10] <- "t.rep"
ddr.screen.detail$library <- "DNA_repair"
#chromatin
chr.screen.detail <- readRDS("/home/x.vergara/XV_P3_ChromDSBScreen/xv20200421_ChromDSBscreen/data/xv20201014_frozen_chz_scores_mmej.rds")
chr.screen.detail$library <- "Chromatin"


# I think I don't need these ones for this figure
#Control table (WT & POLQ)
#ddr
ddr.screen.controls <- readRDS("/home/x.vergara/XV_P3_ChromDSBScreen/xv20201204_agm_ddr_screen/data/xv20210609_screen_ddr_controls.rds")
colnames(ddr.screen.controls)[9] <- "b.rep"
colnames(ddr.screen.controls)[10] <- "t.rep"
ddr.screen.controls$library <- "DNA_repair"

#chromatin
chr.screen.controls <- readRDS("/home/x.vergara/XV_P3_ChromDSBScreen/xv20200421_ChromDSBscreen/data/xv20201014_frozen_chz_scores_controls.rds")
chr.screen.controls$library <- "Chromatin"

#indel data
indel.data.ddr <- readRDS(file = "/home/x.vergara/XV_P3_ChromDSBScreen/xv20201204_agm_ddr_screen/data/xv20210526_screen_DDR_indel_data.rds")

# Chromatin follow up data
chromatin.followup <- readRDS("/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/data/xv20211005_chromatin_follow_up.rds")

#Chromatin data
clone5_chrom_tib <- readRDS('/DATA/projects/DSBrepair/data/R/cl20201026_ChIP_zscore_selection.RDS') %>% mutate(barcode = str_extract(ID,"^.*(?=\\.)"))

# Inhibitor experiment
inhibitor.data <- readRDS("~/XV_P3_ChromDSBScreen/xv20210716_E1627_ATR_inhibitor/data/xv20210716_E1627_indel_script_ATRi.rds") %>% left_join(inhibitor.table)

```

# Put both screens together
```{r}
#detailed table with all the variables
both.screen.detail <- bind_rows(ddr.screen.detail, chr.screen.detail) %>% mutate(ID_gene = paste(gene, library, sep = "_")) %>% filter(sample == "KO" & !ID_gene %in% c("DMSO_DNA_repair","LBR_ctrl_DNA_repair"))

# Get heatmap by chromatin type (4 types, but maybe it's better to make 4 "same as RS paper")
clasification.4.chroms <- clone5_chrom_tib %>% select(chromatin,barcode) %>% dplyr::mutate(chrom.4 = case_when(chromatin %in% c("euchromatin-transcription","other-euchromatin","transcription") ~ "euchromatin", T ~ chromatin)) %>% select(-chromatin)

#Number of IPRs per chromatin
summary.4chroms <- clasification.4.chroms %>% dplyr::group_by(chrom.4) %>% dplyr::summarise(counts = n())

# Compute score per 4 chromatin types
both.screen.detail.4chrom <- both.screen.detail %>% 
  left_join(clasification.4.chroms, by = "barcode") %>% 
  select(barcode,chrom.4, mmej.z.score,t.rep,ID_gene)

score.per.4chrom.rep <- both.screen.detail.4chrom %>%
  dplyr::group_by(chrom.4,t.rep,ID_gene) %>%
  dplyr::summarise(chrom4score = mean(mmej.z.score, na.rm = T))

score.per.4chrom <- score.per.4chrom.rep %>%
  dplyr::group_by(chrom.4,ID_gene) %>%
  dplyr::summarise(screen.score = sum(chrom4score, na.rm = T)/sqrt(n()))

combined.data.screen <- left_join(score.per.4chrom,score.per.4chrom.rep)
```

#Example with three genes (POLL, FANCM, POLQ) & I will use "H3K4me1" as example
1st step = Compare POLL, FANCM, POLQ and WT data points vs. H3K4me1 (in lin or log space)

step 1 = plot 

```{r}
# Data table and compute log2MMEJ
log2.MMEJ.screen.detail <- both.screen.detail %>% filter(ID_gene %in% per_4chrhits) %>% select(t.rep, MMEJscore,library, gene,barcode) %>% mutate(log2MMEJ = log2(MMEJscore))

# WT data table set
wt.set <- filter(both.screen.controls, gene == "WT") %>% select(t.rep, MMEJscore,library, gene,barcode) %>% mutate(log2MMEJ = log2(MMEJscore)) %>% dplyr::group_by(barcode, t.rep,library) %>% dplyr::summarise(wt.log2MMEJ = mean(log2MMEJ, na.rm = T), wt.MMEJ = mean(MMEJscore, na.rm = T))

# Plot differences
data.for.plotting <- wt.set %>% mutate(gene = "WT") %>% select(t.rep, MMEJscore = wt.MMEJ, library, gene, barcode,log2MMEJ = wt.log2MMEJ) %>% bind_rows(log2.MMEJ.screen.detail) %>% mutate(rep_lib = paste(t.rep,library, sep = "_")) %>% dplyr::group_by(gene,barcode) %>% dplyr::summarise(m.log2MMEJ = mean(log2MMEJ, na.rm = T), m.MMEJ = mean(MMEJscore,na.rm = T)) %>% left_join(clone5_chrom_tib)

# Plot in log2 space
ggplot(data.for.plotting %>% filter(gene %in% c("POLL","POLQ","FANCM","WT")), aes(H3K4me1,m.log2MMEJ, color = gene)) +
  geom_point() +
  geom_smooth(method = "lm") +
  stat_cor(method = "spearman") +
  theme_bw()

# Plot in log2 space
ggplot(data.for.plotting %>% filter(gene %in% c("POLL","POLQ","FANCM","WT")), aes(H3K4me1,m.MMEJ, color = gene)) +
  geom_point() +
  geom_smooth(method = "lm") +
  stat_cor(method = "spearman") +
  theme_bw()
```


# 2nd step check compute distances and plot them
```{r}
# Each replicate has a different value (compute differences by replicate)
log2.distance.mmej <- log2.MMEJ.screen.detail %>% left_join(wt.set) %>% mutate(log2.dist = sqrt((log2MMEJ - wt.log2MMEJ)^2), lin.dist = sqrt((MMEJscore - wt.MMEJ)^2)) 
mean.log2.distance.mmej <- log2.distance.mmej %>% dplyr::group_by(barcode,gene) %>% dplyr::summarise(m.log2.dist = mean(log2.dist, na.rm = T), m.lin.dist = mean(lin.dist, na.rm = T)) %>% left_join(clone5_chrom_tib)

#Plot slopes
ggplot(mean.log2.distance.mmej %>% 
         filter(gene %in% c("POLL","POLQ","FANCM")),
       aes(H3K4me1,m.log2.dist, color = gene)) + 
  geom_point() + 
  stat_cor() + 
  geom_smooth(method = "lm") + 
  theme_bw()

```
# Extract slopes for all genes
```{r}
# Perform analysis across all features for three test genes
chromatin.features <- colnames(mean.log2.distance.mmej)[8:32]

slope.protein.features <- tibble(gene = NA, feature = NA, slope.log2 = NA, term = NA, slope.lin = NA)

for (i in unique(mean.log2.distance.mmej$gene)) {
  for (j in colnames(mean.log2.distance.mmej)[8:32]) {
    model.dt <- mean.log2.distance.mmej %>% filter(gene == i)
    model.epistasis.log2 <- lm(formula = m.log2.dist ~ unlist(model.dt[j]), data = model.dt) %>% tidy()
    model.epistasis.lin <- lm(formula = m.lin.dist ~ unlist(model.dt[j]), data = model.dt) %>% tidy()
    slope.protein.features <- slope.protein.features %>% add_row(gene = i, feature = j, slope.log2 = model.epistasis.log2 %>% pull(estimate), term = model.epistasis %>% pull(term), slope.lin = model.epistasis.lin %>% pull(estimate))
  }
}

# Plot matrix without scaling
# log2 space
ggplot(slope.protein.features %>% filter(term != "(Intercept)" & complete.cases(.))) + geom_tile(aes(gene,feature, fill = slope.log2)) + scale_fill_gradient2() + theme_bw() +theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust =0.5))

slope.prot.features.scale.dcast <- slope.protein.features  %>% filter(term == "unlist(model.dt[j])") %>% reshape2::dcast(gene ~ feature, value.var = "slope.log2") %>% column_to_rownames(var = "gene")

```

# Plot matrix as a tile but clustered
```{r}
#Heatmap for slope differences
heatmap.slope.diff <- pheatmap(slope.prot.features.scale.dcast, cell_height = 8, cellwidth = 8)
heatmap.gene.order.slope.diff <- rownames(slope.prot.features.scale.dcast[heatmap.slope.diff$tree_row[["order"]],])
heatmap.chromatin.order.slope.diff <- colnames(slope.prot.features.scale.dcast[,heatmap.slope.diff$tree_col[["order"]]])

#
cor.features.epistasis.hits <- cor(slope.prot.features.scale.dcast, method = "spearman")
heatmap.features.epistasis.hits <- pheatmap(cor.features.epistasis.hits)
heatmap.features.epistasis.hits <- rownames(cor.features.epistasis.hits[heatmap.features.epistasis.hits$tree_row[["order"]],])


#Plot correlations (As a heatmap with corrected pvalues)
ggplot(slope.protein.features %>% filter(term != "(Intercept)" & complete.cases(.))) + 
  geom_tile(aes(fct_relevel(gene,heatmap.gene.order.slope.diff),fct_relevel(feature, heatmap.features.epistasis.hits), fill = slope.log2)) +
  scale_fill_gradient2( low = "#8c510a" ,mid = "#f5f5f5", high = "#01665e") + 
  coord_fixed(expand = F) + theme_bw() + theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5), axis.title = element_blank())


```
# Fanconi anemia core complex genetic interactions
```{r}
# Fanconi anemia core complex 
FA.core.complex <- c("FANCL","FANCA","FANCB","FANCF","FANCG","FANCM") # Based on CORUM 1624 complex
FA.effector <- c("FANCD2","FANCI")
other.FA <- c("FAN1","FAAP24","FAAP20","USP1")

# filter all genes and re-run this
FA.core.complex.gen.int <- slope.proteins.all %>% filter(gene %in% FA.core.complex)
summary.effect <- FA.core.complex.gen.int %>% dplyr::group_by(feature) %>% dplyr::summarise(m = mean(slope.log2, na.rm = T)) %>% arrange(desc(m)) %>% pull(feature)

FA.eff.gen.int <- slope.proteins.all %>% filter(gene %in% FA.effector)
FA.other.gen.int <- slope.proteins.all %>% filter(gene %in% other.FA)

ggplot() + 
  geom_line(data = FA.eff.gen.int, aes(fct_relevel(feature,heatmap.features.epistasis),slope.log2, group = gene), color = "red", alpha = 0.2) +
  stat_summary(data = FA.eff.gen.int, aes(fct_relevel(feature,heatmap.features.epistasis),slope.log2, group = "1"), fun = "mean", na.rm = T, geom = "line", color = "red") +
    geom_line(data = FA.other.gen.int, aes(fct_relevel(feature,heatmap.features.epistasis),slope.log2, group = gene), color = "darkgreen", alpha = 0.2) +
  stat_summary(data = FA.other.gen.int, aes(fct_relevel(feature,heatmap.features.epistasis),slope.log2, group = "1"), fun = "mean", na.rm = T, geom = "line", color = "darkgreen") +
   geom_line(data = FA.core.complex.gen.int, aes(fct_relevel(feature,heatmap.features.epistasis),slope.log2, group = gene), alpha = 0.2,color = "blue") + 
  stat_summary(data = FA.core.complex.gen.int, aes(fct_relevel(feature,heatmap.features.epistasis),slope.log2, group = "1"), fun = mean, na.rm = T, geom = "line", color = "blue")+
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
  geom_hline(yintercept = 0, linetype = 2)
```
# Fanconi anemia core complex genetic interactions
```{r}
# Fanconi anemia core complex 
FA.core.complex <- tibble(gene = c("FANCL","FANCA","FANCB","FANCC", "FANCE","FANCF","FANCG","FANCM"), complex = "FA_core") # Based on CORUM 1624 complex
MRN.complex <- tibble(gene = c("NBN","RAD50","MRE11"), complex = "MRN_complex")
RNF8.RNF168 <- tibble(gene = c("RNF8","RNF168"), complex = "RNF8_RNF168")
complexes <- bind_rows(FA.core.complex,MRN.complex,RNF8.RNF168)

# filter all genes and re-run this
complex.gen.inter <- slope.proteins.all %>% right_join(complexes) %>% mutate(gc = paste(gene,complex, sep = "_"))

ggplot(complex.gen.inter) +
  geom_line(aes(fct_relevel(feature,heatmap.features.epistasis),slope.log2, group = gc, color = complex), alpha = 0.2) +
  stat_summary(aes(fct_relevel(feature,heatmap.features.epistasis), slope.log2, group = complex, color = complex), fun = mean, na.rm = T, geom = "line") + 
  geom_hline(yintercept = 0, linetype = 2) +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
  geom_hline(yintercept = 0, linetype = 2)

```
# Make plot with cross-correlation
```{r}
#
cor.slope<- as.data.frame(cor(t(slope.prot.features.dcast.all), method = "spearman") )%>% rownames_to_column(var = "gene")
cor.slope.p <- as.data.frame(rcorr(t(slope.prot.features.dcast.all), type = "spearman")$P)%>% rownames_to_column(var = "gene")
cor.slope.FANC <- cor.slope %>% select(FANCM,gene) 
cor.slope.FANC.p <- cor.slope.p %>% select(FANCM,gene) %>% mutate(FANCM.adj = p.adjust(FANCM,method = "bonferroni")) %>% arrange(FANCM.adj)

ggplot(cor.slope.FANC) + geom_point(aes(fct_reorder(gene,desc(FANCM)),FANCM, color = grepl("FA", gene))) + geom_text_repel(data = subset(cor.slope.FANC,grepl("FA",gene)), aes(fct_reorder(gene,FANCM),FANCM,label = gene))

ggplot(cor.slope.FANC.p) + geom_point(aes(fct_reorder(gene,FANCM.adj),-log10(FANCM.adj), color = grepl("FA", gene))) + geom_text_repel(data = subset(cor.slope.FANC.p,grepl("FA",gene)), aes(fct_reorder(gene,FANCM.adj),-log10(FANCM),label = gene)) + theme_bw()

```

# Geet the opposiite persepective, take one feature and show interactions
```{r}
# H2AFZ
arrange.genes.HDAC1 <- filter(slope.protein.features.all %>% filter(feature == "HDAC3" & term != "(Intercept)")) %>% arrange(slope.log2) %>% pull(gene)

HDAC.all <- slope.protein.features.all %>% filter(feature %in% c("HDAC1","HDAC2","HDAC3") & term != "(Intercept)")
ggplot(HDAC.all) + geom_point(aes(fct_relevel(gene,arrange.genes.HDAC1),slope.log2)) + facet_wrap(~ feature)

ggplot(HDAC.all %>% reshape2::dcast(gene ~ feature, value.var = "slope.log2"), aes(HDAC2,HDAC3)) + geom_point() + geom_smooth(method = "lm") + stat_cor(method = "pearson")


```

