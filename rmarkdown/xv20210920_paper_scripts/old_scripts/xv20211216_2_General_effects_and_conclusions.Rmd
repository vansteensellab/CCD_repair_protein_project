---
title: "xv20211005_2_General_effects_and_conclusions"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Libraries
```{r libraries}
# libraries:
library(tidyverse)
library(data.table)
library(parallel)
library(gtools)
library(pheatmap)
library(ggbeeswarm)
library(reshape2)
library(gridExtra)
library(broom)
library(ggrepel)
library(gprofiler2)
```

# Aesthetic legend for the whole paper
```{r}
# Pathway color palette (MMEJ, wt/no_effect, NHEJ)
pathway.colors <- c("#EB2030","grey90","#2E358F")
# Pathway symbol palette ()
pathway.symbol <- c(19,17)

# Chromatin color palette
#chrom_colors = c( c("euchromatin" = "#F7941D", "other" = "#838687",  "H3K27me3" = "#D21F8A", "triple" = "#662D91"))
chromatin.colors <- c("#D21F8A","#838687","#F7941D","#662D91")
#Library colors
library.colors <- c("#E69F03","#56B3E6")
```

# Import data tables

```{r libraries}
#dcast table
#ddr
ddr.screen.dcast <- readRDS("/home/x.vergara/XV_P3_ChromDSBScreen/xv20201204_agm_ddr_screen/data/xv20210609_screen_ddr_dcast.rds")
#chromatin
chr.screen.dcast <- readRDS("/home/x.vergara/XV_P3_ChromDSBScreen/xv20200421_ChromDSBscreen/data/xv20201014_frozen_chz_scores_dcast.rds")
  
#detailed table
#ddr
ddr.screen.detail <- readRDS("/home/x.vergara/XV_P3_ChromDSBScreen/xv20201204_agm_ddr_screen/data/xv20210609_screen_ddr_scores.rds")
colnames(ddr.screen.detail)[9] <- "b.rep"
colnames(ddr.screen.detail)[10] <- "t.rep"
ddr.screen.detail$library <- "DNA_repair"
#chromatin
chr.screen.detail <- readRDS("/home/x.vergara/XV_P3_ChromDSBScreen/xv20200421_ChromDSBscreen/data/xv20201014_frozen_chz_scores_mmej.rds")
chr.screen.detail$library <- "Chromatin"


# I think I don't need these ones for this figure
#Control table (WT & POLQ)
#ddr
ddr.screen.controls <- readRDS("/home/x.vergara/XV_P3_ChromDSBScreen/xv20201204_agm_ddr_screen/data/xv20210609_screen_ddr_controls.rds")
colnames(ddr.screen.controls)[9] <- "b.rep"
colnames(ddr.screen.controls)[10] <- "t.rep"
ddr.screen.controls$library <- "DNA_repair"

#chromatin
chr.screen.controls <- readRDS("/home/x.vergara/XV_P3_ChromDSBScreen/xv20200421_ChromDSBscreen/data/xv20201014_frozen_chz_scores_controls.rds")
chr.screen.controls$library <- "Chromatin"


#indel data
indel.data.ddr <- readRDS(file = "/home/x.vergara/XV_P3_ChromDSBScreen/xv20201204_agm_ddr_screen/data/xv20210526_screen_DDR_indel_data.rds")

# Chromatin follow up data
chromatin.followup <- readRDS("/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/data/xv20211005_chromatin_follow_up.rds")

# Put both screens together
#detailed table with all the variables
both.screen.detail <- bind_rows(ddr.screen.detail, chr.screen.detail) %>% mutate(ID_gene = paste(gene, library, sep = "_")) %>% filter(sample == "KO" & !ID_gene %in% c("DMSO_DNA_repair","LBR_ctrl_DNA_repair"))
```

# Generate data table: Hit selection

```{r}
# Compute the average effect for every biological replicate (mean x = 19 IPR)
both.screen.gene.value <- both.screen.detail %>% select(ID_gene, b.rep, t.rep,barcode, mmej.z.score) %>% 
  mutate(tech.rep = case_when(t.rep == "R5" ~ "R3", t.rep == "R4" ~ "R2", T ~ t.rep)) %>% 
  dplyr::group_by(ID_gene,tech.rep) %>% 
  dplyr::summarise(IPR.z.score = mean(mmej.z.score, na.rm = T)) %>% ungroup() %>%
  dplyr::group_by(ID_gene) %>%
  dplyr::summarise(comb.data = sum(IPR.z.score, na.rm = T)/sqrt(n())) %>%
  mutate(pathway = case_when(comb.data < -1.95 ~ "MMEJ", comb.data > 1.95 ~ "NHEJ", T ~ "NA"), library = case_when(grepl("DNA", ID_gene) ~ "DNA_repair", grepl("Chromatin", ID_gene) ~ "Chromatin"))
```


Fig 2B: How many genes are involved in each pathway
```{r}
# How many genes perturb each pathway
hits.per.pathway <- both.screen.gene.value %>% group_by(pathway) %>% dplyr::summarise(counts = n())
ggplot(hits.per.pathway %>% filter(pathway != "NA")) + geom_col(aes(pathway, counts, fill = pathway)) + theme_bw() + coord_cartesian(ylim = c(0,100)) + scale_fill_manual(values = c("#EB2030","#2E358F")) + ylab("Number of genes that perturb each pathway")

```
Fig 2B: Check if CORUM picks something
```{r}
# Genes in MMEJ
hits.mmej <- filter(both.screen.gene.value, pathway == "MMEJ") %>% pull(ID_gene) %>% gsub("_.*$","",.)
write(hits.mmej, "/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/data/xv20211005_mmej_hits.txt")
hits.nhej <-  filter(both.screen.gene.value, pathway == "NHEJ") %>% pull(ID_gene) %>% gsub("_.*$","",.)
write(hits.nhej, "/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/data/xv20211216_nhej_hits.txt")

#Generate enrichment chasrts: Full go into supplementary
gotest.mmej <- gost(hits.mmej, organism = "hsapiens",sources = "CORUM")
gotest.nhej <- gost(hits.nhej, organism = "hsapiens",sources = "CORUM", significant = F)

#Full Plot that goes to supplementary
ggplot(gotest.mmej$result %>% dplyr::group_by(term_name, term_id) %>% dplyr::summarise(p_val = -log10(mean(p_value)), CORUM_name = paste0(term_name, term_id, sep = "_"))) + geom_col(aes(p_val,reorder(CORUM_name,p_val)), fill = "#EB2030") + coord_cartesian(expand = F) + theme_minimal() + xlab("-log10(p-adj)") + ylab("")

#Supplementary plot NHEJ
ggplot(gotest.nhej$result %>% dplyr::group_by(term_name, term_id) %>% dplyr::summarise(p_val = -log10(mean(p_value)), CORUM_name = paste0(term_name, term_id, sep = "_"))) + geom_col(aes(p_val,reorder(CORUM_name,p_val)), fill = "#2E358F") + coord_cartesian(expand = F) + theme_minimal() + xlab("-log10(p-adj)") + ylab("") 

# Plot for paper
selected_corum_id <- c("CORUM:2739","CORUM:248","CORUM:2815","CORUM:5197","CORUM:2217","CORUM:1111","CORUM:2218","CORUM:387","CORUM:2766","CORUM:1189","CORUM:6732","CORUM:936","CORUM:1218")
complex.enrichment <- gotest.mmej$result %>% filter(term_id %in% selected_corum_id) %>% dplyr::group_by(term_name, term_id) %>% dplyr::summarise(p_val = -log10(mean(p_value)), CORUM_name = paste(term_name, term_id, sep = "_"))
ggplot(complex.enrichment) +
  geom_col(aes(p_val, reorder(CORUM_name, p_val)), fill = "#EB2030") + coord_cartesian(expand = T)+ xlab("-log10(p-adj)") + ylab("")

```
Figure 3D: Effect sizes of these complexes (with proteins all prots in the complex)
```{r}
# 
screen.with.genes <- both.screen.gene.value %>% separate(ID_gene, into = "gene", remove = F)

# dt with interesting complexes
FA_complex_ID_2378 <- c("BLM","TOP3A","FANCL","FANCA","FANCB","FANCC","FANCE","FANCF","FANCG","RMI","RPA1")
BRCA1_BARD1_BACH1_ID_2815 <- c("BARD1","BRCA1","RBBP8","RAD50","TOPBP1","MRE11","NBN","BACH1")
MDC1_MRN_ID_2218 <- c("RAD50","MRE11","MDC1","NBN")
DNA_synth_ID_1111 <- c("POLA1","POLA2","POLD1","POLD2","POLD3","POLD4","PRIM2","PRIM1","POLE","POLE2","POLE3","POLE4","TOP1","TOP2A","PCNA","RFC1","RPA1")
MCM_ID_387 <- c("MCM2","MCM3","MCM4","MCM5","MCM6","MCM7")

prot.complexes <- tibble(gene = c(FA_complex_ID_2378,BRCA1_BARD1_BACH1_ID_2815,MDC1_MRN_ID_2218,DNA_synth_ID_1111,MCM_ID_387), complex = c(rep("FA_complex_ID_2378",length(FA_complex_ID_2378)),rep("BRCA1_BARD1_BACH1_ID_2815",length(BRCA1_BARD1_BACH1_ID_2815)),rep("MDC1_MRN_ID_2218",length(MDC1_MRN_ID_2218)),rep("DNA_synth_ID_1111",length(DNA_synth_ID_1111)),rep("MCM_ID_387",length(MCM_ID_387))))

# Left join screening value
prot.complex.effects <- left_join(prot.complexes,screen.with.genes %>% select(gene,comb.data)) %>% filter(complete.cases(.))

#Figure for paper
ggplot(prot.complex.effects) + geom_point(aes(reorder(gene, comb.data),complex,color = comb.data, size = abs(comb.data))) + theme_bw() + scale_color_gradient2(high = "#2E358F", mid = "grey80",low = "#EB2030") + xlab("") + ylab("") + facet_wrap(~ complex, scales = "free", ncol = 1) + theme(axis.text.y = element_blank(), legend.position = "top",  axis.ticks.y = element_blank())
```

Fig 2D: Classification per chromatin
```{r}
# How many genes perturb each pathway
hits.per.library <- both.screen.gene.value %>% filter(pathway != "NA") %>% group_by(library) %>% dplyr::summarise(counts = n())
ggplot(hits.per.library %>% filter(library != "NA")) + geom_col(aes(fct_relevel(library, c("DNA_repair","Chromatin")),counts, fill = library)) + theme_bw() + coord_cartesian(ylim = c(0,100)) + ylab("Number of hits") + scale_fill_manual(values = library.colors) + theme(legend.position = "none")
```
# Fig 2Show all proteins that are in chromatin proteins
```{r}
# Chromatin hits
chromatin.hits <-  both.screen.gene.value %>% filter(pathway != "NA") %>% filter(library == "Chromatin") %>% arrange(desc(comb.data)) %>% separate(ID_gene, into = "gene", remove = T) %>% pull(gene)

# Filter
plot.chromatin.hits <- both.screen.detail %>% filter(gene %in% chromatin.hits) %>% 
  dplyr::group_by(gene,barcode,library) %>% 
  dplyr::summarise(IPR.z.score = sum(mmej.z.score, na.rm = T)/sqrt(n())) %>% ungroup()

#plot 
ggplot(plot.chromatin.hits,aes(fct_relevel(gene,chromatin.hits),IPR.z.score, color = library, fill = library)) +
  geom_quasirandom() + geom_hline(yintercept = c(1.95,-1.95), linetype = 2) + theme_bw() + scale_color_manual(values = library.colors) + coord_flip() + stat_mean(geom = "point", color = "black")
``` 

Figure 2F: Follow up experiment
```{r}
# gRNA difference per gene
strong_hits <- filter(chromatin.followup, gene %in% c("SUPT5H","SAP130"))
#Option A (z-scores)
z.score.plot <- strong_hits %>% 
  dplyr::group_by(gene,gRNA, barcode) %>% 
  dplyr::summarise(MMEJfupscore = sum(z.score)/sqrt(n()))

ggplot(z.score.plot) + 
  geom_quasirandom(aes(fct_relevel(gRNA, c("Combo")),MMEJfupscore)) + 
  facet_wrap(~ fct_relevel(gene, c("SUPT5H","SAP130"))) +
  stat_mean(aes(fct_relevel(gRNA, c("Combo")), MMEJfupscore), geom = "point", color ="red") +
  theme_bw() +
  geom_hline(yintercept = c(-1.95,1.95), linetype = 2) +
  ylab("MMEJscore perturbation (z-score)")

```
