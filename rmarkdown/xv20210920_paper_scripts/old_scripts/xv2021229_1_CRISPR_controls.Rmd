---
title: "xv20211229_1_CRISPR_controls"
output: html_document
---
# Script to generate figure #1 in the paper. This figure describes the layout of the screen and technical issues. Figure outline:
A- Cartoon explaining screen
B- Computational analysis (Include?)
C- MMEJ:NHEJ balance density plot between replicates of controls
D- Dynamic range of the screen: Controls and KOs
E- Correlation of MMEJ:NHEJ balance

Data in text:
A-...
B-...

Supplementary figure 1:
A- Plate layout: Explaining control positions
B- Gene editing frequency between controls
C- Correlation of gene editing balance

This script generates the plots for figure 1 and S1

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Libraries
```{r libraries}
# libraries:
library(tidyverse)
library(data.table)
library(parallel)
library(gtools)
library(pheatmap)
library(ggbeeswarm)
library(reshape2)
library(gridExtra)
library(broom)
library(ggrepel)
library(gprofiler2)
```

# Aesthetic legend for the whole paper
This are the colors that I will use for the whole paper. This chunk will be copied in every file.
```{r}
# Pathway color palette
pathway.colors <- tibble(color = c("#EB2030","grey90","#2E358F"), label = c("MMEJ","no_effect","NHEJ"), feature = "pathway_balance")

#Library colors 
library.colors <- tibble(color = c("#E69F03","#56B3E6"), label = c("Chromatin","DNA_repair"),  feature = "library")

#KAT5 example color
KAT5.example <- tibble(color = "#EF6817", label = "KAT5", feature = "example")

#Epistatic interaction colors
slope.colors <- tibble(color = c("#01665e","#f5f5f5","#8c510a"),label = c("negative","none","positive"), feature = "epistasis")

#Inhibitor and protein KO colors
inh.colors <- tibble(color = c("#2A52BE","#2B3035"), label = c("drug","protein"), feature = "inh_KO")

#Four complex selection
complex.colors <- tibble(color = c("#EA3442","#EA5C68","#2E358F","#EA717A"), label = c("NHEJ","FANC_core_complex","MRN_complex","RNF8_RNF168"), feature = "protein_complexes")

#RNF8_RNF168 slope examples
ubq.response.colors <-  tibble(color = c("#1732ef","#179eef","#ef6817","#efd417"), label = c("RNF8_RNF168","H2AK15ub","H2AK15ac","H1ub"), feature = "RNF8_RNF168_example")

# Chromatin correlations
chr.correlation.colors <- tibble(color = c("#009B9E","#F1F1F1","#C75DAB"), label = c("negative","none","positive"), feature = "chromatin_correlation")

#Bind all and plot
paper.palette <- bind_rows(pathway.colors, library.colors,KAT5.example,slope.colors,inh.colors, complex.colors,ubq.response.colors,chr.correlation.colors) 
ggplot(paper.palette) +
  geom_tile(aes(label,"1", fill = color, width = 1)) +
  geom_text(aes(label,"1", label = color)) +
  scale_fill_manual(values = levels(as.factor(paper.palette$color))) +
  facet_wrap(~ feature, scales = "free", nrow = 4, strip.position = "top") +
  theme_bw() +
  theme(legend.position = "none")
```

# Import data tables
```{r libraries}
#detailed table
#ddr
ddr.screen.detail <- readRDS("/home/x.vergara/XV_P3_ChromDSBScreen/xv20201204_agm_ddr_screen/data/xv20210609_screen_ddr_scores.rds")
colnames(ddr.screen.detail)[9] <- "b.rep"
colnames(ddr.screen.detail)[10] <- "t.rep"
ddr.screen.detail$library <- "DNA_repair"
#chromatin
chr.screen.detail <- readRDS("/home/x.vergara/XV_P3_ChromDSBScreen/xv20200421_ChromDSBscreen/data/xv20201014_frozen_chz_scores_mmej.rds")
chr.screen.detail$library <- "Chromatin"

# I think I don't need these ones for this figure
#Control table (WT & POLQ)
#ddr
ddr.screen.controls <- readRDS("/home/x.vergara/XV_P3_ChromDSBScreen/xv20201204_agm_ddr_screen/data/xv20210609_screen_ddr_controls.rds")
colnames(ddr.screen.controls)[9] <- "b.rep"
colnames(ddr.screen.controls)[10] <- "t.rep"
ddr.screen.controls$library <- "DNA_repair"

#chromatin
chr.screen.controls <- readRDS("/home/x.vergara/XV_P3_ChromDSBScreen/xv20200421_ChromDSBscreen/data/xv20201014_frozen_chz_scores_controls.rds")
chr.screen.controls$library <- "Chromatin"


#indel data
indel.data.ddr <- readRDS(file = "/home/x.vergara/XV_P3_ChromDSBScreen/xv20201204_agm_ddr_screen/data/xv20210526_screen_DDR_indel_data.rds")

# Chromatin follow up data
chromatin.followup <- readRDS("/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/data/xv20211005_chromatin_follow_up.rds")

# Chromatin followup mutate IPRscore
chromatin.fup.IPR <- chromatin.followup %>% filter(plate == "P1") %>% dplyr::group_by(well,gene,gRNA,barcode,plate) %>% dplyr::summarise(IPR.z.score = sum(z.score,na.rm = T)/sqrt(n()), count = n())

# Put both screens together
#detailed table with all the variables
both.screen.detail <- bind_rows(ddr.screen.detail, chr.screen.detail) %>% mutate(ID_gene = paste(gene, library, sep = "_")) %>% filter(sample == "KO" & !ID_gene %in% c("DMSO_DNA_repair","LBR_ctrl_DNA_repair"))

both.screen.gene.value.pre <- both.screen.detail %>% select(ID_gene, b.rep, t.rep,barcode, mmej.z.score) %>% 
  mutate(tech.rep = case_when(t.rep == "R5" ~ "R3", t.rep == "R4" ~ "R2", T ~ t.rep)) %>%
  dplyr::group_by(ID_gene,tech.rep) %>% 
  dplyr::summarise(replicate.score = mean(mmej.z.score, na.rm = T)) %>% 
  dplyr::group_by(ID_gene) %>%
  dplyr::mutate(IPR.z.score = sum(replicate.score, na.rm = T)/sqrt(n()))

#Data for plotting reproducibility
both.screen.gene.value <- both.screen.gene.value.pre %>%
  reshape2::dcast(ID_gene ~ tech.rep, value.var = "IPR.z.score") %>% 
  filter(complete.cases(.)) %>% 
  mutate(comb.data = (R1+R2+R3)/sqrt(3))

# Data to call hits
hits.both.screens <- both.screen.gene.value.pre %>% mutate(pathway = case_when(IPR.z.score < -1.95 ~ "MMEJ", IPR.z.score > 1.95 ~ "NHEJ", T ~ "NA"), library = case_when(grepl("DNA", ID_gene) ~ "DNA_repair", grepl("Chromatin", ID_gene) ~ "Chromatin"))

# Filter
per_19IPR_data <- both.screen.detail %>% 
  dplyr::group_by(gene,barcode,library) %>% 
  dplyr::summarise(IPR.z.score = sum(mmej.z.score, na.rm = T)/sqrt(n()), count = n()) %>% ungroup()

#Clone 5 chromatin
clone5_z.score_chrom_tib <- readRDS('/DATA/projects/DSBrepair/data/R/cl20201026_ChIP_zscore_selection.RDS')

#Epistasis analysis
slope.protein.features.all <- readRDS("~/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/data/xv20211230_epistasis_all_genes.rds")

step1.epistasis <- readRDS("~/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/data/xv20211230_epistasis_1_step.rds")
step2.epistasis <- readRDS("~/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/data/xv20211230_epistasis_2_step.rds")

#Inhibitor perturbation data
combined.inhibitor.data.filt <- readRDS(file = "~/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/data/xv20211230_kinase_inhib_effect.rds") 

#Export epistasis interactions
slope.protein.features.inhibitors.filt <- readRDS(file = "~/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/data/xv20211230_kinase_inhib_epistasis.rds")
```

#Main figures

#Figure 1A: Cartoon

#Figure 1B: Diagram

#Figure 1C: MMEJ:NHEJ balance in WT
```{r}
# Filter null distribution
wt.screen.controls <- both.screen.controls %>% select(gene,barcode,t.rep,b.rep,freqCut,MMEJscore, well, plate, library) %>%  filter(gene == "WT")

#Plot distribution MMEJ:NHEJ balance
ggplot(wt.screen.controls %>% 
         mutate(lib_rep = paste0(library,"_",t.rep)))+ 
  geom_density(aes(MMEJscore, group = lib_rep, color = library), linetype = 2) +
  geom_density(aes(MMEJscore, group = library, color = library, fill = library), alpha = 0.3) +
  theme_bw() + xlab("MMEJscore per IPR") + scale_color_manual(values = levels(as_factor(library.colors$color))) + scale_fill_manual(values = levels(as_factor(library.colors$color))) + theme(legend.position = "top")

```

# Figure 1D: Controls and KO
```{r}
# WT & POLQ z-score values
POLQ.control.KO <- both.screen.controls %>% 
  mutate(sample = case_when(gene == "WT" ~ "WT", T ~ "POLQ")) %>%
  bind_rows(both.screen.detail %>%
              mutate(sample = "KO")) %>%
  select(gene, barcode,t.rep,b.rep, mmej.z.score, well, plate, library,sample) %>% 
  mutate(lib_rep = paste0(library,"_",t.rep)) %>% 
  dplyr::group_by(gene, t.rep,b.rep,well,plate,library, lib_rep,sample) %>% 
  dplyr::summarise(mean.mmej = mean(mmej.z.score, na.rm = T))

#Add KO genes as well
ggplot(POLQ.control.KO)+ 
  geom_hline(yintercept = 0, linetype = 2) + 
  geom_quasirandom(aes(paste(sample,library),mean.mmej, color = library)) + 
  theme_bw() + ylab("MMEJscore per IPR (z-score)") + 
  scale_color_manual(values = levels(as_factor(library.colors$color))) + 
  theme(legend.position = "top")
```

# Figure 1E: Correlations
```{r}
# plot correlation (all three correlations)
ggplot(both.screen.gene.value) + 
  geom_abline(linetype = 2) +
  geom_point(aes(R1,R2, color = library)) + 
  theme_bw() + 
  coord_fixed(ylim = c(-10,25), xlim = c(-10,25)) + 
  xlab("MMEJ:NHEJ R1 (z-score)") +
  ylab("MMEJ:NHEJ R2 (z-score)") +
  theme(legend.position = "none") +
  stat_cor(data = both.screen.gene.value, aes(R1,R2), method = "spearman", label.y = 20, label.x = -10, cor.coef.name = "rho") +
  scale_color_manual(values = levels(as_factor(library.colors$color))) 

ggplot(both.screen.gene.value) + 
  geom_abline(linetype = 2) +
  geom_point(aes(R1,R3, color = library)) + 
  theme_bw() + 
  coord_fixed(ylim = c(-10,25), xlim = c(-10,25)) + ylab("MMEJ:NHEJ R3 (z-score)") + xlab("MMEJ:NHEJ R1 (z-score)") +
  theme(legend.position = "none") +
  stat_cor(data = both.screen.gene.value, aes(R1,R3), method = "spearman", label.y = 20, label.x = -10, cor.coef.name = "rho") +
  scale_color_manual(values = levels(as_factor(library.colors$color)))

ggplot(both.screen.gene.value) + 
  geom_abline(linetype = 2) +
  geom_point(aes(R2,R3, color = library)) + 
  theme_bw() + 
  coord_fixed(ylim = c(-10,25), xlim = c(-10,25)) + 
  ylab("MMEJ:NHEJ R2 (z-score)") + xlab("MMEJ:NHEJ R3 (z-score)") +
  theme(legend.position = "none") +
  stat_cor(data = both.screen.gene.value, aes(R2,R3), method = "spearman", label.y = 20, label.x = -10, cor.coef.name = "rho") +
  scale_color_manual(values = levels(as_factor(library.colors$color)))
```

# Number in text

#NOTE: This will change, but every number that I refer in the text will available in this chunk

```{r}
#Mean values
POLQ.control %>%
  dplyr::group_by(gene,library) %>%
  dplyr::summarise(MMEJ.z = mean(mean.mmej, na.rm = T))

#Outlier value
POLQ.control %>%
  filter(gene == "POLQ" & mean.mmej > -3) %>%
  ungroup() %>%
  select(gene,lib_rep,mean.mmej)
```

# Supplementary figures

#Figure S1A: Plate layout

#Figure S1B: Gene editing efficiency density controls
```{r}
# Gene editing differences
ggplot(wt.screen.controls %>% 
         dplyr::group_by(gene, t.rep,b.rep,well,plate,library) %>% 
         dplyr::summarise(mean.cut = mean(freqCut, na.rm = T)) %>% 
         mutate(lib_rep = paste0(library,"_",t.rep))) + 
  geom_density(aes(mean.cut,group = lib_rep, fill = library, color = library), alpha = 0.3) + 
  theme_bw() + xlab("Gene editing frequency in 2nd transfection") +
  scale_fill_manual(values = levels(as_factor(library.colors$color))) +
  scale_color_manual(values = levels(as_factor(library.colors$color)))
```

# Figure S1C: Gene editing correlations
```{r}
#plot
ggplot(both.ge.z.score) + 
  geom_abline(linetype = 2) +
  geom_point(aes(R1,R2, color = library)) + 
  theme_bw() + 
  coord_fixed(ylim = c(-10,10), xlim = c(-10,10)) +
  ylab("Gene editing R2 (z-score)") +
  xlab("Gene editing R1 (z-score)")  +
  stat_cor(data = both.ge.z.score, aes(R1,R2), method = "spearman", label.y = 9, label.x = -9, cor.coef.name = "rho") +
  theme(legend.position = "none") + 
  scale_color_manual(values = levels(as_factor(library.colors$color)))

ggplot(both.ge.z.score) +  
  geom_abline(linetype = 2) +
  geom_point(aes(R1,R3, color = library)) + 
  theme_bw() + 
  coord_fixed(ylim = c(-10,10), xlim = c(-10,10)) +
  ylab("Gene editing R3 (z-score)") +
  xlab("Gene editing R1 (z-score)") +
  stat_cor(data = both.ge.z.score, aes(R1,R3), method = "spearman", label.y = 9, label.x = -9, cor.coef.name = "rho") +
  theme(legend.position = "none") + 
  scale_color_manual(values = levels(as_factor(library.colors$color)))

ggplot(both.ge.z.score) + 
  geom_abline(linetype = 2) +
  geom_point(aes(R2,R3, color = library)) + 
  theme_bw() + 
  coord_fixed(ylim = c(-10,10), xlim = c(-10,10)) +
  ylab("R3 (Gene editing efficiency z-score)") +
  xlab("R2 (Gene editing efficiency z-score") +
  stat_cor(data = both.ge.z.score, aes(R2,R3), method = "spearman", label.y = 9, label.x = -9, cor.coef.name = "rho") +
  theme(legend.position = "none") + 
  scale_color_manual(values = levels(as_factor(library.colors$color)))

```
