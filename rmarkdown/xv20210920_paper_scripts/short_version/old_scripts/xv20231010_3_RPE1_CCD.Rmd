---
title: "xv20230831_CCD_RPE1_validation"
author: "Xabier Vergara"
date: "2023-08-31"
output: html_document
---

Aim: In this file, I will explore some of the possible plots, where I get general conclusions from K562 and RPE1wt data.

```{r setup, include=FALSE}
library(tidyverse)
```

# Import data

```{r}
proteins_gRNA <- readRDS_proof("/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/data/revisions/validation_screen","gRNA_gene") #gRNA gene conversion

#Processed CCD data (4 cell lines)
PRO_CCD <- readRDS_proof("~/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/data/processed_data","PRO_CCD")
DEF_CCD <- readRDS_proof("~/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/data/processed_data","DEF_CCD")
RPE1_CCD <- readRDS_proof("~/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/data/processed_data","RPE1_CCD")
K562_CCD_all <- readRDS_proof("~/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/data/processed_data","Table_S7") %>%
  mutate(cell_line = "K562") %>% 
  select(-screen_position,-DR_effect_type) %>% 
  dplyr::group_by(gene) %>%
  dplyr::mutate(pathway_signif = case_when(sum(CCD_synergy_score < 0) == 0 & sum(CCD_synergy_score > 0) != 0 ~ "NHEJ",
                                    sum(CCD_synergy_score > 0) == 0 & sum(CCD_synergy_score < 0) != 0 ~ "MMEJ",
                                    sum(CCD_synergy_score > 0) != 0 & sum(CCD_synergy_score < 0) != 0 ~ "both",
                                    T ~ "none"),
                n = 19,
                toxicity = "non_toxic")

K562_CCD_validation <- K562_CCD_all %>%
  right_join(proteins_gRNA) %>%
  select(-gRNA)

#Bind all table together
cell_lines_CCD <- bind_rows(PRO_CCD, DEF_CCD, RPE1_CCD,K562_CCD_validation)

#Calculate a toxicity score
viability_data <- readRDS(file= "/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/data/revisions/validation_screen/xv20230908_dna_quantification_viability.rds")

toxic_combinations <- viability_data %>% filter(dna_score < 0.33) %>% ungroup() %>% select(gRNA, cell_line) %>% distinct() %>% mutate(toxic = T)

#Export CCD summary of validation set of proteins
cell_lines_CCD <- all_cell_lines_summary_CCD %>% left_join(toxic_combinations) 
cell_lines_CCD[is.na(cell_lines_CCD$toxic),"toxic"] <- F
write_rds(cell_lines_CCD, file = "/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/data/revisions/validation_screen/xv20230917_CCD_summary_cell_lines.rds")


#All log2_values
PRO_log2 <- readRDS("~/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/data/revisions/validation_screen/xv20230912_log2_balance_chromatin_PRO.rds") %>% left_join(proteins_gRNA) %>% filter(binsize == 2000)
K562_log2 <- readRDS("~/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/data/processed_data/CCD_analysis/xv20220819_log2_MMEJNHEJ_differentials_chromatin_KO.rds") %>% left_join(proteins_gRNA) %>% na.omit()
DEF_log2 <- readRDS("~/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/data/revisions/validation_screen/xv20230911_log2_balance_chromatin_DEF.rds") %>% left_join(proteins_gRNA) %>% filter(reps == 3)
RPE1_log2 <- readRDS("~/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/data/revisions/validation_screen/xv20230916_log2_balance_chromatin_RPE1_5reads.rds") %>% left_join(proteins_gRNA) %>% filter(reps == 3)



#K562 data on proteins in the validation screen
K562_validation_prots <- K562_CCD %>% na.omit() %>% filter(chrom_feature %in% c("H3K4me1","H3K36me3","LMNB1","H3K27me3","H3K27ac","H3K4me2","H3K4me3","H3K9me3","H3K9me2","late_replicating"))

#Export data frame
chromatin_data_RPE1 <- readRDS(file = "/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/data/revisions/validation_screen/xv20230806_DSB_TRIP_pool_chromatin_data.rds")

```

#Load control data
```{r}
#Clone #5 (screen)
k562_control <- readRDS("~/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/data/processed_data/CCD_analysis/xv20220819_screening_raw_data_repair_metrics.rds")

#RPE1 BRCA1/p53 dKO (LBR2)
def_control <- readRDS(file = "/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/data/revisions/validation_screen/xv20230912_DEF_control_data.rds")

#RPE1 p53 KO (halfLBR2)
pro_control <- readRDS(file = "/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/data/revisions/validation_screen/xv20230912_PRO_control_data.rds")

#RPE1 parental (halfLBR2)
rpe_control <- readRDS(file = "/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/data/revisions/validation_screen/xv20230915_RPE1_control_data.rds")

```


#Create a data-frame with LBR2 samples
```{r}
#For K562
K562_wt <- k562_control %>% filter(sample == "WT") %>%
  dplyr::group_by(barcode) %>%
  dplyr::summarise(mean_balance = mean(log2MMEJNHEJratio),
                   mean_TIF = mean(freqCut),
                   reps = n()) %>%
  mutate(cell_line = "K562")

#RPE1 BRCA1/p53 dKO (LBR2)
DEF_wt <- def_control %>% filter(gRNA == "LBR2") %>%
  dplyr::group_by(barcode) %>%
  dplyr::summarise(mean_balance = mean(log2_bal),
                   mean_TIF = 1 - (mean(wt_0/(`del_-7`+ins_1+wt_0))),
                   reps = n()) %>%
  mutate(cell_line = "DEF")

#RPE1 p53 KO (halfLBR2)
PRO_wt <- pro_control %>% filter(gRNA == "halfLBR2") %>%
  dplyr::group_by(barcode) %>%
  dplyr::summarise(mean_balance = mean(log2_bal),
                   mean_TIF = 1 - (mean(wt_0/(`del_-7`+ins_1+wt_0))),
                   reps = n()) %>%
  mutate(cell_line = "PRO")

#RPE1 p53 KO (halfLBR2)
RPE1_wt <- rpe_control %>% filter(gRNA == "halfLBR2") %>%
  dplyr::group_by(barcode) %>%
  dplyr::summarise(mean_balance = mean(log2_bal),
                   mean_TIF = 1 - (mean(wt_0/(`del_-7`+ins_1+wt_0))),
                   reps = n()) %>%
  mutate(cell_line = "RPE1")

#Bind all in the same dataframe
wt_all_cell_lines <- bind_rows(DEF_wt, PRO_wt,RPE1_wt, K562_wt) %>% filter(reps > 2)

#Wilcox test difference
wilcox_test <- wt_all_cell_lines %>%
  rstatix::wilcox_test(mean_balance ~ cell_line)

```

#Global effects: I need to import all the log2 values from K562, PRO and DEF
```{r, fig.width=8, fig.height = 4}
#Combine data files
K562_global_effects <- K562_log2 %>% select(gene, barcode, mean_log2_bal = mean.log2foldchange) %>% mutate(cell_line = "K562")
DEF_global_effects <- DEF_log2 %>% select(gene, barcode, mean_log2_bal = mean_diff) %>% mutate(cell_line = "DEF")
PRO_global_effects <- PRO_log2 %>% select(gene, barcode, mean_log2_bal = mean_diff) %>% mutate(cell_line = "PRO")
RPE_global_effects <- RPE1_log2 %>% select(gene, barcode, mean_log2_bal = mean_diff) %>% mutate(cell_line = "RPE1")

three_cell_lines_log2 <- bind_rows(K562_global_effects, DEF_global_effects, PRO_global_effects,RPE_global_effects)


#Gene order based on all data
gene_list_order <- c("TOPBP1","RBBP8","ATR","SMC5","RAD50","ATM","MDC1","CHEK2","FANCM","FANCD2","FAAP24","FANCG","PARP1","RMI2","BLM","BOD1L1","CHAF1A","BRCC3","BRCA2","POLL")

pdf("/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/export/xv20230307_revision_figures/RPE_PRO_DEF/xv20230917_global_effect_all_cells.pdf",width = 8, height =  4)
ggplot(three_cell_lines_log2 %>% na.omit()) +
  stat_summary(aes(fct_relevel(gene,gene_list_order),mean_log2_bal,fill = fct_relevel(cell_line, c("K562","DEF","PRO","RPE1"))),  position = position_dodge2(preserve = "single"), geom = "bar", fun.data = "mean_sd") + 
#  stat_summary(aes(fct_relevel(gene,combined_order),mean_log2_bal, group = fct_relevel(cell_line, c("PRO","DEF","K562"))), position = position_dodge2(preserve = "single"), geom = "errorbar", fun.data = "mean_sd",width = 0.5) + 
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90,
                                   hjust = 1,
                                   vjust = 0.5),
        legend.position = "top",
        axis.title.x = element_blank()) +
  geom_hline(yintercept = 0, linetype = 2) +
  ylab("∆log2 MMEJ::NHEJ") +
  labs(fill = "Cell line") +
  scale_fill_manual(values = c("grey70","#9f86bf","#95c482","#98bad5"))
dev.off()

```

#Summary of number of M, N and both synregies
```{r, fig.width=3, fig.height=4, message = F}
summary_CCDs <- cell_lines_CCD %>%
  select(gene, cell_line, CCD_model_p_adj, pathway_signif) %>%
  na.omit() %>%
  distinct() %>%
  dplyr::group_by(cell_line) %>%
  dplyr::summarise(M_synergy = sum(CCD_model_p_adj < 0.25 & pathway_signif == "MMEJ"),
                   N_synergy = sum(CCD_model_p_adj < 0.25 & pathway_signif == "NHEJ"),
                   both = sum(CCD_model_p_adj < 0.25 & pathway_signif == "both"))

#Make a summary plot with this
ggplot(summary_CCDs %>% reshape2::melt()) +
  geom_col(aes(fct_relevel(cell_line, c("K562","DEF","PRO","RPE1")),value, fill = fct_relevel(variable, c("M_synergy","both","N_synergy"))), position = "fill") +
  theme_bw() +
  theme(legend.position = "top") +
  labs(fill = "CCD_type") +
  ylab("Frequency of CCD type") +
  xlab("cell_line") +
  scale_fill_manual(values = c("#8C510A","#849223","#01665E"))

```


#Plot M- and N- synergies
```{r, fig.width=5, fig.hetigh = 10}
#Create a data table
tile_plot_dt <- cell_lines_CCD %>% 
  mutate(phenotype = case_when(pathway_signif == "none" | n < 10 ~ "NA",
                               CCD_model_p_adj > 0.25 ~ "no_CCD",
                               CCD_model_p_adj < 0.25 & pathway_signif == "MMEJ" ~ "M_synergy",
                               CCD_model_p_adj < 0.25 & pathway_signif == "NHEJ" ~ "N_synergy",
                               CCD_model_p_adj < 0.25 & pathway_signif == "both" ~ "both_synergy",
                               T ~ "NA")) %>%
  select(gene,cell_line,toxicity,phenotype) %>% distinct()


ggplot(tile_plot_dt) +
  geom_tile(aes(fct_relevel(gene,gene_list_order), fct_relevel(cell_line,c("K562","DEF","PRO","RPE1")), fill = fct_relevel(phenotype, c("M_synergy","N_synergy","both_synergy","no_CCD","not_perturbed","insufficient_data")))) +
    geom_point(data = tile_plot_dt %>% filter(toxicity == "toxic"), aes(gene, fct_relevel(cell_line,c("K562","DEF","PRO","RPE1"))), shape =4) +
  theme_bw() + 
  scale_fill_manual(values = c("#8C510A","#01665E","#849223", "grey70","grey90")) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
  theme(legend.position = "top") +
  labs(fill = "Phenotype",
       y = "Cell_line",
       x = "gene") + 
  coord_fixed(expand = F)

#Manual order
gene_list_order <- c("BRCC3","BRC2","BOD1L1","POLL","CHAF1A","RBBP8","ATM","FANCD2","TOPBP1","MDC1","RAD50","ATR","CHEK2","FANCM","SMC5","FANCG","FAAP24","RMI2","BLM","PARP1")

```

#Figure 3D: Cosine distance calculations (DEF & K562)
```{r,fig.width=5,fig.height=3}
#Calculate cosine distance for PRO
DEF_K562_distance_all <- map_dfr(unique(filtered_CCDs$gene), function(x){
  CCD_table <- filtered_CCDs %>%
    filter(gene == x) %>%
    select(DEF, K562) %>%
    na.omit()
  
  #calculate concordance
  cosine_value <- cosine(as.matrix(CCD_table))[1,2]
  tibble(gene = x, cosine_dist = cosine_value)
})

#Join CCD_scores
DEF_K562_distances_all <- DEF_K562_distance_all %>% dplyr::left_join(DEF_CCD %>% select(gene, gene,CCD_model_p_adj) %>% distinct()) %>% na.omit()

pdf("/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/export/xv20220117_paper_figure_short/figure_3_CCD_other_cell_lines/xv20231010_CCD_cosine_similarity_PRO.pdf", width = 5, height = 3)
ggplot(DEF_K562_distances_all %>% distinct()) +
  geom_col(aes(fct_relevel(gene, gene_list_order),cosine_dist, fill = CCD_model_p_adj < 0.25)) +
  theme_bw() + 
  geom_hline(yintercept = 0, linetype =2) +
  xlab("Proteins with CCDs") + 
  theme_bw() + 
  theme(axis.text.x =  element_text(angle = 90,
                                    hjust = 1,
                                    vjust = 0.5),
        legend.position = "none",
        panel.grid = element_blank()) + 
  ylab("Cosine similarity score") + 
  scale_fill_manual(values = c("grey70", "#9f86bf"))  + 
  coord_cartesian(ylim = c(-1,1))
dev.off()

```



#Figure 3E: Cosine distance calculations
```{r,fig.width=5,fig.height=3}
#Filter chromatin features that are not good
filtered_CCDs <- cell_lines_CCD %>%
  filter(!is.na(gene)) %>%
  reshape2::dcast(gene + chrom_feature ~ cell_line, value.var = "CCD_synergy_score")

#Calculate cosine distance for PRO
PRO_K562_distance_all <- map_dfr(unique(filtered_CCDs$gene), function(x){
  CCD_table <- filtered_CCDs %>%
    filter(gene == x) %>%
    select(PRO, K562) %>%
    na.omit()
  
  #calculate concordance
  cosine_value <- cosine(as.matrix(CCD_table))[1,2]
  tibble(gene = x, cosine_dist = cosine_value)
})

#Join CCD_scores
PRO_DEF_distances_all <- PRO_K562_distance_all %>% dplyr::left_join(PRO_CCD %>% select(gene, gene,CCD_model_p_adj) %>% distinct()) %>% na.omit()

pdf("/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/export/xv20220117_paper_figure_short/figure_3_CCD_other_cell_lines/xv20231010_CCD_cosine_similarity_PRO.pdf", width = 5, height = 3)
ggplot(PRO_DEF_distances_all %>% distinct()) +
  geom_col(aes(fct_relevel(gene, gene_list_order),cosine_dist, fill = CCD_model_p_adj < 0.25)) +
  theme_bw() + 
  geom_hline(yintercept = 0, linetype =2) +
  xlab("Proteins with CCDs") + 
  theme_bw() + 
  theme(axis.text.x =  element_text(angle = 90,
                                    hjust = 1,
                                    vjust = 0.5),
        legend.position = "none",
        panel.grid = element_blank()) + 
  ylab("Cosine similarity score") + 
  scale_fill_manual(values = c("grey70", "#95c482"))  + 
  coord_cartesian(ylim = c(-1,1))
dev.off()

```

#Figure 3F: Cosine distance calculations (RPE1 vs. K562)
```{r,fig.width=5,fig.height=3}
#Filter chromatin features that are not good
filtered_CCDs <- cell_lines_CCD %>%
  filter(!is.na(gene)) %>%
  reshape2::dcast(gene + chrom_feature ~ cell_line, value.var = "CCD_synergy_score")

#Calculate cosine distance for PRO
RPE1_K562_distance_all <- map_dfr(unique(filtered_CCDs$gene), function(x){
  CCD_table <- filtered_CCDs %>%
    filter(gene == x) %>%
    select(RPE1, K562) %>%
    na.omit()
  
  #calculate concordance
  cosine_value <- cosine(as.matrix(CCD_table))[1,2]
  tibble(gene = x, cosine_dist = cosine_value)
})

#Join CCD_scores
RPE1_K562_distances_all <- RPE1_K562_distance_all %>% dplyr::left_join(RPE1_CCD %>% select(gene, gene,CCD_model_p_adj) %>% distinct()) %>% na.omit()

#pdf("/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/export/xv20220117_paper_figure_short/figure_3_CCD_other_cell_lines/xv20231010_CCD_cosine_similarity_PRO.pdf", width = 5, height = 3)
ggplot(RPE1_K562_distances_all %>% distinct()) +
  geom_col(aes(fct_relevel(gene, gene_list_order),cosine_dist, fill = CCD_model_p_adj < 0.25)) +
  theme_bw() + 
  geom_hline(yintercept = 0, linetype =2) +
  xlab("Proteins with CCDs") + 
  theme_bw() + 
  theme(axis.text.x =  element_text(angle = 90,
                                    hjust = 1,
                                    vjust = 0.5),
        legend.position = "top",
        panel.grid = element_blank()) + 
  ylab("Cosine similarity score") + 
  scale_fill_manual(values = c("#98bad5"))  + 
  coord_cartesian(ylim = c(-1,1))
dev.off()

```



#Cosine similarity distribution in DEF cells
```{r, message = F, warning = F}
random_permutation_filtered <- cell_lines_CCD %>%
  filter(!is.na(gene)) %>%
  reshape2::dcast(gene + chrom_feature ~ cell_line, value.var = "CCD_synergy_score")


#Select random pairs from population
DEF_K562_CCDs <- random_permutation_filtered %>% select(gene, K562, DEF, chrom_feature) %>% na.omit()
DEF_K562_cosine_distances <- DEF_K562_CCDs %>%
  dplyr::group_by(gene) %>%
  dplyr::summarise(cosine_dist = cosine(K562, DEF))

#chromatin features used 
RPE1_chrom_features <- unique(DEF_K562_CCDs$chrom_feature)

#Sampling loop to select random samples of equal size as interacting pairs

  random_sample_cosine_values <- map_dfr(c(1:100), function(i){
   set.seed(i)
    K562_genes <- K562_CCD_all %>% filter(CCD_model_p_adj < 0.05) %>% pull(gene) %>% unique() %>% sample(18)
    DEF_genes <- DEF_K562_CCDs %>% pull(gene) %>% unique()
    K562_DEF_table <- tibble(K562_gene = K562_genes, DEF_gene = DEF_genes)
    DEF_data <- DEF_K562_CCDs %>% select(DEF, chrom_feature, DEF_gene = gene)
    K562_CCDs_random <- K562_CCD_all %>% filter(chrom_feature %in% RPE1_chrom_features & gene %in% K562_genes) %>% select(chrom_feature, K562 = CCD_synergy_score, K562_gene = gene)
    K562_CCDs_random_cos <- K562_CCDs_random %>% left_join(K562_DEF_table, by = "K562_gene") %>% left_join(DEF_data, by = c("DEF_gene","chrom_feature")) %>% ungroup() %>% dplyr::group_by(DEF_gene,K562_gene) %>% dplyr::summarise(cos_dist = cosine(K562, DEF)) %>% mutate(seed = i)
  })

#Create density matrices for plotting later
density.matrix.datapoints <- tibble()
for (i in c(1:100)){
  seed.unique <- filter(random_sample_cosine_values, seed == i) %>% pull(cos_dist)%>% as.numeric()
  dens.seed.unique <- density(seed.unique, from = -1, to = 1) %>% tidy() %>% mutate(seed = i) %>% mutate(round_x = round(x, digits = 2)) %>% dplyr::group_by(round_x) %>% dplyr::summarise(mean_y = mean(y), seed = i)
  density.matrix.datapoints <- density.matrix.datapoints %>% bind_rows(dens.seed.unique)
}

#Calculate mean and sd to plot in density plots for random effects
summarise.mean.sd_sample <- density.matrix.datapoints %>% dplyr::group_by(round_x) %>% dplyr::summarise(avg_y = mean(mean_y), sd_y = sd(mean_y), counts = n())

#Calculate real interaction density data
real_density_plot <- density(DEF_K562_cosine_distances %>% na.omit() %>% pull(cosine_dist), from = -1, to = 1) %>% tidy()
```

#Plot cosine similarities
```{r,fig.width=2.75,fig.height=2.5}
#Plot this figure
pdf("/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/export/xv20220117_paper_figure_short/figure_3_CCD_other_cell_lines/xv20231012_DEF_CCD_summary_plot_median.pdf", width = 2.75, height = 2.5)
ggplot(summarise.mean.sd_sample) + 
  geom_ribbon(aes(round_x, ymax = avg_y + sd_y, ymin = avg_y - sd_y), alpha = 0.2, fill = "grey60") +
  geom_line(aes(round_x,avg_y), color = "grey60", linetype = 2) + 
  geom_line(data = real_density_plot, aes(x,y), color = "#9f86bf", size = 1.25) +
    theme_bw() + theme(legend.position = "top") + 
  ylab("Density") + xlab("Cosine distance")
dev.off()

#Calculate empirical test
#Real mean
real_median <- DEF_K562_cosine_distances %>% na.omit() %>% pull(cosine_dist) %>% median()
mean_cosine_similarity <- random_sample_cosine_values %>% 
  dplyr::group_by(seed) %>%
  dplyr::summarise(median_cos = median(cos_dist))

CI_99 <-  quantile(mean_cosine_similarity$median_cos, 0.95)

#Print summary
print(paste("The real distribution has a median of", round(real_median, digits =2), "and the 95th percentile of the random selection has a median value of",round(CI_99,digits = 2),"in RPE1 DEF cells."))

```

##### Calculate for DEF cells
#Cosine similarity distribution in PRO cells
```{r}
random_permutation_filtered <- cell_lines_CCD %>%
  reshape2::dcast(gene + chrom_feature ~ cell_line, value.var = "CCD_synergy_score")


#Select random pairs from population
PRO_K562_CCDs <- random_permutation_filtered %>% select(gene, K562, PRO) %>% na.omit()

#All possible pairs
all_combinations_dt <- tidyr::crossing(PRO_K562_CCDs %>% select(gene),gene, gene) %>% select(-gene) %>% distinct()
colnames(all_combinations_dt) <- c("K562_gene","PRO_gene") #Change column names
filtered_combination <- filter(all_combinations_dt, K562_gene != PRO_gene)

#Calculate all cosine distances
all_posible_combinations <- map2_dfr(all_combinations_dt$K562_gene, all_combinations_dt$PRO_gene, function(x,y){
  K562_set <- filter(PRO_K562_CCDs, gene == x) %>% pull(K562)
  PRO_set <- filter(PRO_K562_CCDs, gene == y) %>% pull(PRO)
  cosine_dist <- as.numeric(cosine(K562_set,PRO_set))
  tibble(gene_K562 = x, gene_PRO = y, cosine_dist = cosine_dist)
})

#Sampling loop to select random samples of equal size as interacting pairs
filtered_cosine_similarity <- filter(all_posible_combinations, gene_K562 != gene_PRO)

  random_sample_cosine_values <- map_dfr(c(1:1000), function(i){
   set.seed(i)
    K562_CCDs_random <- filtered_cosine_similarity %>% sample_n(9) %>% pull(cosine_dist)
    tibble(seed = i, cosine_dist = K562_CCDs_random)
  })

#Create density matrices for plotting later
density.matrix.datapoints <- tibble()
for (i in c(1:1000)){
  seed.unique <- filter(random_sample_cosine_values, seed == i) %>% pull(cosine_dist)%>% as.numeric()
  dens.seed.unique <- density(seed.unique, from = -1, to = 1) %>% tidy() %>% mutate(seed = i) %>% mutate(round_x = round(x, digits = 2)) %>% dplyr::group_by(round_x) %>% dplyr::summarise(mean_y = mean(y), seed = i)
  density.matrix.datapoints <- density.matrix.datapoints %>% bind_rows(dens.seed.unique)
}

#Calculate mean and sd to plot in density plots for random effects
summarise.mean.sd_sample <- density.matrix.datapoints %>% dplyr::group_by(round_x) %>% dplyr::summarise(avg_y = mean(mean_y), sd_y = sd(mean_y), counts = n())

#Calculate real interaction density data
real_density_plot <- density(all_posible_combinations %>% filter(gene_K562 == gene_PRO) %>% na.omit() %>% pull(cosine_dist), from = -1, to = 1) %>% tidy()
```

#Plot cosine similarities
```{r,fig.width=2.75,fig.height=2.5}
#Plot this figure
#pdf("/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/export/xv20220117_paper_figure_short/figure_3_CCD_other_cell_lines/xv20231012_DEF_CCD_summary_plot_median.pdf", width = 2.75, height = 2.5)
ggplot(summarise.mean.sd_sample) + 
  geom_ribbon(aes(round_x, ymax = avg_y + sd_y, ymin = avg_y - sd_y), alpha = 0.2, fill = "grey60") +
  geom_line(aes(round_x,avg_y), color = "grey60", linetype = 2) + 
  geom_line(data = real_density_plot, aes(x,y), color = "#9f86bf", size = 1.25) +
    theme_bw() + theme(legend.position = "top") + 
  ylab("Density") + xlab("Cosine distance")
#dev.off()

#Calculate empirical test
#Real mean
real_median <- all_posible_combinations %>% filter(gene_K562 == gene_PRO) %>% na.omit() %>% pull(cosine_dist) %>% median()
mean_cosine_similarity <- random_sample_cosine_values %>% 
  dplyr::group_by(seed) %>%
  dplyr::summarise(median_cos = median(cosine_dist))

CI_95 <-  quantile(mean_cosine_similarity$median_cos, 0.95)

#Print summary
print(paste("The real distribution has a median of", round(real_median, digits =2), "and the 95th percentile of the random selection has a median value of",round(CI_95,digits = 2),"in RPE1 PRO cells."))

```


#Cosine similarity distribution in PRO cells
```{r}
#Select random pairs from population
DEF_K562_CCDs <- filtered_CCDs %>% select(gene, K562, DEF) %>% na.omit()

#All possible pairs
all_combinations_dt <- tidyr::crossing(DEF_K562_CCDs %>% select(gene),gene, gene) %>% select(-gene) %>% distinct()
colnames(all_combinations_dt) <- c("K562_gene","DEF_gene") #Change column names
filtered_combination <- filter(all_combinations_dt, K562_gene != DEF_gene)

#Calculate all cosine distances
all_posible_combinations <- map2_dfr(all_combinations_dt$K562_gene, all_combinations_dt$DEF_gene, function(x,y){
  K562_set <- filter(DEF_K562_CCDs, gene == x) %>% pull(K562)
  DEF_set <- filter(DEF_K562_CCDs, gene == y) %>% pull(DEF)
  cosine_dist <- as.numeric(cosine(K562_set,DEF_set))
  tibble(gene_K562 = x, gene_DEF = y, cosine_dist = cosine_dist)
})

#Sampling loop to select random samples of equal size as interacting pairs
  random_sample_cosine_values <- map_dfr(c(1:100), function(i){
   set.seed(i)
    K562_CCDs_random <- all_posible_combinations %>% sample_n(18) %>% pull(cosine_dist)
    tibble(seed = i, cosine_dist = K562_CCDs_random)
  })

#Create density matrices for plotting later
density.matrix.datapoints <- tibble()
for (i in c(1:100)){
  seed.unique <- filter(random_sample_cosine_values, seed == i) %>% pull(cosine_dist)%>% as.numeric()
  dens.seed.unique <- density(seed.unique, from = -1, to = 1) %>% tidy() %>% mutate(seed = i) %>% mutate(round_x = round(x, digits = 2)) %>% dplyr::group_by(round_x) %>% dplyr::summarise(mean_y = mean(y), seed = i)
  density.matrix.datapoints <- density.matrix.datapoints %>% bind_rows(dens.seed.unique)
}

#Calculate mean and sd to plot in density plots for random effects
summarise.mean.sd_sample <- density.matrix.datapoints %>% dplyr::group_by(round_x) %>% dplyr::summarise(avg_y = mean(mean_y), sd_y = sd(mean_y), counts = n())

#Calculate real interaction density data
real_density_plot <- density(DEF_K562_distance_all %>% na.omit() %>% pull(cosine_dist), from = -1, to = 1) %>% tidy()
```

#Plot cosine similarities
```{r,fig.width=2.75,fig.height=2.5}
#Plot this figure
pdf("/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/export/xv20230307_revision_figures/RPE_PRO_DEF/xv20230915_PRO_cosine_similarity_stats.pdf", width = 2.75, height = 2.5)
ggplot(summarise.mean.sd_sample) + 
  geom_ribbon(aes(round_x, ymax = avg_y + sd_y, ymin = avg_y - sd_y), alpha = 0.2, fill = "grey60") +
  geom_line(aes(round_x,avg_y), color = "grey60", linetype = 2) + 
  geom_line(data = real_density_plot, aes(x,y), color = "#95c482", size = 1.25) +
    theme_bw() + theme(legend.position = "top") + 
  ylab("Density") + xlab("Cosine distance")
dev.off()

```


#Cosine similarity distribution in PRO cells
```{r}
#Select random pairs from population
PRO_K562_CCDs <- filtered_CCDs %>% select(gene, K562, PRO) %>% na.omit()

#All possible pairs
all_combinations_dt <- tidyr::crossing(PRO_K562_CCDs %>% select(gene),gene, gene) %>% select(-gene) %>% distinct()
colnames(all_combinations_dt) <- c("K562_gene","PRO_gene") #Change column names
filtered_combination <- filter(all_combinations_dt, K562_gene != PRO_gene)

#Calculate all cosine distances
all_posible_combinations <- map2_dfr(all_combinations_dt$K562_gene, all_combinations_dt$PRO_gene, function(x,y){
  K562_set <- filter(PRO_K562_CCDs, gene == x) %>% pull(K562)
  PRO_set <- filter(PRO_K562_CCDs, gene == y) %>% pull(PRO)
  cosine_dist <- as.numeric(cosine(K562_set,PRO_set))
  tibble(gene_K562 = x, gene_PRO = y, cosine_dist = cosine_dist)
})

#Sampling loop to select random samples of equal size as interacting pairs
  random_sample_cosine_values <- map_dfr(c(1:100), function(i){
   set.seed(i)
    K562_CCDs_random <- all_posible_combinations %>% sample_n(18) %>% pull(cosine_dist)
    tibble(seed = i, cosine_dist = K562_CCDs_random)
  })

#Create density matrices for plotting later
density.matrix.datapoints <- tibble()
for (i in c(1:100)){
  seed.unique <- filter(random_sample_cosine_values, seed == i) %>% pull(cosine_dist)%>% as.numeric()
  dens.seed.unique <- density(seed.unique, from = -1, to = 1) %>% tidy() %>% mutate(seed = i) %>% mutate(round_x = round(x, digits = 2)) %>% dplyr::group_by(round_x) %>% dplyr::summarise(mean_y = mean(y), seed = i)
  density.matrix.datapoints <- density.matrix.datapoints %>% bind_rows(dens.seed.unique)
}

#Calculate mean and sd to plot in density plots for random effects
summarise.mean.sd_sample <- density.matrix.datapoints %>% dplyr::group_by(round_x) %>% dplyr::summarise(avg_y = mean(mean_y), sd_y = sd(mean_y), counts = n())

#Calculate real interaction density data
real_density_plot <- density(PRO_K562_distance_all %>% na.omit() %>% pull(cosine_dist), from = -1, to = 1) %>% tidy()
```

#Plot cosine similarities
```{r,fig.width=2.75,fig.height=2.5}
#Plot this figure
pdf("/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/export/xv20230307_revision_figures/RPE_PRO_DEF/xv20230915_PRO_cosine_similarity_stats.pdf", width = 2.75, height = 2.5)
ggplot(summarise.mean.sd_sample) + 
  geom_ribbon(aes(round_x, ymax = avg_y + sd_y, ymin = avg_y - sd_y), alpha = 0.2, fill = "grey60") +
  geom_line(aes(round_x,avg_y), color = "grey60", linetype = 2) + 
  geom_line(data = real_density_plot, aes(x,y), color = "#95c482", size = 1.25) +
    theme_bw() + theme(legend.position = "top") + 
  ylab("Density") + xlab("Cosine distance")
dev.off()

```



#Calculate mean and 95CI
```{r}
mean_per_iteration <- random_sample_cosine_values %>% 
  dplyr::group_by(seed) %>% 
  dplyr::summarise(mean_cosdist = mean(cosine_dist))
  
  
CI_95 <-  quantile(mean_per_iteration$mean_cosdist, 0.99)

print(CI_95)

```

#Cosine similarity distribution in PRO cells
```{r}
#Select random pairs from population
RPE1_K562_CCDs <- filtered_CCDs %>% na.omit()

#All possible pairs
all_combinations_dt <- tidyr::crossing(RPE1_K562_CCDs %>% select(gene),gene, gene) %>% select(-gene) %>% distinct()
colnames(all_combinations_dt) <- c("K562_gene","RPE1_gene") #Change column names
filtered_combination <- filter(all_combinations_dt, K562_gene != RPE1_gene)

#Calculate all cosine distances
all_posible_combinations <- map2_dfr(all_combinations_dt$K562_gene, all_combinations_dt$RPE1_gene, function(x,y){
  K562_set <- filter(RPE1_K562_CCDs, gene == x) %>% pull(K562)
  RPE1_set <- filter(RPE1_K562_CCDs, gene == y) %>% pull(RPE1)
  cosine_dist <- as.numeric(cosine(K562_set,RPE1_set))
  tibble(gene_K562 = x, gene_RPE1 = y, cosine_dist = cosine_dist)
})

#Sampling loop to select random samples of equal size as interacting pairs
  random_sample_cosine_values <- map_dfr(c(1:100), function(i){
   set.seed(i)
    K562_CCDs_random <- all_posible_combinations %>% sample_n(17) %>% pull(cosine_dist)
    tibble(seed = i, cosine_dist = K562_CCDs_random)
  })

#Create density matrices for plotting later
density.matrix.datapoints <- tibble()
for (i in c(1:100)){
  seed.unique <- filter(random_sample_cosine_values, seed == i) %>% pull(cosine_dist)%>% as.numeric()
  dens.seed.unique <- density(seed.unique, from = -1, to = 1) %>% tidy() %>% mutate(seed = i) %>% mutate(round_x = round(x, digits = 2)) %>% dplyr::group_by(round_x) %>% dplyr::summarise(mean_y = mean(y), seed = i)
  density.matrix.datapoints <- density.matrix.datapoints %>% bind_rows(dens.seed.unique)
}

#Calculate mean and sd to plot in density plots for random effects
summarise.mean.sd_sample <- density.matrix.datapoints %>% dplyr::group_by(round_x) %>% dplyr::summarise(avg_y = mean(mean_y), sd_y = sd(mean_y), counts = n())

#Calculate real interaction density data
real_density_plot <- density(RPE1_DEF_distances_all %>% na.omit() %>% pull(cosine_dist), from = -1, to = 1) %>% tidy()
```

#Calculate mean and 95CI
```{r}
mean_per_iteration <- random_sample_cosine_values %>% 
  dplyr::group_by(seed) %>% 
  dplyr::summarise(mean_cosdist = mean(cosine_dist))
  
CI_95 <-  quantile(mean_per_iteration$mean_cosdist, 0.99)

print(CI_95)

```



#Plot cosine similarities
```{r,fig.width=2.75,fig.height=2.5}
#Plot this figure
pdf("/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/export/xv20230307_revision_figures/RPE1_cells/xv20230917_RPE1_cosine_similarity_stats.pdf", width = 2.75, height = 2.5)
ggplot(summarise.mean.sd_sample) + 
  geom_ribbon(aes(round_x, ymax = avg_y + sd_y, ymin = avg_y - sd_y), alpha = 0.2, fill = "grey60") +
  geom_line(aes(round_x,avg_y), color = "grey60", linetype = 2) + 
  geom_line(data = real_density_plot, aes(x,y), color = "#98bad5", size = 1.25) +
    theme_bw() + theme(legend.position = "top") + 
  ylab("Density") + xlab("Cosine distance")
dev.off()

```





#Cosine similarity distribution in PRO cells
```{r}
#Select random pairs from population
DEF_K562_CCDs <- filtered_CCDs %>% select(-PRO) %>% na.omit()

#All possible pairs
all_combinations_dt <- tidyr::crossing(DEF_K562_CCDs %>% select(gene),gene, gene) %>% select(-gene) %>% distinct()
colnames(all_combinations_dt) <- c("K562_gene","DEF_gene") #Change column names
filtered_combination <- filter(all_combinations_dt, K562_gene != DEF_gene)

#Calculate all cosine distances
all_posible_combinations <- map2_dfr(all_combinations_dt$K562_gene, all_combinations_dt$DEF_gene, function(x,y){
  K562_set <- filter(DEF_K562_CCDs, gene == x) %>% pull(K562)
  DEF_set <- filter(DEF_K562_CCDs, gene == y) %>% pull(DEF)
  cosine_dist <- as.numeric(cosine(K562_set,DEF_set))
  tibble(gene_K562 = x, gene_PRO = y, cosine_dist = cosine_dist)
})

#Sampling loop to select random samples of equal size as interacting pairs
  random_sample_cosine_values <- map_dfr(c(1:1000), function(i){
   set.seed(i)
    DEF_CCDs_random <- all_posible_combinations %>% sample_n(16) %>% pull(cosine_dist)
    tibble(seed = i, cosine_dist = DEF_CCDs_random)
  })

#Create density matrices for plotting later
DEF_density.matrix.datapoints <- tibble()
for (i in c(1:1000)){
  seed.unique <- filter(random_sample_cosine_values, seed == i) %>% pull(cosine_dist)%>% as.numeric()
  dens.seed.unique <- density(seed.unique, from = -1, to = 1) %>% tidy() %>% mutate(seed = i) %>% mutate(round_x = round(x, digits = 2)) %>% dplyr::group_by(round_x) %>% dplyr::summarise(mean_y = mean(y), seed = i)
  DEF_density.matrix.datapoints <- DEF_density.matrix.datapoints %>% bind_rows(dens.seed.unique)
}

#Calculate mean and sd to plot in density plots for random effects
DEF_summarise.mean.sd_sample <- DEF_density.matrix.datapoints %>% dplyr::group_by(round_x) %>% dplyr::summarise(avg_y = mean(mean_y), sd_y = sd(mean_y), counts = n())

#Calculate real interaction density data
DEF_real_density_plot <- density(DEF_K562_distance_all %>% na.omit() %>% pull(cosine_dist), from = -1, to = 1) %>% tidy()

```

#Calculate mean and 95CI
```{r}
mean_per_iteration <- random_sample_cosine_values %>% 
  dplyr::group_by(seed) %>% 
  dplyr::summarise(mean_cosdist = mean(cosine_dist))
  
  
CI_95 <-  quantile(mean_per_iteration$mean_cosdist, 0.99)

print(CI_95)

```

#Plot cosine similarities
```{r,fig.width=2.75,fig.height=2.5}
#Plot this figure
pdf("/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/export/xv20230307_revision_figures/RPE_PRO_DEF/xv20230915_DEF_cosine_similarity_stats.pdf", width = 2.75, height = 2.5)
ggplot(DEF_summarise.mean.sd_sample) + 
  geom_ribbon(aes(round_x, ymax = avg_y + sd_y, ymin = avg_y - sd_y), alpha = 0.2, fill = "grey60") +
  geom_line(aes(round_x,avg_y), color = "grey60", linetype = 2) + 
  geom_line(data = DEF_real_density_plot, aes(x,y), color = "#9f86bf", size = 1.5) +
    theme_bw() + theme(legend.position = "top") + 
  ylab("Density") + xlab("Cosine distance")
dev.off()

```


#Cosine distance calculations
```{r, fig.height=3, fig.width=7, warning=F}
#Calculate cosine distance for PRO
DEF_K562_distance_all <- map_dfr(unique(filtered_CCDs$gene), function(x){
  CCD_table <- filtered_CCDs %>%
    filter(gene == x) %>%
    select(DEF, K562) %>%
    na.omit()
  
  #calculate concordance
  cosine_value <- cosine(as.matrix(CCD_table))[1,2]
  tibble(gene = x, cosine_dist = cosine_value)
})

#Join CCD_scores
K562_DEF_distances_all <- DEF_K562_distance_all %>% dplyr::left_join(DEF_CCD %>% select(gene, gRNA,fdr)) 

pdf("/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/export/xv20230307_revision_figures/RPE_PRO_DEF/xv20230915_CCD_cosine_similarity_DEF.pdf", width = 7, height = 3)
ggplot(K562_DEF_distances_all %>% distinct()) +
  geom_col(aes(fct_relevel(gene, gene_list_order),cosine_dist, fill = fdr < 0.25)) +
  theme_bw() + 
  geom_hline(yintercept = 0, linetype =2) +
  xlab("Proteins with CCDs") + 
  theme_bw() + 
  theme(axis.text.x =  element_text(angle = 90,
                                    hjust = 1,
                                    vjust = 0.5)) + 
  ylab("Cosine similarity score") + 
  scale_fill_manual(values = c("grey70", "#9f86bf")) + 
  coord_cartesian(ylim = c(-1,1))
dev.off()

```

#Calculate mean cosine similarity scores
```{r, message=F}
all_cell_line_combination <- expand.grid(c("K562","PRO","DEF","RPE1"),c("K562","PRO","DEF","RPE1")) %>% select(cell1 = Var1, cell2 = Var2)

#Mean cosine_similarity score
mean_cosine_similarity <- map2_dfr(all_cell_line_combination$cell1, all_cell_line_combination$cell2, function(x,y) {
  comp_cl_1 <- filtered_CCDs %>% select(a = x, gene, chrom_feature)
  comp_cl_2 <- filtered_CCDs %>% select(b = y,gene,chrom_feature)
  comparison_cell_lines <- comp_cl_1 %>% left_join(comp_cl_2)
  all_cosine <- map_dfr(unique(comparison_cell_lines$gene), function(z){
    CCD_table <- comparison_cell_lines %>%
      filter(gene == z) %>%
      na.omit() %>%
      select(-gene, -chrom_feature)
    
    #calculate concordance
    cosine_value <- as.numeric(cosine(as.matrix(CCD_table)))
    tibble(gene = z, cosine_dist = cosine_value)
    })
  mean_cosine <- tibble(cell_line1 = x, cell_line2 = y, mean_cosine = mean(all_cosine$cosine_dist, na.rm =T))
})
```


```{r, fig.width=3,fig.height=3}
#Plot
pdf("/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/export/xv20220117_paper_figure_short/figure_3_CCD_other_cell_lines/xv20230917_similarity_all_cell_lines.pdf", width = 3, height = 3)
ggplot(mean_cosine_similarity) + 
     geom_tile(aes(fct_relevel(cell_line1,c("K562","DEF","PRO","RPE1")), fct_relevel(cell_line2,c("K562","DEF","PRO","RPE1")), fill = mean_cosine))+ 
     theme_bw() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1), legend.position = "top") + 
     coord_fixed(expand = F,ratio = 1) + scale_fill_gradient2(low = "#af8dc3", mid = "#f7f7f7", high = "#7fbf7b", limits = c(-1,1)) + 
     geom_text(aes(fct_relevel(cell_line1,c("K562","DEF","PRO","RPE1")), fct_relevel(cell_line2,c("K562","DEF","PRO","RPE1")),label = round(mean_cosine, digits = 2))) + theme(axis.title = element_blank()) + labs(fill = "Cosine similarity")
dev.off()

```

#Plot some examples
```{r, fig.width=4,fig.height=4}
#Modify cell lines
RPE1_modified <- RPE1wt_log2 %>% 
  filter(binsize == 2000) %>%
  select(barcode,gRNA, gene, mean_diff, H3K4me1 = chip_H3K4me1, H3K36me3 = chip_H3K36me3, H3K27me3 = dam_H3K27me3, LMNB1 = dam_LMNB1, H3K9me2 = dam_H3K9me2, late_replicating, H3K9me3 = dam_H3K9me3) %>% 
  mutate(cell_line = "RPE1")

DEF_modified <- DEF_log2 %>% 
  filter(binsize == 2000) %>%
  select(barcode,gRNA, gene, mean_diff, H3K4me1 = chip_H3K4me1, H3K36me3 = chip_H3K36me3, H3K27me3 = dam_H3K27me3, LMNB1 = dam_LMNB1,H3K9me2 = dam_H3K9me2, late_replicating, H3K9me3 = dam_H3K9me3) %>% 
  mutate(cell_line = "DEF")

#K562_modified_data
K562_modified <- K562_log2 %>% 
  select(barcode,gRNA, gene, mean_diff=mean.log2foldchange, H3K4me1, H3K36me3, H3K27me3, LMNB1,H3K9me2, late_replicating, H3K9me3) %>% 
  mutate(cell_line = "K562")

#K562_modified_data
PRO_modified <- PRO_log2 %>% 
  filter(binsize == 2000) %>%
  select(barcode,gRNA, gene, mean_diff, H3K4me1 = chip_H3K4me1, H3K36me3 = chip_H3K36me3, H3K27me3 = dam_H3K27me3, LMNB1 = dam_LMNB1,H3K9me2 = dam_H3K9me2, late_replicating, H3K9me3 = dam_H3K9me3) %>% 
  mutate(cell_line = "PRO")

#Generate a data frame for both
combined <- bind_rows(RPE1_modified, K562_modified, DEF_modified, PRO_modified)

```

#Plot ATM-KO
```{r, fig.width=4, fig.height=4}
#Plot ATM-KO vs. LMNB1
#ATMko and LMNB1
pdf(file = "/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/export/xv20230307_revision_figures/RPE_PRO_DEF/xv20230918_ATM_LMNB1.pdf", width = 3, height = 3)
ggplot(combined %>% filter(gene == "ATM" & cell_line != "PRO"),aes(LMNB1, mean_diff, color = cell_line)) +
  geom_point(size = 3) +
  geom_smooth(method = "lm", se = F) +
  geom_hline(yintercept = 0, linetype = 2) +
  theme_bw() +
  ylab("∆log2 MMEJ::NHEJ ATM-KO") +
  theme(legend.position = "top") +
  scale_color_manual(values = c("#9f86bf","grey70","#98bad5"))
dev.off()

#ATMko and H3K9me3
pdf(file = "/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/export/xv20230307_revision_figures/RPE_PRO_DEF/xv20230918_ATM_K9me3.pdf", width = 3, height = 3)
ggplot(combined %>% filter(gene == "ATM" & cell_line != "PRO"),aes(H3K9me3, mean_diff, color = cell_line)) +
  geom_point(size = 3) +
  geom_smooth(method = "lm", se = F) +
  geom_hline(yintercept = 0, linetype = 2) +
  theme_bw() +
  ylab("∆log2 MMEJ::NHEJ ATM-KO") +
  theme(legend.position = "top") +
  scale_color_manual(values = c("#9f86bf","grey70","#98bad5"))
dev.off()

#ATMko and H3K9me2

ggplot(combined %>% filter(gene == "ATM"),aes(H3K9me2, mean_diff, color = cell_line)) +
  geom_point(size = 3) +
  geom_smooth(method = "lm", se = F) +
  geom_hline(yintercept = 0, linetype = 2) +
  theme_bw() +
  ylab("∆log2 MMEJ::NHEJ ATM-KO") +
  theme(legend.position = "top") +
  scale_color_manual(values = c("#9f86bf","grey70","#95c482","#98bad5"))

#ATMko and H3K9me2
pdf(file = "/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/export/xv20230307_revision_figures/RPE_PRO_DEF/xv20230918_ATM_repli.pdf", width = 3, height = 3)
ggplot(combined %>% filter(gene == "ATM" & cell_line != "PRO"),aes(late_replicating, mean_diff, color = cell_line)) +
  geom_point(size = 3) +
  geom_smooth(method = "lm", se = F) +
  geom_hline(yintercept = 0, linetype = 2) +
  theme_bw() +
  ylab("∆log2 MMEJ::NHEJ ATM-KO") +
  theme(legend.position = "top") +
  scale_color_manual(values = c("#9f86bf","grey70","#98bad5"))
dev.off()
```


```{r}
ggplot(combined %>% filter(gene == "MDC1"),aes(H3K9me2, mean_diff, color = cell_line)) +
  geom_point(size = 3) +
  geom_smooth(method = "lm", se = F) +
  geom_hline(yintercept = 0, linetype = 2) +
  theme_bw() +
  ylab("∆log2 MMEJ::NHEJ ATM-KO") +
  theme(legend.position = "top") +
  scale_color_manual(values = c("#9f86bf","grey70","#95c482","#98bad5"))



#FANCD2ko and LMNB1
ggplot(combined %>% filter(gene == "FANCD2"),aes(LMNB1, mean_diff, color = cell_line)) +
  geom_point(size = 3) +
  geom_smooth(method = "lm", se = F) +
  geom_hline(yintercept = 0, linetype = 2) +
  theme_bw() +
  ylab("∆log2 MMEJ::NHEJ")+
  theme(legend.position = "top")

ggplot(combined %>% filter(gene == "POLL"),aes(H3K36me3, mean_diff, color = cell_line)) +
  geom_point(size = 3) +
  geom_smooth(method = "lm", se = F) +
  geom_hline(yintercept = 0, linetype = 2) +
  theme_bw() +
  ylab("∆log2 MMEJ::NHEJ")+
  theme(legend.position = "top")


```
