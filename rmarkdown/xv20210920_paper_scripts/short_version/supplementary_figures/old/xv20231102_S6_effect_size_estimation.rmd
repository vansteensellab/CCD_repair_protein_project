---
title: "xv20220712_S5_effect_size_estimation"
author: "x.vergara"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output:
  html_document:
    theme: journal #cerulean
    highlight: monochrome
    toc: true
    toc_float: true
    code_folding: show
  editor_options:
    chunk_output_type: console
---
# Script to generate figure S5 in the short version of the paper.

Fig. S5: Estimation of genome-wide dynamic ranges of chromatin features. A) All the parameters needed for dynamic range estimation of the 25 high quality chromatin features. In grey, distribution of genome-wide chromatin scores, with the 99% confidence interval (99CI) marked by the horizontal black lines (top 0.5% and bottom 0.5%). In red, chromatin scores of all 19 IPRs in clone 5 for which MMEJ:NHEJ balance was measured in the screen (in this hypothetical example 19 random data points).

```{r functions, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(root.dir = '/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/rmarkdown/xv20210920_paper_scripts/short_version/knit_html/')

StartTime <-Sys.time()
library(knitr)

# 8-digit Date tag:
Date <- substr(gsub("-","",Sys.time()),1,8)

#Change in.dir accordingly
in.dir <- "/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/"

#Check if output contain datetag
saveRDS_proof <- function(object, file) {
  document_path <- rstudioapi::getSourceEditorContext()$path %>% str_split(pattern = "/") %>% unlist()
  document_name <- document_path[length(document_path)]
  sys_time <- Sys.time()
  if (grepl(Date, file) == T) {
    write(c(document_name, as.character(sys_time),"Output", correct_file), file = paste0(in.dir,"log"), ncolumns = 4, sep = "\t", append = T)
    saveRDS(object, file)
  }
  else {
    print("Incorrect datetag!")
  }
}

#Read rds check through different versions
readRDS_proof <- function(path, pat) {
  full.path <- paste0(in.dir, path)
  document_path <- rstudioapi::getSourceEditorContext()$path %>% str_split(pattern = "/") %>% unlist()
  document_name <- document_path[length(document_path)]
  sys_time <- Sys.time()
  
  if(file.exists(full.path) == T){
    if(paste0(in.dir,path) != getwd()){
      setwd(paste0(in.dir, path))
  }
    file.list <- list.files(pattern = pat)
    correct_file <- str_sort(file.list, decreasing = T)[1]
    print(correct_file)
    write(c(document_name,as.character(sys_time) ,"Input", correct_file), file = paste0(in.dir,"log"), ncolumns = 4, sep = "\t", append = T)
    readRDS(correct_file)
    
  }
  else{
  setwd(path)
  file.list <- list.files(pattern = pat)
  correct_file <- str_sort(file.list, decreasing = T)[1]
  print(correct_file)
  write(c(document_name, as.character(sys_time),"Input", correct_file),file = paste0(in.dir,"log"), ncolumns = 4, sep = "\t", append = T)
  readRDS(correct_file)
  }
}
```


# Libraries
```{r libraries, warning=FALSE, message=FALSE}
# libraries:
library(tidyverse)
library(ggrepel)
library(pheatmap)
library(rstatix)
library(stats)
library(tibble)
library(reshape2)
library(ggbeeswarm)
```

# Import data tables
```{r import, warning=FALSE,message=FALSE}
setwd(in.dir)

print("For this script the following data was inputed:")
#Clone 5 chromatin Version cl20201026
clone5_z.score_chrom_tib <- readRDS_proof("/DATA/projects/DSBrepair/data/R","cl20201026_ChIP_zscore_selection")

#Import TIF ratio measurements per replicate
TIF.ddr.screen.all.sel <- readRDS_proof( "data/processed_data/CCD_analysis","raw_data_TIF")

#Import mean value measurements
global_diff_TIF <- readRDS_proof( "data/processed_data/CCD_analysis","diff_TIF")

# heatmap chromatin order
heatmap.chromatin.order <- c("HDAC3","LMNB1","late_replicating","H3K9me2","H3K9me3","HDAC1","EZH2","H3K27me3","CTCF","SMC3","m5C","HDAC2","POL2","POL2AS2","H3K36me3","TTseq","Dam","H3K79me2","H2AFZ","DNAse","H3K4me3","H4K5acK8ac","H3K4me1","H3K27ac","H3K4me2")

clone5_bc_cluster <-  c("CATCCACCACACTTCA","ATATCGTTGCTGGAGA","GTACCTCTCGATAGTG","TCTTTTGAGGAGCTGA","CATTTCTGATCAATAA","TGGCCAATATTTGTCT","ACTGTCGAGTTGTCCG","GAGCGCGTCACCGGGT","GCGCACCCTTTAATTG","ACCCCTAAAGGCGCTG","CGGCCTGAAGGTCAGG","AGAAAATAATATGACG","TTGAACGCGGGCTCGG","CCGGGGACGTATGCAC","GCTAACATCACGAATC","ATACTATATTTAACGG","TATGGCTGTCGGGTAG","AGGGCGTAAAATATTT","TGTCCCTTAGTACTTT")

# Individual data point (intermediate step)
step2.epistasis <- readRDS_proof("data/processed_data/CCD_analysis","log2_MMEJNHEJ_differentials_chromatin_KO")

#DNA repair CCDs
table_S3_CCDs  <- readRDS_proof("data/processed_data","Table_S7")


```

#Supplementary Figures

#Figure S5A:

A) All the parameters needed for dynamic range estimation of the 25 high quality chromatin features. In grey, distribution of genome-wide chromatin scores, with the 99% confidence interval (99CI) marked by the horizontal black lines (top 0.5% and bottom 0.5%). In red, chromatin scores of all 19 IPRs in clone 5 for which MMEJ:NHEJ balance was measured in the screen (in this hypothetical example 19 random data points).
```{r Fig_S6_A}
chromatin_features_plot <-  clone5_z.score_chrom_tib %>% reshape2::melt(id.vars = c("pool","ID","binsize"))

##95% CI for each feature
CI99_chromatin_features <- chromatin_features_plot %>% dplyr::group_by(variable) %>% dplyr::summarise(CI0.5 = quantile(value, 0.005), CI99.5 = quantile(value, 0.995), range = CI99.5 - CI0.5, mean = mean(value))

#Plot S7A:  Chromatin ranges
ggplot(chromatin_features_plot) + 
  geom_violin(aes(fct_relevel(variable, heatmap.chromatin.order), value), fill = "grey70", color = "black") + theme_bw() + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))+ 
  geom_quasirandom(data = chromatin_features_plot %>% filter(ID %in% clone5_bc_cluster), aes(fct_relevel(variable, heatmap.chromatin.order), value), color = "red", size = 1)  + 
  geom_errorbar(data = CI99_chromatin_features, aes(x = variable,ymin = CI0.5, ymax = CI99.5), color = "black", width = 0.5) 
```

#Calculate global effect RAD50
```{r, fig.width=2,fig.height=3}
pdf("/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/export/xv20220117_paper_figure_short/supplementary_figures/figure_S7_effect_size/xv20231102_RAD50_global_example.pdf",width = 2, height = 3)
ggplot(step2.epistasis %>% 
         dplyr::filter(gene %in% c("RAD50")),
       aes(gene, mean.log2foldchange)) + 
  geom_quasirandom() +
  stat_summary(geom = "errorbar",fun.min = mean, fun = mean, fun.max = mean, color = "red", size = 1, width = 0.5) +
  theme_bw() + ylab("∆log2MMEJ:NHEJ RAD50 KO") + theme(legend.position = "none") +
  theme(panel.grid = element_blank()) + ylim(c(-1.5,0.25)) +
  geom_hline(yintercept = 0, linetype =2 )
dev.off()
```

#correlation
```{r, fig.width=4,fig.height=3}

# Plot RAD50 with LMNB1
pdf("/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/export/xv20220117_paper_figure_short/supplementary_figures/figure_S7_effect_size/xv20231102_RAD50_global_example_CCD_delta.pdf",width = 4, height = 3)
ggplot() + 
  geom_segment(aes(x = -2, xend = 2.7,y = -1.0064 - 0.1143*2.7, yend = -1.0064 - 0.1143*2.7), color = "grey60", linetype = 3) +
  geom_segment(aes(x = -2, xend = -1.64,y = -1.0064 - 0.1143*-1.64, yend = -1.0064 - 0.1143*-1.64), color = "grey60", linetype = 3) +
  geom_segment(aes(x = -2, xend = -2,y = -1.0064 - 0.1143*-1.64, yend = -1.0064 - 0.1143*2.7), color = "red", linetype = 2) +
  geom_segment(aes(x = -1.64, xend = -1.64, y = -1.0064 - 0.1143*-1.64+0.05, yend = -1.0064 - 0.1143*-1.64-0.05),color = "#8c510a", size = 1.5)  +
  geom_segment(aes(x = 2.7, xend = 2.7, y = -1.0064 - 0.1143*2.7+0.05, yend = -1.0064 - 0.1143*2.7-0.05),color = "#8c510a", size = 1.5) +
  geom_segment(aes(x = -1.64, xend = 2.7,y = -1.0064 - 0.1143*-1.64, yend = -1.0064 - 0.1143*2.7),color = "#8c510a", linetype = 2) +

  geom_smooth(data = step2.epistasis %>% 
         dplyr::filter(gene %in% c("RAD50")),
       aes(LMNB1,mean.log2foldchange),
       method = "lm", se = F, color = "#8c510a", size = 1.5) +
  geom_point(data = step2.epistasis %>% 
         dplyr::filter(gene %in% c("RAD50")),
       aes(LMNB1,mean.log2foldchange)) +
  theme_bw() + ylab("∆log2MMEJ:NHEJ RAD50 KO") + theme(legend.position = "none") +
  theme(panel.grid = element_blank()) + ylim(c(-1.5,0.25)) + xlim(c(-2,3)) + geom_hline(yintercept = 0, linetype =2)
dev.off()

```

#Column plot with both global and CCD ∆log2
```{r, fig.width= 2, fig.height=3}
RAD50_example <- tibble(effect = c("CCD","Global"), log2MMEJNHEJ = c(0.4954,1.025))

#Plot
pdf("/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/export/xv20220117_paper_figure_short/supplementary_figures/figure_S7_effect_size/xv20231102_RAD50_abs_estimation.pdf",width = 2, height = 3)
ggplot(RAD50_example) +
  geom_col(aes(effect, log2MMEJNHEJ)) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.title.x = element_blank()) + 
  ylab("abs(∆log2MMEJ:NHEJ)")
dev.off()


```

B) Calculate TIF and possible confounding factors
#Figure S1B: Total indel frequency

```{r, fig.width=4, fig.height=4}
balance.ratio.list <- TIF.ddr.screen.all.sel %>% 
  reshape2::dcast(gene + barcode + sample + well + plate ~ rep, value.var = "log2TIFratio") %>% 
  arrange(sample)  # Reshape data and arrange by sample for visualization


# Plot reproducibility DNA_repair library
#R1 vs. R2 (Fig. S1B)
pdf("/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/export/xv20220117_paper_figure_short/supplementary_figures/figure_S7_effect_size/xv20231102_TIF_corplor_R1_R2.pdf",width = 4, height = 4)
ggplot(dcast_TIF %>% select(R1,R2,sample) %>% na.omit()) + 
  geom_point(aes(R1,R2, color = fct_relevel(sample,c("WT","POLQ"))))+ 
  geom_smooth(aes(R1,R2), method = "lm")+ 
  xlab("R1 (log2 TIF)") + ylab("R2 (log2 TIF)") + 
  theme_bw() + stat_cor(aes(R1,R2), label.y = -3, label.x = -0.5) +
  scale_color_manual(values = c("#949DCF","#465584","#DADADA")) +
  theme(legend.position = "top",
        panel.grid = element_blank()) + coord_fixed( xlim = c(-3.5,3.5), ylim = c(-3.5,3.5))
dev.off()

#R1 vs. R3 (Fig. S1C)
pdf("/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/export/xv20220117_paper_figure_short/supplementary_figures/figure_S7_effect_size/xv20231102_TIF_corplor_R1_R3.pdf",width = 4, height = 4)
ggplot(dcast_TIF  %>% select(R1,R3,sample) %>% na.omit()) + 
  geom_point(aes(R1,R3, color = fct_relevel(sample,c("WT","POLQ","KO"))))+ 
  geom_smooth(aes(R1,R3), method = "lm")+ 
  xlab("R1 (log2 TIF))") + ylab("R3 (log2 TIF)") + 
  theme_bw() + stat_cor(aes(R1,R3), label.y = -3, label.x = -0.5) +
  scale_color_manual(values = c("#949DCF","#465584","#DADADA")) +
  theme(legend.position = "top",
        panel.grid = element_blank()) + coord_fixed( xlim = c(-3.5,3.5), ylim = c(-3.5,3.5))
dev.off()

#R2 vs. R3 (Fig. S1D)
pdf("/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/export/xv20220117_paper_figure_short/supplementary_figures/figure_S7_effect_size/xv20231102_TIF_corplor_R2_R3.pdf",width = 4, height = 4)
ggplot(dcast_TIF  %>% select(R3,R2,sample) %>% na.omit()) + 
  geom_point(aes(R2,R3, color = fct_relevel(sample,c("WT","POLQ","KO"))))+ 
  geom_smooth(aes(R2,R3), method = "lm")+ 
  xlab("R2 (log2 TIF))") + ylab("R3 (log2 TIF)") + 
  theme_bw() + stat_cor(aes(R2,R3), label.y = -3, label.x = -0.5) +
  scale_color_manual(values = c("#949DCF","#465584","#DADADA")) +
  theme(legend.position = "top",
        panel.grid = element_blank()) + coord_fixed( xlim = c(-3.5,3.5), ylim = c(-3.5,3.5))

dev.off()
```
#Plot volcano plot
```{r, fig.width=4,fig.height=3.5}
# Save the Volcano plot as a PDF file with specific dimensions
pdf(
  "/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/export/xv20220117_paper_figure_short/supplementary_figures/figure_S7_effect_size/xv20231102_volcano_plot_TIF.pdf",
  width = 5,  # Set the width of the PDF
  height = 3.5  # Set the height of the PDF
)

# Create a Volcano plot using ggplot and global_diff_TIF data
ggplot(global_diff_TIF %>% filter(DR_effect_type %in% c("CCD"))) + 
  geom_point(aes(mean.diff.TIF, -log10(p.adj), color = pathway_involved)) +  # Add points using specified aesthetics
  geom_hline(yintercept = -log10(0.001), linetype = 2) +  # Add horizontal line at -log10(0.001)
  geom_vline(xintercept = 0, linetype = 2) +  # Add vertical line at x = 0
  geom_text_repel(
    data = subset(global_diff_TIF %>% filter(DR_effect_type %in% c("CCD")), mean.diff.TIF < -0.25),
    aes(mean.diff.TIF, -log10(p.adj), label = gene)
  ) +  # Add text labels for genes with mean.diff.TIF < -0.25
  geom_text_repel(
    data = subset(global_diff_TIF %>% filter(DR_effect_type %in% c("CCD")), mean.diff.TIF > 0.25),
    aes(mean.diff.TIF, -log10(p.adj), label = gene)
  ) +  # Add text labels for genes with mean.diff.TIF > 0.25
  theme_bw() +  # Set the plot theme to a black and white theme
  xlab("∆log2TIF") +  # Set the x-axis label
  ylab("-log10FDR") +  # Set the y-axis label
  theme(
    panel.grid = element_blank(),  # Remove panel gridlines
    legend.position = "top"  # Position the legend at the top
  ) +
  coord_cartesian(xlim = c(-0.6, 0.6)) +  # Set the x-axis limits
  scale_color_manual(values = c("#894E13", "#00635A"))  # Set manual color values

# Close the PDF device after plotting
dev.off()
```

#Plot how many proteins affect TIF
```{r, fig.width=2, fig.height=3}
table_effect_numbers <- mean.diff.TIF.export %>%
  filter(DR_effect_type == "CCD") %>%
  mutate(TIF_effect = case_when(p.adj < 0.001 & mean.diff.TIF > 0 ~ "Increase",
                                p.adj < 0.001 & mean.diff.TIF < 0 ~ "Decrease",
                                T ~ "No_effect"))


pdf("/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/export/xv20220117_paper_figure_short/supplementary_figures/figure_S7_effect_size/xv20231102_number_proteins.pdf",width = 2, height = 3)
ggplot(table_effect_numbers) +
  geom_bar(aes(fct_relevel(TIF_effect, c("Decrease","No_effect","Increase")))) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
        axis.title.x = element_blank())
dev.off()


```



#Plot difference between pathways
```{r, fig.width=2,fig.height=3}
# Plot TIF differences by effect
pdf("/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/export/xv20220117_paper_figure_short/supplementary_figures/figure_S7_effect_size/xv20231102_pathway_test.pdf",width = 2, height = 3)
ggplot(mean.diff.TIF.export %>% filter(DR_effect_type %in% c("CCD")), aes(pathway_involved,mean.diff.TIF)) + 
  geom_hline(yintercept = 0, linetype = 2) +
  geom_quasirandom(aes(color = pathway_involved)) + 
  theme_bw() +
  theme(legend.position = "top",
        axis.title.x = element_blank(),
        panel.grid = element_blank()) +
    scale_color_manual(values = c("#894E13", "#00635A")) +
  ylab("∆log2TIF")
dev.off()

wilcox_test <- mean.diff.TIF.export %>% 
  filter(DR_effect_type %in% c("CCD")) %>%
  wilcox_test(mean.diff.TIF ~ pathway_involved)

print(wilcox_test)
```
