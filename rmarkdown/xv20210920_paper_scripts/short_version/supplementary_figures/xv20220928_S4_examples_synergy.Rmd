---
title: "xv20220712_S4_examples_synergies"
author: "x.vergara"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output:
  html_document:
    theme: journal #cerulean
    highlight: monochrome
    toc: true
    toc_float: true
    code_folding: show
  editor_options:
    chunk_output_type: console
---
# Script to generate Supplementary Figure 4

Fig. S4: Examples of linear fit correlation with individual chromatin features.

Examples of three proteins with significant CCDs on individual chromatin features. All correlation plots show data of the 19 IPRs (n = 3), the linear regression fit, and regression analysis parameters that are relevant for the synergy score. (R = Pearson correlation coefficient, p.value = two-sided p value of the correlation coefficient, slope = slope of the linear fit, synergy score = final value of CCD interaction be-tween protein and chromatin feature after corrections). Color scheme of the figure shows if the protein - chromatin feature has an M-synergy (brown), N-synergy (green) or no synergy (black). 

```{r, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(root.dir = '/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/rmarkdown/xv20210920_paper_scripts/short_version/knit_html/')

StartTime <-Sys.time()
library(knitr)

# 8-digit Date tag:
Date <- substr(gsub("-","",Sys.time()),1,8)

#Change in.dir accordingly
in.dir <- "/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/"

#Check if output contain datetag
saveRDS_proof <- function(object, file) {
  document_path <- rstudioapi::getSourceEditorContext()$path %>% str_split(pattern = "/") %>% unlist()
  document_name <- document_path[length(document_path)]
  sys_time <- Sys.time()
  if (grepl(Date, file) == T) {
    write(c(document_name, as.character(sys_time),"Output", correct_file), file = paste0(in.dir,"log"), ncolumns = 4, sep = "\t", append = T)
    saveRDS(object, file)
  }
  else {
    print("Incorrect datetag!")
  }
}

#Read rds check through different versions
readRDS_proof <- function(path, pat) {
  full.path <- paste0(in.dir, path)
  document_path <- rstudioapi::getSourceEditorContext()$path %>% str_split(pattern = "/") %>% unlist()
  document_name <- document_path[length(document_path)]
  sys_time <- Sys.time()
  
  if(file.exists(full.path) == T){
    if(paste0(in.dir,path) != getwd()){
      setwd(paste0(in.dir, path))
  }
    file.list <- list.files(pattern = pat)
    correct_file <- str_sort(file.list, decreasing = T)[1]
    print(correct_file)
    write(c(document_name,as.character(sys_time) ,"Input", correct_file), file = paste0(in.dir,"log"), ncolumns = 4, sep = "\t", append = T)
    readRDS(correct_file)
    
  }
  else{
  setwd(path)
  file.list <- list.files(pattern = pat)
  correct_file <- str_sort(file.list, decreasing = T)[1]
  print(correct_file)
  write(c(document_name, as.character(sys_time),"Input", correct_file),file = paste0(in.dir,"log"), ncolumns = 4, sep = "\t", append = T)
  readRDS(correct_file)
  }
}
```


# Libraries
```{r libraries, warning=FALSE, message=FALSE}
# libraries:
library(tidyverse)
library(ggrepel)
library(pheatmap)
library(rstatix)
library(stats)
library(tibble)
library(reshape2)
library(ggpubr)
```



# Import data tables
```{r import, warning=FALSE, message=FALSE}
setwd(in.dir)

print("For this script the following data was inputed:")

#Import MMEJ:NHEJ balance ratio measurements per replicate
step2.epistasis <- readRDS_proof( "data/processed_data/CCD_analysis/","log2_MMEJNHEJ_differentials_chromatin")

#z-score replicate
fit.z.scores.ratio.mean <- readRDS_proof( "data/processed_data/CCD_analysis","z_test_final")

```


# Figure S4A

```{r Fig_S4_A, warning=FALSE, message=FALSE}
# Plot BRCA2 with H3K4me1
signif_barcode_BRCA2_MMEJ <- fit.z.scores.ratio.mean %>% filter(mean.z.score.IPR < -1.95, gene == "BRCA2") %>% pull(barcode)
signif_barcode_BRCA2_NHEJ <- fit.z.scores.ratio.mean %>% filter(mean.z.score.IPR > 1.95, gene == "BRCA2") %>% pull(barcode)
ggplot(step2.epistasis %>% 
         filter(gene %in% c("BRCA2")),
       aes(H3K4me1,mean.log2foldchange)) + 
  geom_point() +
  geom_smooth(aes(color = 0.14),method = "lm") +
  stat_cor(label.x = -1.5, label.y = 0.4) +
  scale_color_gradient2(low = "#8c510a",mid = "#f5f5f5", high = "#01665e", limits = c(-0.15,0.15)) +
  geom_point(data = . %>% filter(barcode %in% signif_barcode_BRCA2_MMEJ), aes(H3K4me1,mean.log2foldchange), size = 4, color = "#8c510a") +
  geom_point(data = . %>% filter(barcode %in% signif_barcode_BRCA2_NHEJ), aes(H3K4me1,mean.log2foldchange), size = 4, color = "#01665e") +
  theme_bw() + ylab("log2(BRCA2 FC MMEJ:NHEJ balance)") + theme(legend.position = "none")
```
A) N-synergy between BRCA2 and H3K4me1.

# Figure S4B
```{r Fig_S4_B, message=FALSE, warning=FALSE}
# Plot BRCA2 with H3K9me2
signif_barcode_BRCA2_MMEJ <- fit.z.scores.ratio.mean %>% filter(mean.z.score.IPR < -1.95, gene == "BRCA2") %>% pull(barcode)
signif_barcode_BRCA2_NHEJ <- fit.z.scores.ratio.mean %>% filter(mean.z.score.IPR > 1.95, gene == "BRCA2") %>% pull(barcode)

ggplot(step2.epistasis %>% 
         filter(gene %in% c("BRCA2")),
       aes(H3K9me2,mean.log2foldchange)) + 
  geom_point() +
  geom_smooth(color = "black",method = "lm") +
  stat_cor(label.x = -1.5, label.y = 0.4) +
  scale_color_gradient2(low = "#8c510a",mid = "#f5f5f5", high = "#01665e", limits = c(-0.15,0.15)) +
  geom_point(data = . %>% filter(barcode %in% signif_barcode_BRCA2_MMEJ), aes(H3K9me2,mean.log2foldchange), size = 4, color = "#8c510a") +
  geom_point(data = . %>% filter(barcode %in% signif_barcode_BRCA2_NHEJ), aes(H3K9me2,mean.log2foldchange), size = 4, color = "#01665e") +
  theme_bw() + ylab("log2(BRCA2 FC MMEJ:NHEJ balance)") + theme(legend.position = "none")
```
B) No synergy between BRCA2 and H3K9me2. This interaction is explained by the absence of the chromatin feature and therefore is discarded (favor NHEJ and slope < 0). 

# Figure S4C
```{r Fig_S4_C, message=FALSE, warning=FALSE}
# Plot RAD50 with LMNB1
signif_barcode_RAD50_MMEJ <- fit.z.scores.ratio.mean %>% filter(mean.z.score.IPR < -1.95, gene == "RAD50") %>% pull(barcode)
signif_barcode_RAD50_NHEJ <- fit.z.scores.ratio.mean %>% filter(mean.z.score.IPR > 1.95, gene == "RAD50") %>% pull(barcode)

# Plot RAD50 with H3K4me3
ggplot(step2.epistasis %>% 
         filter(gene %in% c("RAD50")),
       aes(H3K4me3,mean.log2foldchange)) + 
  geom_point() +
  geom_smooth(color = "black",method = "lm") +
  stat_cor(label.x = -0.5, label.y = -0.7) +
    geom_point(data = . %>% filter(barcode %in% signif_barcode_RAD50_MMEJ), aes(H3K4me3,mean.log2foldchange), size = 4, color = "#8c510a") +
    geom_point(data = . %>% filter(barcode %in% signif_barcode_RAD50_NHEJ), aes(H3K4me3,mean.log2foldchange), size = 4, color = "#01665e") +
  theme_bw() + ylab("log2(RAD50 FC MMEJ:NHEJ balance)") + theme(legend.position = "none")
```
C) No synergy between RAD50 and H3K4me3. Same as for B applies here (favor MMEJ and slope > 0). 

# Figure S4D
```{r Fig_S4_D, warning=FALSE, message=FALSE}
# Plot RAD50 with LMNB1
signif_barcode_RAD50_MMEJ <- fit.z.scores.ratio.mean %>% filter(mean.z.score.IPR < -1.95, gene == "RAD50") %>% pull(barcode)
signif_barcode_RAD50_NHEJ <- fit.z.scores.ratio.mean %>% filter(mean.z.score.IPR > 1.95, gene == "RAD50") %>% pull(barcode)

ggplot(step2.epistasis %>% 
         filter(gene %in% c("RAD50")),
       aes(LMNB1,mean.log2foldchange)) + 
  geom_point() +
  geom_smooth(color = "#8c510a" ,method = "lm") +
  stat_cor(label.x = -1.5, label.y = -0.7) +
  geom_point(data = . %>% filter(barcode %in% signif_barcode_RAD50_MMEJ), aes(LMNB1,mean.log2foldchange), size = 4, color = "#8c510a") +
    geom_point(data = . %>% filter(barcode %in% signif_barcode_RAD50_NHEJ), aes(LMNB1,mean.log2foldchange), size = 4, color = "#01665e") +
  theme_bw() + ylab("log2(RAD50 FC MMEJ:NHEJ balance)") + theme(legend.position = "none")
```
D) M-synergy between RAD50 and interactions with the nuclear lamina (LMNB1). 

# Figure S4E
```{r Fig_S4_E, warning=FALSE, message=FALSE}
# Plot BRCA2 with H3K36me3
signif_barcode_BOD1L_MMEJ <- fit.z.scores.ratio.mean %>% filter(mean.z.score.IPR < -1.95, gene == "BOD1L1") %>% pull(barcode)
signif_barcode_BOD1L_NHEJ <- fit.z.scores.ratio.mean %>% filter(mean.z.score.IPR > 1.95, gene == "BOD1L1") %>% pull(barcode)


ggplot(step2.epistasis %>% 
         filter(gene %in% c("BOD1L1")),
       aes(H3K4me1,mean.log2foldchange)) + 
  geom_point() +
  geom_smooth(aes(color = 0.14),method = "lm") +
  stat_cor(label.x = -1.5, label.y = 0.4) +
  scale_color_gradient2(low = "#8c510a",mid = "#f5f5f5", high = "#01665e", limits = c(-0.15,0.15)) +
  geom_point(data = . %>% filter(barcode %in% signif_barcode_BOD1L_MMEJ), aes(H3K4me1,mean.log2foldchange), size = 4, color = "#8c510a") +
  geom_point(data = . %>% filter(barcode %in% signif_barcode_BOD1L_NHEJ), aes(H3K4me1,mean.log2foldchange), size = 4, color = "#01665e") +
  theme_bw() + ylab("log2(BOD1L FC MMEJ:NHEJ balance)") + theme(legend.position = "none")
```
E) N-synergy between BOD1L and H3K4me1. 

# Figure S4F
```{r Fig_S4_F, message=FALSE, warning=FALSE}
signif_barcode_BOD1L_MMEJ <- fit.z.scores.ratio.mean %>% filter(mean.z.score.IPR < -1.95, gene == "BOD1L1") %>% pull(barcode)
signif_barcode_BOD1L_NHEJ <- fit.z.scores.ratio.mean %>% filter(mean.z.score.IPR > 1.95, gene == "BOD1L1") %>% pull(barcode)

# Plot BRCA2 with H3K36me3
ggplot(step2.epistasis %>% 
         filter(gene %in% c("BOD1L1")),
       aes(late_replicating,mean.log2foldchange)) + 
  geom_point() +
  geom_smooth(aes(color = -0.14),method = "lm") +
  stat_cor(label.x = -1.5, label.y = 0.4) +
  scale_color_gradient2(low = "#8c510a",mid = "#f5f5f5", high = "#01665e", limits = c(-0.15,0.15)) +
  geom_point(data = . %>% filter(barcode %in% signif_barcode_BOD1L_MMEJ), aes(late_replicating,mean.log2foldchange), size = 4, color = "#8c510a") +
  geom_point(data = . %>% filter(barcode %in% signif_barcode_BOD1L_NHEJ), aes(late_replicating,mean.log2foldchange), size = 4, color = "#01665e") +
  theme_bw() + ylab("log2(BOD1L FC MMEJ:NHEJ balance)") + theme(legend.position = "none")
```
F) M-synergy between BOD1L and late replicating chromatin. 

 