---
title: "xv20220117_1_General_effects"
author: "x.vergara"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output:
  html_document:
    theme: journal #cerulean
    highlight: monochrome
    toc: true
    toc_float: true
    code_folding: show
  editor_options:
    chunk_output_type: console
---
# Script to generate Figure 1

Fig. 1. Multiplexed CRISPR screen to assess chromatin context-dependencies of DNA repair proteins.

```{r functions, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(root.dir = '/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/rmarkdown/xv20210920_paper_scripts/short_version/knit_html/')

StartTime <-Sys.time()
library(knitr)

# 8-digit Date tag:
Date <- substr(gsub("-","",Sys.time()),1,8)

#Change in.dir accordingly
in.dir <- "/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/"

#Check if output contain datetag
saveRDS_proof <- function(object, file) {
  document_path <- rstudioapi::getSourceEditorContext()$path %>% str_split(pattern = "/") %>% unlist()
  document_name <- document_path[length(document_path)]
  sys_time <- Sys.time()
  if (grepl(Date, file) == T) {
    write(c(document_name, as.character(sys_time),"Output", correct_file), file = paste0(in.dir,"log"), ncolumns = 4, sep = "\t", append = T)
    saveRDS(object, file)
  }
  else {
    print("Incorrect datetag!")
  }
}

#Read rds check through different versions
readRDS_proof <- function(path, pat) {
  full.path <- paste0(in.dir, path)
  document_path <- rstudioapi::getSourceEditorContext()$path %>% str_split(pattern = "/") %>% unlist()
  document_name <- document_path[length(document_path)]
  sys_time <- Sys.time()
  
  if(file.exists(full.path) == T){
    if(paste0(in.dir,path) != getwd()){
      setwd(paste0(in.dir, path))
  }
    file.list <- list.files(pattern = pat)
    correct_file <- str_sort(file.list, decreasing = T)[1]
    print(correct_file)
    write(c(document_name,as.character(sys_time) ,"Input", correct_file), file = paste0(in.dir,"log"), ncolumns = 4, sep = "\t", append = T)
    readRDS(correct_file)
    
  }
  else{
  setwd(path)
  file.list <- list.files(pattern = pat)
  correct_file <- str_sort(file.list, decreasing = T)[1]
  print(correct_file)
  write(c(document_name, as.character(sys_time),"Input", correct_file),file = paste0(in.dir,"log"), ncolumns = 4, sep = "\t", append = T)
  readRDS(correct_file)
  }
}
```

# Libraries
```{r libraries, warning=FALSE, message=FALSE}
# libraries:
library(tidyverse)
library(ggrepel)
library(pheatmap)
library(rstatix)
library(stats)
library(tibble)
library(reshape2)
library(ggbreak)
library(patchwork)
```

# Import data tables
```{r import, warning=FALSE, message=FALSE}
setwd(in.dir)
#Clone 5 chromatin Version cl20201026
clone5_z.score_chrom_tib <- readRDS_proof("/DATA/projects/DSBrepair/data/R","ChIP_zscore_selection")

#Data frame to extract barcode information
log2_diff_IPR <- readRDS_proof("data/processed_data/CCD_analysis", "log2_MMEJNHEJ_differentials_chromatin_KO")

#log2 fold change
global_CCDs <- readRDS_proof( "data/processed_data/CCD_analysis","global_diff_MMEJNHEJ")

#summary plot
table_S7_CCDs <- readRDS_proof( "data/processed_data/","Table_S7")

# heatmap chromatin order
heatmap.chromatin.order <- c("HDAC3","LMNB1","late_replicating","H3K9me2","H3K9me3","HDAC1","EZH2","H3K27me3","CTCF","SMC3","m5C","HDAC2","POL2","POL2AS2","H3K36me3","TTseq","Dam","H3K79me2","H2AFZ","DNAse","H3K4me3","H4K5acK8ac","H3K4me1","H3K27ac","H3K4me2")
```

# Figure 1A
(A) Overview of screen design. See main text for explanation.

# Figure 1B
```{r Fig_1_B,  warning=FALSE, message=FALSE}
table_S7_CCDs_filtered <- table_S7_CCDs %>% dplyr::select(gene, global_diff,global_p_adj) %>% distinct()

# Highlight three complexes
FA_core_complex <- tibble(gene = c("FANCL","FANCA","FANCB","FANCC","FANCE","FANCF","FANCG","FANCM","FAAP24","FAAP100","FANCD2","FANCI"), complex = "FA_proteins")
MRN_complex <- tibble(gene = c("MRE11","RAD50","NBN"), complex = "MRN_complex")
DNA_ligase_complex <- tibble(gene = c("LIG4","XRCC4","NHEJ1"), complex = "DNA_ligase_complex")

#Complexes to be highlighted in text
highlight.complex <- bind_rows(FA_core_complex,DNA_ligase_complex,MRN_complex)

#Proteins highlighted in the text
prots.highlighted <- c("POLL","LIG4","NHEJ1","MRE11","NBN","RBBP8","POLQ","RAD50","FANCA","RBX1","FANCF","FANCM","SHLD1")

# Plot and highlight main findings
ggplot(global_CCDs) + 
     geom_point(aes(mean.balance.diff,-log10(p.adj), color = complex), color = "grey60") + 
     geom_point(data = global_CCDs %>% right_join(highlight.complex), aes(mean.balance.diff,-log10(p.adj), color = complex), size = 2) + 
     geom_vline(xintercept = 0, linetype = 2) + geom_hline(yintercept = -log10(0.001), linetype = 2) +
     geom_text_repel(data = subset(global_CCDs, gene %in% prots.highlighted), aes(mean.balance.diff,-log10(p.adj), label = gene),max.overlaps = Inf, box.padding = 0.5) +
     ylab("-log10(FDR)") + xlab("Global ∆log2(MMEJ:NHEJ) score") + scale_x_continuous(breaks = c(-1,-0.5,0, 0.5,1, 1.5,2), limits = c(-1.1,2.1)) + scale_color_manual( values = c("#00635A","#C09C77","#894E13")) + scale_x_break(c(0.3,1.9), expand = F) + theme_bw() + theme(legend.position = "top")

# Source data table
fig1b <- global_CCDs %>%
  select(identifier_gene = gene, x_meanbalance = mean.balance.diff, y_padj = p.adj) %>%
  mutate(figure = "Figure_1B")

write.table(fig1b, file = "/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/export/xv20220117_paper_figure_short/source_data/xv20240417_sourcedata_fig1b.txt", row.names = F)

```
(B) Volcano-plot of global ∆log2MMEJ:NHEJ scores (mean value of 19 IPRs). Horizontal dotted line shows significance threshold (FDR = 0.001). Labels mark proteins highlighted in the text.

# Figure 1C
```{r Fig_1_C,  warning=FALSE, message=FALSE}
#Extract barcodes in DR screen
clone5_bc <- log2_diff_IPR %>% pull(barcode) %>% unique()
# Prepare data frame
clone_5_IPR <- filter(clone5_z.score_chrom_tib, ID %in% clone5_bc) %>% dplyr::select(-pool,-binsize) %>% column_to_rownames(var = "ID")

#pheatmap
clone_5_heatmap <- pheatmap(clone_5_IPR, silent = T)

#Cluster IPRs by features
clone5_bc_cluster <- rownames(clone_5_IPR[clone_5_heatmap$tree_row[["order"]],])

write.table(clone5_bc_cluster, file = "~/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/data/processed_data/figures/xv20220927_barcode_clustering.txt")

#dt for plotting
clone_5_IPR_melt <- clone_5_IPR %>% rownames_to_column(var = "barcode") %>% melt(value.name = "chrom.z.score", var.name = "feature")

#Plot
ggplot(clone_5_IPR_melt) + 
  geom_tile(aes(fct_relevel(barcode, clone5_bc_cluster),fct_relevel(variable,heatmap.chromatin.order), fill = chrom.z.score)) +
  scale_fill_gradient2( low = "#009B9E",mid = "#F1F1F1", high = "#C75DAB")  + theme_bw() + theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5), axis.title = element_blank(), legend.position = "top") + coord_fixed(expand = F,ratio = 0.75)

# Source data table
fig1c <- clone_5_IPR_melt %>%
  select(x_IPR = barcode, y_chromatin = variable, fill_score = chrom.z.score) %>%
  mutate(figure = "Figure_1C")

write.table(fig1c, file = "/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/export/xv20220117_paper_figure_short/source_data/xv20240417_sourcedata_fig1c.txt", row.names = F)
```
(C) Heatmap of levels of 25 chromatin fea-tures at the 19 IPR sites. Four major chromatin states and their defining features are higlighted in dis-tinct colors.