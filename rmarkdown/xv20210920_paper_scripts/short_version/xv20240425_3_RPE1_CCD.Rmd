---
title: "xv20240425_3_RPE1_validation_data"
author: "x.vergara"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output:
  html_document:
    theme: journal #cerulean
    highlight: monochrome
    toc: true
    toc_float: true
    code_folding: show
  editor_options:
    chunk_output_type: console
---

# Script to generate Figure 3

Fig. 3. CCDs of DNA repair proteins in RPE-1 cells. 

```{r functions, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(root.dir = '/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/rmarkdown/xv20210920_paper_scripts/short_version/knit_html/')

StartTime <-Sys.time()
library(knitr)

# 8-digit Date tag:
Date <- substr(gsub("-","",Sys.time()),1,8)

#Change in.dir accordingly
in.dir <- "/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/"

#Check if output contain datetag
saveRDS_proof <- function(object, file) {
  document_path <- rstudioapi::getSourceEditorContext()$path %>% str_split(pattern = "/") %>% unlist()
  document_name <- document_path[length(document_path)]
  sys_time <- Sys.time()
  if (grepl(Date, file) == T) {
    saveRDS(object, file)
    #write(c(document_name, as.character(sys_time),"Output", correct_file), file = paste0(in.dir,"log"), ncolumns = 4, sep = "\t", append = T)
  }
  else {
    print("Incorrect datetag!")
  }
}

#Read rds check through different versions
readRDS_proof <- function(path, pat) {
  full.path <- paste0(in.dir, path)
  document_path <- rstudioapi::getSourceEditorContext()$path %>% str_split(pattern = "/") %>% unlist()
  document_name <- document_path[length(document_path)]
  sys_time <- Sys.time()
  
  if(file.exists(full.path) == T){
    if(paste0(in.dir,path) != getwd()){
      setwd(paste0(in.dir, path))
  }
    file.list <- list.files(pattern = pat)
    correct_file <- str_sort(file.list, decreasing = T)[1]
    print(correct_file)
    readRDS(correct_file)
    #write(c(document_name,as.character(sys_time) ,"Input", correct_file), file = paste0(in.dir,"log"), ncolumns = 4, sep = "\t", append = T)
    
  }
  else{
  setwd(path)
  file.list <- list.files(pattern = pat)
  correct_file <- str_sort(file.list, decreasing = T)[1]
  print(correct_file)
  readRDS(correct_file)
  #write(c(document_name, as.character(sys_time),"Input", correct_file),file = paste0(in.dir,"log"), ncolumns = 4, sep = "\t", append = T)
  }
}
```

# Libraries
```{r setup,, warning=FALSE, message=FALSE}
library(tidyverse)
library(lsa)
library(reshape2)
library(ggrepel)
library(broom)
```

# Import data tables
```{r, warning=FALSE, message=FALSE}
proteins_gRNA <- readRDS_proof("/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/data/revisions/validation_screen","gRNA_gene") #gRNA gene conversion

#Processed CCD data (4 cell lines)
PRO_CCD <- readRDS_proof("~/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/data/processed_data","PRO_CCD")
DEF_CCD <- readRDS_proof("~/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/data/processed_data","DEF_CCD")
K562_CCD_all <- readRDS_proof("~/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/data/processed_data","Table_S7") %>%
  mutate(cell_line = "K562") %>% 
  select(-screen_position,-DR_effect_type) %>% 
  dplyr::group_by(gene) %>%
  dplyr::mutate(pathway_signif = case_when(sum(CCD_synergy_score < 0) == 0 & sum(CCD_synergy_score > 0) != 0 ~ "NHEJ",
                                    sum(CCD_synergy_score > 0) == 0 & sum(CCD_synergy_score < 0) != 0 ~ "MMEJ",
                                    sum(CCD_synergy_score > 0) != 0 & sum(CCD_synergy_score < 0) != 0 ~ "both",
                                    T ~ "none"),
                n = 19,
                toxicity = "non_toxic")

K562_CCD_validation <- K562_CCD_all %>%
  right_join(proteins_gRNA) %>%
  select(-gRNA)

#Bind all table together
cell_lines_CCD <- bind_rows(PRO_CCD, DEF_CCD,K562_CCD_validation)

#All log2_values
PRO_log2 <- readRDS_proof("~/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/data/processed_data/CCD_validation_RPE1/","PRO_differentials")
DEF_log2 <- readRDS_proof("~/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/data/processed_data/CCD_validation_RPE1/","DEF_differentials")

#Bind both data frames
DEF_PRO_log2 <- bind_rows(PRO_log2, DEF_log2)

#K562 data on proteins in the validation screen
K562_validation_prots <- K562_CCD_validation %>% na.omit() %>% filter(chrom_feature %in% c("H3K4me1","H3K36me3","LMNB1","H3K27me3","H3K27ac","H3K4me2","H3K4me3","H3K9me3","H3K9me2","late_replicating"))

#Export data frame
chromatin_data_RPE1 <- readRDS(file = "/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/data/revisions/validation_screen/xv20230806_DSB_TRIP_pool_chromatin_data.rds")

#log2 chromatin values
#All log2_values
PRO_log2_chrom <- readRDS_proof("~/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/data/processed_data/CCD_validation_RPE1/","PRO_log2")
DEF_log2_chrom <- readRDS_proof("~/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/data/processed_data/CCD_validation_RPE1/","DEF_log2")

#Bind both data frames
DEF_PRO_log2_chrom <- bind_rows(PRO_log2_chrom, DEF_log2_chrom)

#Chromatin concordance
chromatin_concordance <- DEF_PRO_log2_chrom %>% select(-gene,-gRNA,-mean.log2foldchange, -n_rep, -binsize, - dam_LMNB2) %>% distinct() %>% melt() %>% mutate(chrom_feature = str_extract(variable, "(H3|l|L).*"))

#Filter out chromatin 
filter_out_chromatin <- chromatin_concordance %>% filter(value > 0.5) %>% dplyr::group_by(cell_line, chrom_feature) %>% dplyr::summarise(IPR_n = n()) %>% filter(IPR_n < 3)

```

# Figure 3A
```{r Fig_3A, fig.width=3, fig.height=4, warning=FALSE, message=FALSE}
# Prepare data table for plotting Figure 3A and 3B
PRO_DEF_dcast <- cell_lines_CCD %>% 
  filter(cell_line %in% c("PRO","DEF","K562")) %>%
  select(gene, cell_line, global_diff) %>%
  distinct() %>%
  reshape2::dcast(gene ~ cell_line,value.var = "global_diff") %>%
  na.omit() %>% 
  mutate(highlight = case_when(gene %in% c("POLL","BRCA2") ~ "NHEJ",
                               gene %in% c("FANCM","RBBP8","RAD50","ATM","MDC1") ~ "MMEJ",
                               T ~ "none"))

#Calculate correlation with two gene with differential effects
#pdf("/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/export/xv20220117_paper_figure_short/figure_3_CCD_other_cell_lines/xv20231013_Fig3A_correlation_global_effects.pdf",width = 3, height =  4)
ggplot(PRO_DEF_dcast, aes(K562, PRO)) + 
  geom_smooth(method= "lm", se = F, color = "grey30") +
  geom_point(aes(color = highlight)) +
  ggpubr::stat_cor(method = "spearman", label.x = -1.75) + 
  geom_hline(yintercept = 0, linetype = 2) +
  geom_vline(xintercept = 0, linetype = 2) +
  theme_bw() + 
  coord_fixed(ylim = c(-2,2), xlim = c(-2,2), expand = T) + xlab("∆log2 MMEJ::NHEJ DEF") +
  ylab("∆log2 MMEJ::NHEJ PRO") +
  theme(legend.position = "none",
        panel.grid = element_blank()) +
  geom_text_repel(data = PRO_DEF_dcast %>% filter(gene %in% c("ATM","MDC1","POLL","RAD50","RBBP8","BRCA2","FANCM")),
                  aes(label = gene)) +
  scale_color_manual(values = c("#8C510A","#01665E","grey70"))
#dev.off()

# Source data table
fig3a <- PRO_DEF_dcast %>% 
  select(x_K562 = K562, y_RPE1p53KO = PRO) %>%
  mutate(figure = "Figure_3A")

write.table(fig3a, file = "/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/export/xv20220117_paper_figure_short/source_data/xv20240417_sourcedata_fig3a.txt", row.names = F)
```
(A) Scatter plot of global ∆log2MMEJ:NHEJ scores in RPE-1 p53KO (y-axis) and K562 (x-axis). Spearman’s rho and two-sided p-value of the correlation are shown in the graph. Proteins highlighted in the text are shown in brown (M-synergy) or in green (N-synergy). 


# Figure 3B
```{r, fig.width=3, fig.height=4, warning=FALSE, message=FALSE}
#Calculate correlation with two gene with differential effects
#pdf("/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/export/xv20220117_paper_figure_short/figure_3_CCD_other_cell_lines/xv20231013_Fig3B_correlation_global_effects.pdf",width = 3, height =  4)
ggplot(PRO_DEF_dcast, aes(DEF, PRO)) + 
  geom_smooth(method= "lm", se = F, color = "grey30") +
  geom_point(aes(color = highlight)) +
  ggpubr::stat_cor(method = "spearman", label.x = -1.75) + 
  geom_hline(yintercept = 0, linetype = 2) +
  geom_vline(xintercept = 0, linetype = 2) +
  theme_bw() + 
  coord_fixed(ylim = c(-2,2), xlim = c(-2,2), expand = F) + xlab("∆log2 MMEJ::NHEJ DEF") +
  ylab("∆log2 MMEJ::NHEJ PRO") +
  theme(legend.position = "none",
        panel.grid = element_blank()) +
  geom_text_repel(data = PRO_DEF_dcast %>% filter(gene %in% c("ATM","MDC1","POLL","RAD50","RBBP8","BRCA2","FANCM")),
                  aes(label = gene)) +
  scale_color_manual(values = c("#8C510A","#01665E","grey70"))
#dev.off()

# Source data table
fig3b <- PRO_DEF_dcast %>% 
  select(x_RPE1p53BRCA1dKO = DEF, y_RPE1p53KO = PRO) %>%
  mutate(figure = "Figure_3B")

write.table(fig3b, file = "/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/export/xv20220117_paper_figure_short/source_data/xv20240417_sourcedata_fig3b.txt", row.names = F)
```
(B) Same as in A but for RPE-1 p53KO (y-axis) and RPE-1 p53/BRCA1dKO (y-axis).

# Figure 3C
```{r, fig.width=5, fig.hetigh = 10, warning=FALSE, message=FALSE}
#Create a data table
tile_plot_dt <- cell_lines_CCD %>% 
  filter(cell_line != "RPE1") %>%
  mutate(phenotype = case_when(pathway_signif == "none" | n < 10 ~ "NA",
                               CCD_model_p_adj > 0.25 & pathway_signif == "MMEJ" ~ "non_signif_M_synergy",
                               CCD_model_p_adj > 0.25 & pathway_signif == "NHEJ" ~ "non_signif_N_synergy",
                               CCD_model_p_adj < 0.25 & pathway_signif == "MMEJ" ~ "M_synergy",
                               CCD_model_p_adj < 0.25 & pathway_signif == "NHEJ" ~ "N_synergy",
                               CCD_model_p_adj < 0.25 & pathway_signif == "both" ~ "both_synergy",
                               T ~ "NA")) %>%
  select(gene,cell_line,toxicity,phenotype) %>% distinct()

#Manual order
gene_list_order <- c("POLL","BRCC3","BRCA2","CHAF1A","BOD1L1","ATM","FANCD2","MDC1","RAD50","CHEK2","SMC5","FANCG","FAAP24","RMI2","BLM","PARP1","FANCM","ATR","RBBP8","TOPBP1")


#pdf("/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/export/xv20220117_paper_figure_short/figure_3_CCD_other_cell_lines/xv20231027_Fig3C_CCD_phenotype_per_gene.pdf", width = 5, height = 10)
ggplot(tile_plot_dt) +
  geom_tile(aes(fct_relevel(gene,gene_list_order), fct_relevel(cell_line,c("K562","PRO","DEF")), fill = fct_relevel(phenotype, c("M_synergy","N_synergy","both_synergy","no_CCD","not_perturbed","insufficient_data")))) +
    geom_point(data = tile_plot_dt %>% filter(toxicity == "toxic"), aes(gene, fct_relevel(cell_line,c("K562","PRO","DEF"))), shape =4) +
  theme_bw() + 
  scale_fill_manual(values = c("#8C510A","#01665E","#849223","grey90","#D0B294","#A6B7B4")) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
  theme(legend.position = "top") +
  labs(fill = "Phenotype",
       y = "Cell_line",
       x = "gene") + 
  coord_fixed(expand = F,ratio = 1.5)
#dev.off()

fig3c <- tile_plot_dt %>% 
  select(x_gene = gene, y_celltype = cell_line, fill_synergy = phenotype, symbol_toxicity = toxicity) %>%
  mutate(figure = "Figure_3C")

write.table(fig3c, file = "/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/export/xv20220117_paper_figure_short/source_data/xv20240417_sourcedata_fig3c.txt", row.names = F)

```
(C) M- and N-synergies in RPE-1 p53KO, p53/BRCA1dKO and K562 cells of the tested 20 DNA repair proteins. M-synergies are shown in brown, N-synergies in green and both synergies in olive. Synergies detected with an FDR < 0.25 are shown in solid colors and synergies with FDR > 0.25 are shown in lighter colors. Empty values in grey represent DNA repair proteins that did not change the log2MMEJ:NHEJ balance in RPE-1 cells. M- or N-synergies marked by a X were detected in samples with low DNA recovery compared to controls samples (See Methods and Fig. S8A).

# Figure 3D
## Calculate similarity between cell lines
```{r,warning=FALSE, message=FALSE}
#Calculate all possible cell-cell combinations
all_cell_line_combination <- expand.grid(c("K562","PRO","DEF"),c("K562","PRO","DEF")) %>% select(cell1 = Var1, cell2 = Var2)

#Cosine distance
all_CCD_dcast <- cell_lines_CCD %>%
  anti_join(filter_out_chromatin) %>%
  reshape2::dcast(gene + chrom_feature ~ cell_line, value.var = "CCD_synergy_score")

#Mean cosine_similarity score
mean_cosine_similarity <- map2_dfr(all_cell_line_combination$cell1, all_cell_line_combination$cell2, function(x,y) {
  comparison_cell_lines <- all_CCD_dcast %>% select(a = x, b = y, gene) %>% na.omit()
    CCD_table <- comparison_cell_lines %>%
      dplyr::group_by(gene) %>%
      dplyr::summarise(cosine_dist = as.numeric(cosine(a,b)),
                       cell_line1 = x,
                       cell_line2 = y)
})

#Calculate mean
summary_similarities <- mean_cosine_similarity %>%
  dplyr::group_by(cell_line1, cell_line2) %>%
  dplyr::summarise(median_cos = median(cosine_dist))
```

## Calculate similarity scores between RPE-1 p53KO and K562 (Green)
```{r,fig.width=5,fig.height=3, warning=FALSE, message=FALSE}
#Dcast table with PRO and K562 data
PRO_K562_dcast <- cell_lines_CCD %>%
  filter(cell_line %in% c("PRO","K562")) %>%
  reshape2::dcast(gene + chrom_feature ~ cell_line, value.var = "CCD_synergy_score") %>% na.omit() %>% anti_join(filter_out_chromatin)

#Calculate cosine distance for PRO
PRO_K562_distance_all <- map_dfr(unique(PRO_K562_dcast$gene), function(x){
  CCD_table <- PRO_K562_dcast %>%
    filter(gene == x) %>%
    select(PRO,K562)
  
  #calculate concordance
  cosine_value <- cosine(as.matrix(CCD_table))[1,2]
  tibble(gene = x, cosine_dist = cosine_value)
})

#Join CCD_scores
PRO_K562_distances_all <- PRO_K562_distance_all %>% dplyr::left_join(PRO_CCD %>% select(gene,CCD_model_p_adj) %>% distinct()) %>% na.omit()

#Median similarity
median(PRO_K562_distances_all$cosine_dist)
#Mean similarity
mean(PRO_K562_distances_all$cosine_dist)
```

## Calculate similarity scores between RPE-1 p53KO and K562 (Purple)
```{r,fig.width=5,fig.height=3, warning=FALSE, message=FALSE}
#Dcast table with DEF and K562 data
DEF_K562_dcast <- cell_lines_CCD %>%
  filter(cell_line %in% c("DEF","K562")) %>%
  reshape2::dcast(gene + chrom_feature ~ cell_line, value.var = "CCD_synergy_score") %>% na.omit()

#Calculate cosine distance for DEF
DEF_K562_distance_all <- map_dfr(unique(DEF_K562_dcast$gene), function(x){
  CCD_table <- DEF_K562_dcast %>%
    filter(gene == x) %>%
    select(DEF,K562)
  
  #calculate concordance
  cosine_value <- cosine(as.matrix(CCD_table))[1,2]
  tibble(gene = x, cosine_dist = cosine_value)
})

#Join CCD_scores
DEF_K562_distances_all <- DEF_K562_distance_all %>% dplyr::left_join(DEF_CCD %>% select(gene,CCD_model_p_adj) %>% distinct()) %>% na.omit()

#Median similarity
median(DEF_K562_distances_all$cosine_dist)
#Mean similarity
mean(DEF_K562_distances_all$cosine_dist)
```

## Simulate random similarity distribution (RPE-1 p53KO)
```{r, message = F, warning = F}
#Sampling loop to select random samples of equal size as interacting pairs

  random_sample_cosine_values_PRO <- map_dfr(c(1:1000), function(i){
   set.seed(i)
    K562_genes <- K562_CCD_all %>% na.omit() %>% filter(!gene %in% proteins_gRNA$gene) %>% pull(gene) %>% unique() %>% sample(18) 
    PRO_genes <- PRO_K562_dcast %>% pull(gene) %>% unique()
    K562_PRO_table <- tibble(K562_gene = K562_genes, PRO_gene = PRO_genes)
    PRO_data <- PRO_K562_dcast %>% select(PRO, chrom_feature, PRO_gene = gene)
    K562_CCDs_random <- K562_CCD_all %>% filter(chrom_feature %in% c("H3K4me1","H3K36me3","H3K27ac","H3K4me2","H3K4me3","H3K9me2","late_replicating") & gene %in% K562_genes) %>% select(chrom_feature, K562 = CCD_synergy_score, K562_gene = gene)
    K562_CCDs_random_cos <- K562_CCDs_random %>% left_join(K562_PRO_table, by = "K562_gene") %>% left_join(PRO_data, by = c("PRO_gene","chrom_feature")) %>% na.omit() %>% ungroup() %>% dplyr::group_by(PRO_gene,K562_gene) %>% dplyr::summarise(cos_dist = cosine(K562, PRO)) %>% mutate(seed = i)
  })

#Create density matrices for plotting later
density.matrix.datapoints_PRO <- tibble()
for (i in c(1:1000)){
  seed.unique <- filter(random_sample_cosine_values_PRO %>% na.omit(), seed == i) %>% pull(cos_dist)%>% as.numeric()
  dens.seed.unique <- density(seed.unique, from = -1, to = 1) %>% tidy() %>% mutate(seed = i) %>% mutate(round_x = round(x, digits = 2)) %>% dplyr::group_by(round_x) %>% dplyr::summarise(mean_y = mean(y), seed = i)
  density.matrix.datapoints_PRO <- density.matrix.datapoints_PRO %>% bind_rows(dens.seed.unique)
}

#Calculate mean and sd to plot in density plots for random effects
summarise.mean.sd_sample_PRO <- density.matrix.datapoints_PRO %>% dplyr::group_by(round_x) %>% dplyr::summarise(avg_y = mean(mean_y), sd_y = sd(mean_y), counts = n())

#Calculate real interaction density data
real_density_plot_PRO <- density(PRO_K562_distances_all %>% na.omit() %>% pull(cosine_dist), from = -1, to = 1) %>% tidy()  %>% mutate(round_x = round(x, digits = 2)) %>% dplyr::group_by(round_x) %>% dplyr::summarise(mean_y = mean(y))
```

## Simulate random similarity distribution (RPE-1 p53/BRCA1 dKO)
```{r, message = F, warning = F}
#Sampling loop to select random samples of equal size as interacting pairs

  random_sample_cosine_values_DEF <- map_dfr(c(1:1000), function(i){
   set.seed(i)
    K562_genes <- K562_CCD_all %>% na.omit() %>% filter(!gene %in% proteins_gRNA$gene) %>% pull(gene) %>% unique() %>% sample(18) 
    DEF_genes <- DEF_K562_dcast %>% pull(gene) %>% unique()
    K562_DEF_table <- tibble(K562_gene = K562_genes, DEF_gene = DEF_genes)
    DEF_data <- DEF_K562_dcast %>% select(DEF, chrom_feature, DEF_gene = gene)
    K562_CCDs_random <- K562_CCD_all %>% filter(chrom_feature %in% c("H3K4me1","H3K36me3","LMNB1","H3K27me3","H3K27ac","H3K4me2","H3K4me3","H3K9me3","H3K9me2","late_replicating") & gene %in% K562_genes) %>% select(chrom_feature, K562 = CCD_synergy_score, K562_gene = gene)
    K562_CCDs_random_cos <- K562_CCDs_random %>% left_join(K562_DEF_table, by = "K562_gene") %>% left_join(DEF_data, by = c("DEF_gene","chrom_feature")) %>% ungroup() %>% dplyr::group_by(DEF_gene,K562_gene) %>% dplyr::summarise(cos_dist = cosine(K562, DEF)) %>% mutate(seed = i)
  })

#Create density matrices for plotting later
density.matrix.datapoints_DEF <- tibble()
for (i in c(1:1000)){
  seed.unique <- filter(random_sample_cosine_values_DEF, seed == i) %>% pull(cos_dist)%>% as.numeric()
  dens.seed.unique <- density(seed.unique, from = -1, to = 1) %>% tidy() %>% mutate(seed = i) %>% mutate(round_x = round(x, digits = 2)) %>% dplyr::group_by(round_x) %>% dplyr::summarise(mean_y = mean(y), seed = i)
  density.matrix.datapoints_DEF <- density.matrix.datapoints_DEF %>% bind_rows(dens.seed.unique)
}

#Calculate mean and sd to plot in density plots for random effects
summarise.mean.sd_sample_DEF <- density.matrix.datapoints_DEF %>% dplyr::group_by(round_x) %>% dplyr::summarise(avg_y = mean(mean_y), sd_y = sd(mean_y), counts = n())

#Calculate real interaction density data
real_density_plot_DEF <- density(DEF_K562_distances_all %>% na.omit() %>% pull(cosine_dist), from = -1, to = 1) %>% tidy() %>% mutate(round_x = round(x, digits = 2)) %>% dplyr::group_by(round_x) %>% dplyr::summarise(mean_y = mean(y))
```

## Plot cosine similarities RPE1 p53KO cells (Green 3D top)
```{r,fig.width=2.75,fig.height=2.5, warning=FALSE, message=FALSE}
#Plot this figure
#pdf("/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/export/xv20220117_paper_figure_short/figure_3_CCD_other_cell_lines/xv20231027_PRO_CCD_cosine_distribution.pdf", width = 2.75, height = 1.5)
ggplot(summarise.mean.sd_sample_PRO) + 
  geom_ribbon(aes(round_x, ymax = avg_y + sd_y, ymin = avg_y - sd_y), alpha = 0.2, fill = "grey60") +
  geom_line(aes(round_x,avg_y), color = "grey60", linetype = 2) + 
  geom_line(data = real_density_plot_PRO, aes(round_x,mean_y), color = "#95c482", size = 1.25) +
    theme_bw() + theme(legend.position = "top",
                       panel.grid = element_blank()) + 
  ylab("Density") + xlab("Cosine distance")
#dev.off()

#Calculate empirical test
#Real mean
real_median <- PRO_K562_distances_all %>% na.omit() %>% pull(cosine_dist) %>% median()
mean_cosine_similarity <- random_sample_cosine_values_PRO %>% 
  dplyr::group_by(seed) %>%
  dplyr::summarise(mean_cos = median(cos_dist, na.rm = T))

CI_99 <-  quantile(mean_cosine_similarity$mean_cos, c(0.025,0.975))

#Print summary
print(paste("The real distribution has a median of", round(real_median, digits =2), "and the 95th percentile of the random selection has a median value of",round(CI_99,digits = 2),"in RPE1 DEF cells."))

# Source data table
fig3d_top <- summarise.mean.sd_sample_PRO %>%
  left_join(real_density_plot_PRO) %>%
  select(x_similarity = round_x, y_realdata = mean_y, y_meanrandom = avg_y, y_sdrandom = sd_y) %>%
  mutate(figure = "Figure_3D_top")

write.table(fig3d_top, file = "/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/export/xv20220117_paper_figure_short/source_data/xv20240417_sourcedata_fig3d_top.txt", row.names = F)

```

## Plot cosine similarities RPE1 p53/BRCA1 dKO cells (Purple 3D bottom)
```{r,fig.width=2.75,fig.height=1.5, warning=FALSE, message=FALSE}
#Plot this figure
#pdf("/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/export/xv20220117_paper_figure_short/figure_3_CCD_other_cell_lines/xv20231027_DEF_CCD_cosine_distribution.pdf", width = 2.75, height = 1.5)
ggplot() + 
  geom_ribbon(data = summarise.mean.sd_sample_DEF, aes(round_x, ymax = avg_y + sd_y, ymin = avg_y - sd_y), alpha = 0.2, fill = "grey60") +
  geom_line(data = summarise.mean.sd_sample_DEF, aes(round_x,avg_y), color = "grey60", linetype = 2) + 
  geom_line(data = real_density_plot_DEF, aes(round_x,mean_y), color = "#9f86bf", size = 1.25) +
    theme_bw() + theme(legend.position = "top",
                       panel.grid = element_blank()) + 
  ylab("Density") + xlab("Cosine distance")
#dev.off()

#Calculate empirical test
#Real mean
real_median <- DEF_K562_distances_all %>% na.omit() %>% pull(cosine_dist) %>% median()
mean_cosine_similarity <- random_sample_cosine_values_DEF %>% 
  dplyr::group_by(seed) %>%
  dplyr::summarise(mean_cos = median(cos_dist))

CI_99 <-  quantile(mean_cosine_similarity$mean_cos, c(0.025,0.975))

#Print summary
print(paste("The real distribution has a median of", round(real_median, digits =2), "and the 95th percentile of the random selection has 95 percentile of ",round(CI_99[1],digits = 2),"in RPE1 DEF cells."))

# Source data table
fig3d_bottom <- summarise.mean.sd_sample_DEF %>%
  left_join(real_density_plot_DEF) %>%
  select(x_similarity = round_x, y_realdata = mean_y, y_meanrandom = avg_y, y_sdrandom = sd_y) %>%
  mutate(figure = "Figure_3D_bottom")

write.table(fig3d_bottom, file = "/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/export/xv20220117_paper_figure_short/source_data/xv20240417_sourcedata_fig3d_bottom.txt", row.names = F)

```
(D) Distribution of pairwise similarity scores for CCDs patterns across chromatin features in K562 and RPE1 p53KO cells (top) and RPE1 p53/BRCA1dKO cells (bottom). In both plots, the green/purple distributions represent similarity scores of the same protein and in grey the distribution of random protein pairs (mean ± s.d. of 1,000 draws). In the top left corner of each graph, the mean similarity scores of the real distribution (cos(θ)) and 95%CI of the mean similarity scores of 1,000 random draws. 

# Figure 3E
```{r}
#pdf("/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/export/xv20220117_paper_figure_short/figure_3_CCD_other_cell_lines/xv20231016_Fig3E_CCD_cosine_similarity_PRO.pdf", width = 5, height = 3)
ggplot(PRO_K562_distances_all %>% distinct()) +
  geom_col(aes(fct_relevel(gene, gene_list_order),cosine_dist, fill = CCD_model_p_adj < 0.25)) +
  theme_bw() + 
  geom_hline(yintercept = 0, linetype =2) +
  xlab("Proteins with CCDs") + 
  theme_bw() + 
  theme(axis.text.x =  element_text(angle = 90,
                                    hjust = 1,
                                    vjust = 0.5),
        legend.position = "none",
        panel.grid = element_blank()) + 
  ylab("Cosine similarity score") + 
  scale_fill_manual(values = c("grey70", "#95c482"))  + 
  coord_cartesian(ylim = c(-1,1))
#dev.off()

# Source data table
fig3e <- PRO_K562_distances_all %>% distinct() %>%
  select(x_gene = gene, y_cosdist = cosine_dist, color_padj = CCD_model_p_adj) %>%
  mutate(figure = "Figure_3E")

write.table(fig3e, file = "/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/export/xv20220117_paper_figure_short/source_data/xv20240417_sourcedata_fig3e.txt", row.names = F)

```

# Figure 3F
```{r}
#pdf("/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/export/xv20220117_paper_figure_short/figure_3_CCD_other_cell_lines/xv20231013_Fig3D_CCD_cosine_similarity_DEF.pdf", width = 5, height = 3)
ggplot(DEF_K562_distances_all %>% distinct()) +
  geom_col(aes(fct_relevel(gene, gene_list_order),cosine_dist, fill = CCD_model_p_adj < 0.25)) +
  theme_bw() + 
  geom_hline(yintercept = 0, linetype =2) +
  xlab("Proteins with CCDs") + 
  theme_bw() + 
  theme(axis.text.x =  element_text(angle = 90,
                                    hjust = 1,
                                    vjust = 0.5),
        legend.position = "none",
        panel.grid = element_blank()) + 
  ylab("Cosine similarity score") + 
  scale_fill_manual(values = c("grey70", "#9f86bf"))  + 
  coord_cartesian(ylim = c(-1,1))
#dev.off()

# Source data table
fig3f <- DEF_K562_distances_all %>% distinct() %>%
  select(x_gene = gene, y_cosdist = cosine_dist, color_padj = CCD_model_p_adj) %>%
  mutate(figure = "Figure_3F")

write.table(fig3f, file = "/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/export/xv20220117_paper_figure_short/source_data/xv20240417_sourcedata_fig3f.txt", row.names = F)

```
(E-F) Pairwise similarity scores for CCD patterns of each of the proteins assayed in (E) RPE-1 p53KO cells (n=18) and (F) RPE-1 p53/BRCA1dKO cells (n=18). Columns in green or purple represent M- or N-synergies with an FDR < 0.25 and in grey synergies with an FDR > 0.25.
