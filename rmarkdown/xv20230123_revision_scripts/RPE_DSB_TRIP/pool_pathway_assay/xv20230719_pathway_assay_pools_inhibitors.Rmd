---
title: "xv20230329_RPE1_mapping_clone"
author: "Xabier Vergara"
date: "2023-03-29"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(plotly)
library(ggbeeswarm)
library(pheatmap)
```

# Patwhay balance in clone 32: After mapping

## Import data
```{r, warning=F}
# List files in mcclintock
pathway_assay_files <- list.files("/DATA/projects/DSBrepair/data/xv20230714_E2286_pool_pathway_assay/indelPCR_counts",pattern = '*[.]co', full.names = T) 

#Read and parse files
clone_pools_pathway_assay <- map_dfr(pathway_assay_files, function(x){
  read_delim(x, show_col_types = F) %>% 
  mutate(filename = gsub("/DATA/projects/DSBrepair/data/xv20230714_E2286_pool_pathway_assay/indelPCR_counts/","",x),
         outcome = paste(call, indel, sep = "_")) %>%
  separate(filename, into = c("exp_n","sample_ID","cell_line","condition","bio_rep","t_rep"))
})
```

#Some QC plots
```{r}
# Check barcode numbers: How many times is each barcode found
barcode_counts  <- clone_pools_pathway_assay  %>% 
  dplyr::group_by(barcode,sample_ID,cell_line,condition,bio_rep) %>% 
  dplyr::summarise(counts = sum(count)) %>%
  filter(counts > 50)

#Number of coocurrence: For RPE1 & DEF it could be 4, and U2OS or PRO a max of 3.
replicates <- barcode_counts %>% 
  dplyr::group_by(barcode,cell_line,condition) %>%
  dplyr::summarise(reps = n())

#Control plot: How many times doI
ggplot(replicates) + 
  geom_bar(aes(reps)) + 
  facet_wrap(~ cell_line) +
  theme_bw()

#Control plot: How many IPRs have full set of 4 conditions
rep_conditions <- barcode_counts %>% 
  dplyr::group_by(barcode,cell_line,bio_rep) %>%
  dplyr::summarise(cond = n())

#Number of samples: 
ggplot(rep_conditions)  +
  geom_bar(aes(cond, fill = bio_rep), position = "dodge") +
  facet_wrap(~ cell_line) +
  theme_bw()
```
#  Conclusion: Even treating each replicate separately, we would have full sets for PRO, DEF and U2OS (almost). Next, I will try to pool all replicates together


#Tile plot
```{r}
tile_plot.data <- replicates %>% dplyr::group_by(cell_line,condition,reps) %>% dplyr::summarise(IPR_n = n())

ggplot(tile_plot.data) +
  geom_tile(aes(reps,condition, fill = IPR_n)) +
  facet_wrap(~ cell_line, scales = "free_x") +
  theme_bw()

```

```{r}
# Check barcode numbers: How many times is each barcode found
barcode_counts_pooled  <- clone_pools_pathway_assay  %>% 
  dplyr::group_by(barcode,cell_line,condition) %>% 
  dplyr::summarise(counts = sum(count)) %>%
  filter(counts > 50)


#Control plot: How many IPRs have full set of 4 conditions
rep_conditions_pooled <- barcode_counts_pooled %>% 
  dplyr::group_by(barcode,cell_line) %>%
  dplyr::summarise(cond = n())

#Number of samples: 
ggplot(rep_conditions_pooled)  +
  geom_bar(aes(cond)) +
  facet_wrap(~ cell_line) +
  theme_bw()
```

#Check if these pools are the correct one
```{r}
#Import barcode sequences
#RPE cells
RPE_IPR <- read_delim("/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/export/xv20230307_revision_figures/DSB_TRIP_mapping/xv20230519_RPE_pools_mapping.tsv") %>%
  select(name) %>%
  separate(name, into = c("barcode","iPCR_cell","iPCR_transfection","iPCR_complexity"))

U2OS_IPR <- read_delim("/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/export/xv20230307_revision_figures/DSB_TRIP_mapping/xv20230519_U2OS_pools_mapping.tsv") %>%
  select(name) %>%
  separate(name, into = c("barcode","iPCR_cell","iPCR_transfection","iPCR_complexity"))

#Bind both
all_IPRs <- bind_rows(RPE_IPR, U2OS_IPR)

# How many of the barcodes are mapped?
mapped_IPRs <- barcode_counts_pooled %>% left_join(all_IPRs) %>% na.omit()

# Did I take the correct pools?
matching_pools <- mapped_IPRs %>% 
  ungroup() %>% 
  select(barcode, iPCR_cell, iPCR_transfection, iPCR_complexity) %>%
  distinct() %>%
  dplyr::group_by(iPCR_cell, iPCR_transfection, iPCR_complexity) %>%
  dplyr::summarise(IPR_indel_data = n())

ggplot(matching_pools) + 
  geom_col(aes(iPCR_transfection,IPR_indel_data, fill = fct_relevel(iPCR_complexity, c("100","250","1000"))), position = "dodge") + 
  facet_wrap(~iPCR_cell) +
  theme_bw() +
  theme(legend.position = "top")
```
#CONCLUSION: We selected the right pool!

#Number of mapped IPRs with indel data (most optimistic)
```{r}
selected_pools <- c("RPE1_Low_1000","RPE1Deff_Low_1000","RPE1Proff_Low_250","U2OS_High_100")

matching_pools %>% 
  mutate(pool = paste(iPCR_cell, iPCR_transfection, iPCR_complexity, sep = "_")) %>%
  filter( pool %in% selected_pools)

```
#CONCLUSION: We are recovering the whole complexity for U2OS & PRO (input 400 ng). With DEF & RPE we are not capturing full complexity (input 200 ng).

#Filter barcodes by indel counts
```{r}
#dcast table with all mutations
indel_data_merged_tech <- clone_pools_pathway_assay %>% 
  dplyr::group_by(barcode,outcome, exp_n, sample_ID, cell_line, condition, bio_rep) %>%
  dplyr::summarise(counts = sum(count))
  
#Dcast
dcast_merged <- indel_data_merged_tech %>% 
    reshape2::dcast(barcode + cell_line + exp_n + sample_ID + condition + bio_rep ~ outcome, fill = 0)

#Clean noise
filter_dcast_merged <- dcast_merged %>%
  mutate(reads = wt_0 + ins_1 + `del_-7`) %>%
  filter(reads > 50)  %>%
  mutate(total_reads = rowSums(.[7:214])) %>%
  select(barcode, cell_line, exp_n, sample_ID, condition, bio_rep, ins_1, `del_-7`, wt_0,total_reads) %>%
  mutate(total_indel = ins_1 + `del_-7`,
         TIF = 1-(wt_0/total_reads),
         balance = log2(`del_-7`/ins_1))

#Mapped IPRs
mapped_IPRs <- filter_dcast_merged %>% left_join(all_IPRs) %>% na.omit()

#Pathway_barcodes
filtered_indel_reads <- mapped_IPRs %>%
  filter(ins_1 + `del_-7` > 50)
```


#Plot averages
```{r}
tmp <- filtered_indel_reads %>% 
  dplyr::group_by(barcode, cell_line, condition) %>%
  dplyr::summarise(mean_balance = mean(balance), sd_balance = sd(balance))

```


#Plot tile plot
```{r}
#Number of coocurrence: For RPE1 & DEF it could be 4, and U2OS or PRO a max of 3.
iPR_barcode <- filtered_indel_reads %>% 
  dplyr::group_by(barcode,cell_line,condition) %>%
  dplyr::summarise(reps = n())


filtered_tile_plot.data <- iPR_barcode %>% dplyr::group_by(cell_line,condition,reps) %>% dplyr::summarise(IPR_n = n())

ggplot(filtered_tile_plot.data) +
  geom_tile(aes(reps,condition, fill = IPR_n)) +
  facet_wrap(~ cell_line, scales = "free_x") +
  theme_bw()

```


#total counts per barcode in each clone
read_per_barcode <- clone_32_pathway_assay %>%
  dplyr::group_by(barcode, clone,conc,p53_status, sample,exp) %>%
  dplyr::summarise(total = sum(count))

# Check editing efficiency
pathway_assay_clones <- clone_32_pathway_assay %>% 
  filter(exp == "E2216") %>%
  right_join(read_per_barcode) %>%
  na.omit() %>%
  mutate(freq = count/total,
         mut = paste(call, gsub("-","",indel), sep = "_"))

#dcast total counts
dcast_counts_clones <- pathway_assay_clones %>% 
  reshape2::dcast(barcode + sample_ID + clone + p53_status + sample + conc + exp ~ mut, value.var = "count", fill=0, fun.aggregate = mean)



#dcast total counts
dcast_freq_clones <- pathway_assay_clones %>% 
  reshape2::dcast(barcode + sample_ID + clone + p53_status + sample + conc + exp ~ mut, value.var = "freq", fill= 0, fun.aggregate = mean)

colnames(dcast_freq_clones)[6:length(colnames(dcast_freq_clones))] <- paste0("freq_", colnames(dcast_counts_clones)[6:length(dcast_counts_clones)])

#combine both
dcast_counts_freq_clones <- dcast_counts_clones %>%
  left_join(read_per_barcode)

# Process kinase inhibitor data
pathway_assay_clones.processed <- dcast_counts_freq_clones %>% 
  filter(del_7 + ins_1 > 30 & exp == "E2216") %>% #Apply the read number filtering step
  mutate(freqCut = 1 - (wt_0/(del_7+ins_1+wt_0)),
         log2MMEJNHEJratio = log2(del_7 / ins_1),
         MMEJ_freq = del_7/(del_7+ins_1)) %>%
  dplyr::select(barcode, sample_ID,clone,p53_status,sample,exp,conc,log2MMEJNHEJratio,MMEJ_freq,freqCut, del_7, ins_1, wt_0,total)  %>% distinct()

#Filter wells with mean cutting efficiency lower than 25%
filter.out.wells <- pathway_assay_clones.processed %>% 
  dplyr::group_by(sample_ID,clone,p53_status,sample,conc) %>%
  dplyr::summarise(mean.cut = mean(freqCut, na.rm = T)) %>%
  filter(mean.cut < 0.90) %>% 
  dplyr::select(sample_ID,clone,p53_status,sample,conc)

#Filter based on cutting efficiency
filtered.RPE.clones.tib <- pathway_assay_clones.processed %>% 
  anti_join(filter.out.wells, by = c("exp", "replicate","gRNA","clone"))
```

#Check first plot (individual values)
```{r}
#Left_join
pathway_location_clone32 <- average_values %>% left_join(chromatin_features_clone32, by = c("barcode" = "ID"))

#Calculate correlation coeficients

spearman_coefficients <- map_dfr(colnames(pathway_location_clone32[8:28]), function(x){
  balance <- pathway_location_clone32$mean_ratio
  feature <-  pathway_location_clone32[x]
  spearman.rho <- stats::cor(balance, feature, method = "spearman")
  tibble(chromatin = x, rho = spearman.rho[1])
})

#Plot correlation coefficients
ggplot(spearman_coefficients %>% filter(chromatin != "dam_H3K27me3")) + 
  geom_col(aes(reorder(chromatin,rho),rho)) + 
  coord_flip() +
  theme_bw() + 
  xlab("Chromatin features") +
  ylab("Spearman's correlation coefficient of MMEJfreq.")

```

#Correlation examples
```{r}
#With LMNB2
ggplot(pathway_location_clone32, aes(dam_H3K9me3, mean_ratio)) + 
  geom_point() +
  ggpubr::stat_cor(method = "spearman") +
  geom_smooth(method = "lm") +
  theme_bw()


#With H3K4me3
ggplot(pathway_location_clone32, aes(chip_H3K27ac.x, mean_ratio)) + 
  geom_point() +
  ggpubr::stat_cor(method = "spearman") +
  geom_smooth(method = "lm") +
  theme_bw()

#With LMNB2
ggplot(pathway_location_clone32, aes(chip_H3K27me3.y, mean_ratio)) + 
  geom_point() +
  ggpubr::stat_cor(method = "spearman") +
  geom_smooth(method = "lm") +
  theme_bw()


```
