---
title: "xv20230329_RPE1_pool_pathway assay"
author: "Xabier Vergara"
date: "2023-07-26"
output:
  html_document: default
  pdf_document: default
---
#Date: 26th July 2023
#Author: Xabier Vergara
#Aim: The aim of this file is to wrap up the filtering strategy and measure if pathway balance in control samples has chromatin biases.

#Load libraries
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(plotly)
library(ggbeeswarm)
library(pheatmap)
```


## Import data: Balance data and some other details
```{r, warning=F}
# Import data for high confidence reporters and calculate mean
high_confidence_IPR <- readRDS("~/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/data/revisions/pools_balance/xv20230814_high_confidence_IPR_set.rds") %>%
  dplyr::group_by(barcode, cell_line, condition) %>%
  dplyr::summarise(mean_bal = mean(balance, na.rm = T),
                   reps = n()) %>%
  filter(reps > 1)


#Pools used in the experiment
selected_pools <- c("RPE1_Low_1000","RPE1Deff_Low_1000","RPE1Proff_Low_250","U2OS_High_100")

#Pair of 
```

#Add chromatin info for RPE1 cells
#Load chromatin info of the IPRs in RPE cells (2000)
```{r, warning=F}
setwd("/DATA/projects/DSBrepair/data/DSB_TRIP_cell_lines_mapping/xv20230519_all_RPE_pools_mapping/")
# Load chip data
chip_files <- list.files(path = "chip/site_means", pattern = "2000_", full.names = T)
dam_files <- list.files(path = "dam", pattern = "2000_", full.names = T)
repli_files <- "coverage/RPE1_DSB_TRIP_pools-2000_summary.tsv"

#Make a dataframe with all the files
chromatin_features_pools_chip <- map(chip_files, function(x) {
  read.delim(x, header = T) %>%
    dplyr::select(ID, z_score) %>%
    na.omit() %>%
    mutate(file = paste0("chip_",str_extract(x, "H.*(?=_)"))) %>%
    reshape2::dcast(ID ~ file, value.var = "z_score")
}) %>% purrr::reduce(left_join, by = "ID")

#Make a dataframe with dam files
chromatin_features_pools_dam <- map(dam_files, function(x) {
  read.delim(x, header = T) %>%
    dplyr::select(name, z_score) %>%
    na.omit() %>%
    mutate(file = paste0("dam_",str_extract(x, "(?<=2000_).*(?=.txt)"))) %>%
    reshape2::dcast(name ~ file, value.var = "z_score")
}) %>% purrr::reduce(left_join, by = "name")

#Make a column for repliseq
repliseq_dataframe <- map_dfr(repli_files, function(x) {
  read.delim(x, header = T) %>%
    na.omit() %>%
    mutate(ratio_r1 = repliseq_r1_late - repliseq_r1_early, ratio_r2 = repliseq_r2_late - repliseq_r2_early) %>%
    mutate(late_replicating = scale((ratio_r1 + ratio_r2)/2)) %>%
    dplyr::select("ID" = barcode, late_replicating)
})

#Bind both
chromatin_features_pools_2000 <-  left_join(chromatin_features_pools_chip, chromatin_features_pools_dam, by = c("ID"="name")) %>%
  left_join(repliseq_dataframe) %>%
  separate(ID, into = c("barcode","iPCR_cell","iPCR_transfection","iPCR_complexity")) %>%
  mutate(pool = paste(iPCR_cell, iPCR_transfection,iPCR_complexity, sep = "_")) %>% 
  filter(pool %in% selected_pools) %>%
  mutate(cell_line = case_when(iPCR_cell == "RPE1Deff" ~ "RPEDef",
                               iPCR_cell == "RPE1Proff" ~ "RPEPro",
                               T ~ iPCR_cell)) %>%
  select(-pool, -iPCR_cell, -iPCR_transfection, -iPCR_complexity, - dam_LMNNB2) %>%
  mutate(binsize = "2000")
```


#Join with balances and calculate the correlation (do this for all marks) = Spearman's
```{r, warning=F}
#Merge RPE data with chromatin data with different bins
values_chromatin_RPE <- left_join(high_confidence_IPR, chromatin_pools_binsize)

#Calculate spearman correlation for all chromatin features
cell_lines <- c("RPE1","RPEPro","RPEDef")
binsizes <- c("2000","5000","10000","20000")

#Calculate spearman correlation coefficient per cell line and chromatin feature
spearman_coefficients <- map_dfr(cell_lines, function(x){
  filter_data <- values_chromatin_RPE %>% filter(cell_line == x)
  binsize_filter <- map_dfr(binsizes, function(y){
    bin_filter <- filter_data %>% filter(binsize == y)
    rho_table <- map_dfr(colnames(bin_filter[6:16]), function(j){
      balance <- bin_filter$mean_bal
      feature <- bin_filter %>% pull(j)
      cor.test( balance, feature, method = "spearman", use = "pairwise.complete.obs") %>% broom::tidy() %>% mutate(chromatin = j)
    })
  rho_table %>% mutate(cell_line = x, binsize = y) %>% distinct()
  })
})

#Chromatin feature order for plotting
chromatin_order <- c("dam_H3K9me3","dam_H3K9me2","late_replicating","dam_LMNB1","dam_LMNB2","dam_H3K27me3","chip_H3K4me3","chip_H3K4me2","chip_H3K4me1","chip_H3K27ac","chip_H3K36me3")

#Plot correlation coefficients
ggplot(spearman_coefficients %>% distinct()) + 
  geom_col(aes(fct_relevel(chromatin,chromatin_order),estimate, fill = p.value < 0.05)) + 
  coord_flip() +
  theme_bw() + 
  xlab("Chromatin features") +
  ylab("Spearman's correlation coefficient of MMEJfreq.") + 
  facet_grid(fct_relevel(binsize,binsizes)~ fct_relevel(cell_line, c("RPE1","RPEPro","RPEDef")))
```

#Join with balances and calculate the correlation (do this for all marks) = Pearson's
Larger bins might average out precise callings, so the outliers/extreme data points are more meaningful
```{r, warning=F}
#Calculate Pearson's correlation coefficients. 
pearson_coefficients <- map_dfr(cell_lines, function(x){
  filter_data <- values_chromatin_RPE %>% filter(cell_line == x)
  binsize_filter <- map_dfr(binsizes, function(y){
    bin_filter <- filter_data %>% filter(binsize == y)
    rho_table <- map_dfr(colnames(values_chromatin_RPE[6:16]), function(j){
      balance <- bin_filter$mean_bal
      feature <- as.numeric(as.matrix(bin_filter[j]))
        cor.test(x = balance, y = feature, method = "pearson", use = "pairwise.complete.obs") %>% broom::tidy() %>% mutate(chromatin = j)
    })
  rho_table %>% mutate(cell_line = x, binsize = y) %>% distinct()
  })
})

#Plot correlation coefficients
ggplot(pearson_coefficients %>% distinct()) + 
  geom_col(aes(fct_relevel(chromatin,chromatin_order),estimate, fill = p.value < 0.05)) + 
  coord_flip() +
  theme_bw() + 
  xlab("Chromatin features") +
  ylab("Pearson's correlation coefficient of MMEJfreq.") + 
  facet_grid(fct_relevel(binsize,binsizes)~ fct_relevel(cell_line, c("RPE1","RPEPro","RPEDef")))
```
#Conclusion: 
  Increasing binsizes and using pearson correlation really help for RPE proficient and deficient cell lines. This might be because of missannotation of chromatin features. By increasing the binsize, we average out intermediate values and only retain these that are in really high regions of any chromatin marks. I would suggest that RPE1 cells we treat in the ideal version of it (Spearman's 2000 binsize, as K562). But for HR proficient and deficient, we go for larger binsizes and give higher weight to the extreme locations.
  
  This implies that figures should be separated and should be introduced in different parts of the text. Also makes impossible the comparison between RPE1 wild-types and RPE p53KO. However, making this kind of comparisons might have not been the best idea because of the multiple cofounding factors that there are between these cell lines: Different origin and different Cas9.

#Possible Figures

#A: RPE1 and Spearman correlation as direct validation of K562.
```{r}
#Plot correlation coefficients
ggplot(spearman_coefficients %>% filter(cell_line == "RPE1" & binsize == "2000") %>% distinct()) + 
  geom_col(aes(fct_relevel(chromatin,chromatin_order),estimate, fill = p.value < 0.05)) + 
  coord_flip() +
  theme_bw() + 
  xlab("Chromatin features") +
  ylab("Spearman's correlation coefficient of MMEJfreq.")
```

#A: HR Proficient and Deficient correlation as direct validation of K562.
```{r}
#Plot correlation coefficients
ggplot(pearson_coefficients %>% filter(cell_line != "RPE1" & binsize == "20000") %>% distinct()) + 
  geom_col(aes(fct_relevel(chromatin,chromatin_order),estimate, fill = p.value < 0.05)) + 
  coord_flip() +
  theme_bw() + 
  xlab("Chromatin features") +
  ylab("Pearson's correlation coefficient of MMEJfreq.") +
  facet_wrap(~ fct_relevel(cell_line, c("RPEPro","RPEDef")))

```

#Plot these differences
```{r}
#Plot correlation coefficients
ggplot(values_chromatin_RPE %>% filter(cell_line != "RPE1" & binsize == "20000") %>% distinct(),
       aes(mean_bal, chip_H3K36me3)) + 
  geom_point() +
  ggpubr::stat_cor(method = "pearson") +
  geom_smooth(method = "lm") +
  theme_bw() + 
  facet_wrap(~ fct_relevel(cell_line, c("RPEPro","RPEDef")))

#Plot correlation coefficients
ggplot(values_chromatin_RPE %>% filter(cell_line != "RPE1" & binsize == "20000") %>% distinct(),
       aes(mean_bal, dam_H3K27me3)) + 
  geom_point() +
  ggpubr::stat_cor(method = "pearson") +
  geom_smooth(method = "lm") +
  theme_bw() + 
  facet_wrap(~ fct_relevel(cell_line, c("RPEPro","RPEDef")))

```


#Export data
```{r}
#Export log2 chromatin data for RPE1
write_rds(chromatin_pools_binsize, file = "~/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/data/revisions/pools_balance/xv20230814_chromatin_features_zscore_RPE1.rds")
```


