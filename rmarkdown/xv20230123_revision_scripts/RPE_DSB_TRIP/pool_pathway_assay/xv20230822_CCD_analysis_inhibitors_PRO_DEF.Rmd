---
title: "xv20230822_RPE1_PRO_DEF_combinatorial"
author: "Xabier Vergara"
date: "2023-03-29"
output: html_document
---

In this markdown, I will explore the effect of combinatorial perturbations. I will use PRO as a control and take DEF +/- treatment

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(plotly)
library(ggbeeswarm)
library(pheatmap)
library(broom)
library(scales)
```

# Patwhay balance in clone 32: After mapping

## Import data
```{r, warning=F}
# List files in mcclintock
pathway_assay_files <- list.files("/DATA/projects/DSBrepair/data/xv20230714_E2286_pool_pathway_assay/indelPCR_counts",pattern = '*[.]co', full.names = T) 

#Read and parse files
clone_pools_pathway_assay <- map_dfr(pathway_assay_files, function(x){
  read_delim(x, show_col_types = F) %>% 
  mutate(filename = gsub("/DATA/projects/DSBrepair/data/xv20230714_E2286_pool_pathway_assay/indelPCR_counts/","",x),
         outcome = paste(call, indel, sep = "_")) %>%
  separate(filename, into = c("exp_n","sample_ID","cell_line","condition","bio_rep","t_rep"))
})
```


#Number of mapped IPRs with indel data (most optimistic). From previous analysis
```{r}
#DSB TRIP pools used in this experiment
selected_pools <- c("RPE1Deff_Low_1000","RPE1Proff_Low_250")

#Reliable IPRs
high_confidence_IPR <- readRDS("~/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/data/revisions/pools_balance/xv20230814_high_confidence_IPR_set.rds") %>%
 filter(condition == "LBR2") %>% 
  select(barcode, cell_line,bio_rep) %>% 
  distinct()

#Mapped barcodes
#RPE1
high_confidence_IPR_chromatin_RPE1 <- readRDS(file = "~/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/data/revisions/pools_balance/xv20230814_chromatin_features_zscore_RPE1.rds")

#Cell lines
cells <- c("RPEPro","RPEDef")
binsizes <- c("2000")

```




#Process indel data
```{r}
#Filter by replicate with high confidence in control
indel_data_high_confidence <- clone_pools_pathway_assay %>% 
  dplyr::group_by(barcode,outcome, exp_n, cell_line, condition, bio_rep) %>%
  dplyr::summarise(counts = sum(count, na.rm = F) + 1) %>% right_join(high_confidence_IPR)

#select +1 and -7 indels
control_balance_inh <- indel_data_high_confidence %>% filter(outcome %in% c("ins_1","del_-7"))

#Look at read numbers
control_balance_bio_dcast <- control_balance_inh %>% reshape2::dcast(barcode + cell_line + condition + bio_rep ~ outcome, value.var = "counts", fun.aggregate = mean, fill = 1)

#Control_measurements (bio_rep)
pathway_metric_control_bio <- control_balance_bio_dcast %>%
  mutate(balance = `del_-7`/(ins_1 + `del_-7`),
         log2_bal = log2(`del_-7`/ins_1)) %>%
  na.omit()

```
#Conclusion: we always get some barcodes, but these are extremely low in RPE1 cells

#Calculate global differentials per replicate
```{r}
#Per replicate global balance
per_rep_global_bal <- pathway_metric_control_bio %>% 
  dplyr::group_by(cell_line, bio_rep,condition) %>%
  dplyr::summarise(global_bal = mean(log2_bal)) %>%
  filter(condition != "tracr" & cell_line %in% c("RPEPro","RPEDef"))

#Control balance
dmso_balance <- pathway_metric_control_bio %>% 
  filter(condition == "LBR2" & 
        cell_line == "RPEPro") %>% 
  dplyr::group_by(cell_line, bio_rep) %>%
  dplyr::summarise(dmso_bal = mean(log2_bal)) %>%
  ungroup() %>%
  select(-cell_line)

inhibitor_balance_calculation <- per_rep_global_bal %>% 
  left_join(dmso_balance) %>% 
  mutate(diff_bal = global_bal - dmso_bal)

mean_inhibitor_effect <- inhibitor_balance_calculation %>%
  mutate(background = case_when(grepl("Pro",cell_line) ~ "WT",
                                grepl("Def",cell_line) ~ "BRCA1"),
         perturb = paste0(background,":",condition))
```

#Plot pathway balance changes, as combinatorial measurements
```{R}
perturb_order <- c("WT:LBR2","BRCA1:LBR2","WT:ATMi","BRCA1:ATMi","WT:DNAPKi","BRCA1:DNAPKi")

ggplot(mean_inhibitor_effect) +
  ggbeeswarm::geom_quasirandom(aes(fct_relevel(perturb,perturb_order), diff_bal)) +
  geom_hline(yintercept = 0, linetype = 2) +
  theme_bw()
```

#Join chromatin data
```{r}
#Create RPE1 dataframe
inhibitor_effect_chromatin_RPE1 <- mean_inhibitor_effect %>%
  left_join(high_confidence_IPR_chromatin_RPE1) %>%
  na.omit()

#Create U2OS dataframe
inhibitor_effect_chromatin_U2OS <- mean_inhibitor_effect %>%
  left_join(high_confidence_IPR_chromatin_U2OS) %>%
  na.omit()

```


#Join with balances and calculate the correlation (do this for all marks)
```{r, warning=F}

#Quick plot
ggplot(inhibitor_effect_chromatin_RPE1, aes(dam_H3K27me3,mean_diff)) + 
  geom_point() + 
  geom_smooth(method = "lm", se = F) + 
  ggpubr::stat_cor(method = "pearson") +
  facet_grid(cell_line ~ condition + fct_relevel(binsize, binsizes)) + theme_bw()

#Quick plot
ggplot(inhibitor_effect_chromatin_RPE1, aes(chip_H3K4me1,mean_diff)) + 
  geom_point() + 
  geom_smooth(method = "lm", se = F) + 
  ggpubr::stat_cor(method = "pearson") +
  facet_grid(cell_line ~ condition + fct_relevel(binsize, binsizes)) + theme_bw()

#Same for U2OS
ggplot(inhibitor_effect_chromatin_U2OS, aes(chip_H3K36me3,mean_diff)) + 
  geom_point() + 
  geom_smooth(method = "lm", se = F) + 
  ggpubr::stat_cor(method = "pearson") +
  facet_grid(cell_line ~ condition + fct_relevel(binsize, binsizes)) + theme_bw()

```
#Conclusion: U2OS also looks bad with this. Both ChIP and DamID data


#Plot some control plots
```{r}
#Import K562 data 
K562_data <- readRDS("/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/data/processed_data/CCD_inhibitors/xv20220929_drug_differentials_log2_MMEJ_NHEJ_balance.rds") %>% dplyr::select(condition = drug, barcode,mean_diff =mean.log2foldchange) %>% mutate(cell_line = "K562")


#Plot differentials
ggplot(mean_inhibitor_effect %>% bind_rows(K562_data) %>% filter(condition != "DMSO")) + 
  geom_quasirandom(aes(fct_relevel(cell_line, c("K562","RPE1","RPEPro","RPEDef")), mean_diff)) + 
  geom_hline(yintercept = 0, linetype = 2) +
  facet_wrap(~condition) + 
  theme_bw() +
  xlab("Cell line") + ylab("âˆ†log2 MMEJ:NHEJ balance")

```


#Calculate global differences
```{r}
#Calculate mean effect
mean_effects <- mean_inhibitor_effect %>% 
  dplyr::group_by(cell_line, condition) %>%
  dplyr::summarise(global_diff = mean(mean_diff, na.rm = T))

#Calculate p.value calculation
p_val_global <- mean_inhibitor_effect %>% 
  dplyr::group_by(cell_line, condition) %>%
  rstatix::t_test(mean_diff ~ 0)

#Adjust p-value
adj_pvalue <- map_dfr(cells, function(x) {
  p_val_global %>% filter(cell_line == x) %>% mutate(global_p_adj = p.adjust(p, method = "BH"))
}) 

#Create data frame
global_effects <- mean_effects %>% 
  left_join(adj_pvalue) %>%
  select(cell_line, drug = condition, global_diff, global_p_adj)



```

#PCA for al RPE1 PRO & DEF IPRs
```{r}
#Chromatin data Pro & Def IPRs
chrom_data <- inhibitor_effect_chromatin_RPE1 %>%
  filter(binsize == 2000 & cell_line != "RPE1") %>%
  ungroup() %>%
  select(barcode,cell_line, chip_H3K36me3, dam_H3K27me3, dam_H3K9me3) %>%
  distinct()

#Check that profiles are similar for Pro & Def
#chip_K36me3
ggplot(chrom_data) +
  geom_histogram(aes(chip_H3K36me3, fill = cell_line), alpha = 0.3, binwidth = 0.3) +
  theme_bw() +
  ylim(c(0,25))

#dam_K27me3
ggplot(chrom_data) +
  geom_histogram(aes(dam_H3K27me3, fill = cell_line), alpha = 0.3, binwidth = 0.25) +
  theme_bw() +
  ylim(c(0,25))

#dam_K9me3
ggplot(chrom_data) +
  geom_histogram(aes(dam_H3K9me3, fill = cell_line), alpha = 0.3, binwidth = 0.25) +
  theme_bw() +
  ylim(c(0,25))

```

#Create those binning of the three marks
```{R}
#Breaks
breaks_K36 <- c(min(chrom_data$chip_H3K36me3)-0.01,seq(-1.5,1.5,by = 1),max(chrom_data$chip_H3K36me3)+0.01)
breaks_K9 <- c(min(chrom_data$dam_H3K9me3)-0.01,seq(-1.5,1.5,by = 1),max(chrom_data$dam_H3K9me3)+0.01)
breaks_K27 <- c(min(chrom_data$dam_H3K27me3)-0.01,seq(-1.5,1.5,by = 1),max(chrom_data$dam_H3K27me3)+0.01)

#binned data
binned_chrom_data <- chrom_data %>% 
  mutate(bin_K36 = cut(chip_H3K36me3, breaks= breaks_K36),
         bin_K27 = cut(dam_H3K27me3, breaks= breaks_K27),
         bin_K9 = cut(dam_H3K9me3, breaks= breaks_K9))

#Calculate average bin_value
#K9me3
K9me3_average <- binned_chrom_data %>%
  dplyr::group_by(bin_K9) %>%
  dplyr::summarise(mean_K9_bin = mean(dam_H3K9me3),
                   K9_IPR_n = n())

#K36me3
K36me3_average <- binned_chrom_data %>%
  dplyr::group_by(bin_K36) %>%
  dplyr::summarise(mean_K36_bin = mean(chip_H3K36me3),
                   K36_IPR_n = n())

#K27me3
K27me3_average <- binned_chrom_data %>%
  dplyr::group_by(bin_K27) %>%
  dplyr::summarise(mean_K27_bin = mean(dam_H3K27me3),
                   K27_IPR_n = n())

#Join all the data
binned_chromatin_data_mean <- binned_chrom_data %>% 
  left_join(K9me3_average) %>%
  left_join(K27me3_average) %>%
  left_join(K36me3_average)


#How much of this is in the same bin
bin_summary <- binned_chromatin_data_mean %>%
  dplyr::group_by(mean_K36_bin,mean_K27_bin,mean_K9_bin,cell_line) %>%
  dplyr::summarise(counts = n()) %>%
  reshape2::dcast(mean_K36_bin + mean_K27_bin + mean_K9_bin ~ cell_line, value.var = "counts") %>%
  na.omit()
  
```
#CONCLUSION: I put all the chromatin data together

#Add pathway balance values
```{r}
#Lef_join with data
binned_chromatin_data <- pathway_metric_control_bio %>%
  dplyr::group_by(barcode,cell_line,condition) %>%
  dplyr::summarise(mean_bal = mean(log2_bal),
                   reps = n()) %>%
  filter(reps > 1) %>%
  left_join(binned_chromatin_data_mean) %>% 
  na.omit()
  

#Test for K9me3 & LBR2
K9me3_bin_balance <- binned_chromatin_data %>%
  filter(condition == "LBR2") %>%
  dplyr::group_by(cell_line, mean_K9_bin) %>%
  dplyr::summarise(mean_bin = mean(mean_bal),
                   IPR_n = n()) %>%
  reshape2::dcast(mean_K9_bin ~ cell_line, value.var = "mean_bin") %>%
  mutate(diff_bined = RPEDef - RPEPro) %>% na.omit()

#Test for K36me3 & LBR2
K36me3_bin_balance <- binned_chromatin_data %>%
  filter(condition == "LBR2") %>%
  dplyr::group_by(cell_line, mean_K36_bin) %>%
  dplyr::summarise(mean_bin = mean(mean_bal),
                   IPR_n = n()) %>%
  reshape2::dcast(mean_K36_bin ~ cell_line, value.var = "mean_bin") %>%
  mutate(diff_bined = RPEDef - RPEPro) %>% na.omit()


#Test for K36me3 & LBR2
K27me3_bin_balance <- binned_chromatin_data %>%
  filter(condition == "LBR2") %>%
  dplyr::group_by(cell_line, mean_K27_bin) %>%
  dplyr::summarise(mean_bin = mean(mean_bal),
                   IPR_n = n()) %>%
  reshape2::dcast(mean_K27_bin ~ cell_line, value.var = "mean_bin") %>%
  mutate(diff_bined = RPEDef - RPEPro) %>% na.omit()

```

#Test a PCA test with the integrations in similar chromatin contexts
```{r}
#all data
chrom_binned_data_bal <- bin_summary %>% 
  left_join(binned_chromatin_data) %>% 
  filter(condition != "tracr") %>%
  mutate(perturbation = paste0(cell_line,":",condition))

#Control data
control_bined_data <- chrom_binned_data_bal %>% 
  filter(perturbation == "RPEPro:LBR2") %>%
  select(mean_K9_bin,mean_K36_bin,mean_K27_bin,ctr_bal = mean_bal)

#differential calculation
diff_binned_data <- chrom_binned_data_bal %>% 
  left_join(control_bined_data) %>%
  mutate(diff_bal = mean_bal - ctr_bal) %>%
  select(perturbation, diff_bal, mean_K36_bin, mean_K27_bin, mean_K9_bin) %>%
  filter(perturbation != "RPEPro:LBR2")

#Test lm for one
drug_CCDs_dt_RPE1 <- tibble(perturbation = NA, r.squared = NA, adj.r.squared = NA,p.value = NA)
for (j in unique(diff_binned_data$perturbation)){
    gene.library.dt <- filter(diff_binned_data, perturbation == j)
    set.seed(1)
    PCR_model_DDR_test <- pls::pcr(diff_bal~ mean_K36_bin + mean_K27_bin+ mean_K9_bin, data=gene.library.dt , validation="CV") #Run principal component regression
    pcr_pred <- predict(PCR_model_DDR_test, gene.library.dt, ncomp = 3) #Run model with three PC
    combined.dt <- tibble(measured = gene.library.dt$diff_bal, predicted = as.numeric(pcr_pred)) #Create table with real and predicted differentials
    pred_vs_estim <- lm(formula = measured ~ predicted, data = combined.dt) %>% broom::glance() #Predicted vs. measured correlation plot
    drug_CCDs_dt_RPE1 <- drug_CCDs_dt_RPE1 %>% add_row(perturbation = j, r.squared = pred_vs_estim %>% pull(r.squared), adj.r.squared = pred_vs_estim %>% pull(adj.r.squared), p.value = pred_vs_estim %>% pull(p.value)) #Extract valuable metrics
  }





```



#PCR modeling: RPE1 data
```{r}
#Create an empty dt with CCDs of DDR proteins
drug_CCDs_dt_RPE1 <- tibble(cell_line = NA, drug = NA,binsize = NA, r.squared = NA, adj.r.squared = NA,p.value = NA)
for (j in unique(inhibitor_effect_chromatin_RPE1$cell_line)){
  for (i in unique(inhibitor_effect_chromatin_RPE1$condition)){
    gene.library.dt <- filter(inhibitor_effect_chromatin_RPE1, condition == i & cell_line == j & binsize == 2000)
    set.seed(1)
    PCR_model_DDR_test <- pls::pcr(mean_diff~ dam_H3K9me3+dam_H3K27me3+chip_H3K27ac+chip_H3K4me1+ chip_H3K36me3+chip_H3K4me3+chip_H3K4me2+dam_H3K9me2+dam_LMNB1+late_replicating + dam_LMNB2, data=gene.library.dt , validation="CV") #Run principal component regression
    pcr_pred <- predict(PCR_model_DDR_test, gene.library.dt, ncomp = 3) #Run model with three PC
    combined.dt <- tibble(measured = gene.library.dt$mean_diff, predicted = as.numeric(pcr_pred)) #Create table with real and predicted differentials
    pred_vs_estim <- lm(formula = measured ~ predicted, data = combined.dt) %>% broom::glance() #Predicted vs. measured correlation plot
    drug_CCDs_dt_RPE1 <- drug_CCDs_dt_RPE1 %>% add_row(cell_line = j, drug = i,binsize = 2000, r.squared = pred_vs_estim %>% pull(r.squared), adj.r.squared = pred_vs_estim %>% pull(adj.r.squared), p.value = pred_vs_estim %>% pull(p.value)) #Extract valuable metrics
  }
  }

#Adjust per cell line
adj_drug_dt_RPE1_adjs <- map_dfr(cells, function(x) {
  drug_CCDs_dt_RPE1 %>% filter(cell_line == x) %>% mutate(p.adj = p.adjust(p.value, method = "BH"))
})
```

#PCR modeling: U2OS data
```{r}
#Create an empty dt with CCDs of DDR proteins
drug_CCDs_dt_U2OS <- tibble(cell_line = NA, drug = NA, binsize = NA, r.squared = NA, adj.r.squared = NA,p.value = NA)
for (j in unique(inhibitor_effect_chromatin_U2OS$cell_line)){
  for (i in unique(inhibitor_effect_chromatin_U2OS$condition)){
    gene.library.dt <- filter(inhibitor_effect_chromatin_U2OS, condition == i & cell_line == j & binsize == 2000)
    set.seed(1)
    PCR_model_DDR_test <- pls::pcr(mean_diff~ chip_H3K36me2+chip_H3K36me3+chip_H3K4me2+chip_H3K56ac+ chip_H3K79me2+chip_H3K9me2+chip_H3K9me3+chip_POL2S2+dam_LMNB1, data=gene.library.dt , validation="CV") #Run principal component regression

    pcr_pred <- predict(PCR_model_DDR_test, gene.library.dt, ncomp = 3) #Run model with three PC
    combined.dt <- tibble(measured = gene.library.dt$mean_diff, predicted = as.numeric(pcr_pred)) #Create table with real and predicted differentials
    pred_vs_estim <- lm(formula = measured ~ predicted, data = combined.dt) %>% broom::glance() #Predicted vs. measured correlation plot
    drug_CCDs_dt_U2OS <- drug_CCDs_dt_U2OS %>% add_row(cell_line = j, drug = i, binsize = 2000, r.squared = pred_vs_estim %>% pull(r.squared), adj.r.squared = pred_vs_estim %>% pull(adj.r.squared), p.value = pred_vs_estim %>% pull(p.value)) #Extract valuable metrics
  }
}

#Adjust per cell line
adj_drug_dt_U2OS <- drug_CCDs_dt_U2OS%>% mutate(p.adj = p.adjust(p.value, method = "BH"))
```

#Combine both
```{r}
CCD_inhibitors <- adj_drug_dt_RPE1_adjs %>% bind_rows(adj_drug_dt_U2OS) %>% na.omit()
signif_CCD_inh <- CCD_inhibitors %>% filter(p.adj < 0.1)

print(signif_CCD_inh)
```
#Conclusion: with the current chromatin data ATMi treatment has significant CCDs in RPE1 cells and DNAPKi with RPE1 & RPEPro cells.

#Calculate slopes for RPE
```{r}
#Create empty dataframe to calculate synergy scores
drug_CCD_slopes_RPE <- tibble(drug = NA, feature = NA, slope.log2 = NA, term = NA,p.value = NA, cell_line = NA, binsize = NA)

#Loop to run linear models on the values
for (h in unique(inhibitor_effect_chromatin_RPE1$condition)) {
  for(i in unique(inhibitor_effect_chromatin_RPE1$cell_line)) {
  for (j in colnames(inhibitor_effect_chromatin_RPE1)[7:17]) { #Run this function for each of the 25 high quality chromatin features
    model.dt <- inhibitor_effect_chromatin_RPE1 %>% filter(condition == h & cell_line == i & binsize == 2000) # And For each gene
   if (nrow(model.dt) == 0) {
next
}
    model.epistasis.log2 <- lm(formula = mean_diff ~ unlist(model.dt[j]), data = model.dt) %>% tidy() #Correlation analysis
   drug_CCD_slopes_RPE <- drug_CCD_slopes_RPE %>% add_row(drug = h,binsize =2000, feature = j,cell_line = i, slope.log2 = model.epistasis.log2 %>% pull(estimate), term = model.epistasis.log2 %>% pull(term), p.value = model.epistasis.log2 %>% pull(p.value)) #Select valuable parameters and save them in data frame
  }
  }
}

#Retain slopes that 
drug_CCD_all_values <- drug_CCD_slopes_RPE %>% 
  reshape2::dcast(drug + feature + cell_line ~ term, value.var = "slope.log2") %>%  #dcast table
  dplyr::select(drug, cell_line,feature,intercept = '(Intercept)', slope = 'unlist(model.dt[j])') %>% #Extract information for slopes only
  left_join(adj_drug_dt_RPE1_adjs) %>% 
  left_join(global_effects) %>%
  mutate(CCD_value = case_when(drug == "ATMi" & slope < 0 ~ slope,
                               drug == "ATMi"& slope > 0 ~ 0,
                               drug == "DNAPKi" & slope > 0 ~ slope,
                               drug == "DNAPKi" & slope < 0 ~ 0, T ~ slope)) %>% #Call M-synergies, N-synergies or no synergies based on the slope and MMEJ:NHEJ differentials
  na.omit() 
```

#Calculate slopes for U2OS
```{r}
#Create empty dataframe to calculate synergy scores
drug_CCD_slopes_U2OS <- tibble(drug = NA, feature = NA, slope.log2 = NA, term = NA,p.value = NA, cell_line = NA, binsize = NA)

#Loop to run linear models on the values
for (h in unique(inhibitor_effect_chromatin_U2OS$condition)) {
  for(i in unique(inhibitor_effect_chromatin_U2OS$cell_line)) {
  for (j in colnames(inhibitor_effect_chromatin_U2OS)[7:15]) { #Run this function for each of the 25 high quality chromatin features
    model.dt <- inhibitor_effect_chromatin_U2OS %>% filter(condition == h & cell_line == i & binsize == 2000) # And For each gene
   if (nrow(model.dt) == 0) {
next
}
    model.epistasis.log2 <- lm(formula = mean_diff ~ unlist(model.dt[j]), data = model.dt) %>% tidy() #Correlation analysis
   drug_CCD_slopes_U2OS <- drug_CCD_slopes_U2OS %>% add_row(drug = h, binsize = 2000, feature = j,cell_line = i, slope.log2 = model.epistasis.log2 %>% pull(estimate), term = model.epistasis.log2 %>% pull(term), p.value = model.epistasis.log2 %>% pull(p.value)) #Select valuable parameters and save them in data frame
  }
  }
}

#Retain slopes that 
drug_CCD_all_values_U2OS <- drug_CCD_slopes_U2OS %>% 
  reshape2::dcast(drug + feature + cell_line ~ term, value.var = "slope.log2") %>%  #dcast table
  dplyr::select(drug, cell_line,feature,intercept = '(Intercept)', slope = 'unlist(model.dt[j])') %>% #Extract information for slopes only
  left_join(adj_drug_dt_U2OS) %>%
  left_join(global_effects) %>%
  mutate(CCD_value = case_when(drug == "ATMi" & slope < 0 ~ slope, drug == "ATMi"& slope > 0 ~ 0, drug == "DNAPKi" & slope > 0 ~ slope, drug == "DNAPKi" & slope < 0 ~ 0, T ~ slope)) %>% #Call M-synergies, N-synergies or no synergies based on the slope and MMEJ:NHEJ differentials
  na.omit() 
```


#Plot CCDs of ATM and DNAPK inhibitors
```{r}
chromatin_features <- c("late_replicating","LMNB1","LMNB2","H3K9me2","H3K9me3","H3K27me3","H3K36me3","H3K4me1","H3K4me2","H3K4me3","H3K27ac")


#Import K562_data
CCD_K562 <- readRDS("/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/data/processed_data/xv20220816_drug_CCD_results.rds") %>%
  mutate(cell_line = "K562")

CCD_RPE <- drug_CCD_all_values %>% mutate(chrom_feature = gsub("(c|d).*_","",feature)) %>% dplyr::select(CCD_synergy_score = CCD_value, drug, cell_line, chrom_feature, CCD_model_p_adj = p.adj, global_diff, global_p_adj)

CCD_U2OS <- drug_CCD_all_values_U2OS %>% mutate(chrom_feature =gsub(".*_","",feature)) %>% dplyr::select(CCD_synergy_score = CCD_value, drug, cell_line, chrom_feature, CCD_model_p_adj = p.adj, global_diff,global_p_adj)

CCD_dt <- bind_rows(CCD_K562, CCD_RPE, CCD_U2OS)

#Plot in the same style as 
ggplot(CCD_dt %>% filter(CCD_model_p_adj < 0.1)) + 
  geom_tile(aes(fct_relevel(cell_line,c("K562","RPE1","RPEPro","RPEDef")), fct_relevel(chrom_feature,chromatin_features), fill = CCD_synergy_score)) + 
  geom_point(data = CCD_dt %>% filter(CCD_synergy_score != 0 & CCD_model_p_adj < 0.1), aes(cell_line, fct_relevel(chrom_feature)))+
  scale_fill_gradient2(low = "#8c510a" ,mid = "#f5f5f5", high = "#01665e", breaks = c(-1,-0.5,0, 0.5,1), limits = c(-1,1), oob = squish)  + 
  coord_fixed(expand = F) + theme_bw() + theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5), axis.title = element_blank(), legend.position = "top") + facet_wrap(~ drug)

```
#CONCLUSION: There are chromatin context dependencies and some of them seem to be conserved. Others dependent on the cell type. 
ATM inhibitor has H3K27me3 CCD in most cell lines and DNAPK inhibitor H3K36me3.

#Plot correlation plots for H3K27me3 & LMNB1 with ATMi and DNAPKi with H3K36me3
```{r, message=F, warning=F}
#With H3K27me3 and ATMi
ggplot(inhibitor_effect_chromatin_RPE1 %>% filter(condition == "ATMi" & binsize == 2000), aes(dam_H3K27me3,mean_diff)) +
  geom_point() +
  geom_smooth(se = F, method = "lm") + 
  ggpubr::stat_cor(method = "pearson") +
  facet_wrap(~ fct_relevel(cell_line, cells)) +
  theme_bw() + geom_hline(yintercept = 0, linetype = 2)


#With H3K36me3 and DNAPKi
ggplot(inhibitor_effect_chromatin_RPE1 %>% filter(condition == "DNAPKi" & binsize == 2000), aes(chip_H3K36me3,mean_diff)) +
  geom_point() +
  geom_smooth(se = F, method = "lm") + 
  ggpubr::stat_cor(method = "pearson") +
  facet_wrap(~ fct_relevel(cell_line, cells)) +
  theme_bw() + geom_hline(yintercept = 0, linetype = 2)

```

#Test balances with large bins and only PRO & DEF
```{r}
ggplot(inhibitor_effect_chromatin_RPE1 %>% filter(condition == "ATMi" & binsize == 20000 & cell_line %in% c("RPEPro","RPEDef")), aes(dam_H3K27me3,mean_diff)) +
  geom_point() +
  geom_smooth(se = F, method = "lm") + 
  ggpubr::stat_cor(method = "pearson") +
  facet_wrap(~ fct_relevel(cell_line, cells)) +
  theme_bw() + geom_hline(yintercept = 0, linetype = 2)

ggplot(inhibitor_effect_chromatin_RPE1 %>% filter(condition == "ATMi" & binsize == 20000 & cell_line %in% c("RPEPro","RPEDef")), aes(dam_H3K9me3,mean_diff)) +
  geom_point() +
  geom_smooth(se = F, method = "lm") + 
  ggpubr::stat_cor(method = "pearson") +
  facet_wrap(~ fct_relevel(cell_line, cells)) +
  theme_bw() + geom_hline(yintercept = 0, linetype = 2)

ggplot(inhibitor_effect_chromatin_RPE1 %>% filter(condition == "ATMi" & binsize == 20000 & cell_line %in% c("RPEPro","RPEDef")), aes(chip_H3K27ac,mean_diff)) +
  geom_point() +
  geom_smooth(se = F, method = "lm") + 
  ggpubr::stat_cor(method = "pearson") +
  facet_wrap(~ fct_relevel(cell_line, cells)) +
  theme_bw() + geom_hline(yintercept = 0, linetype = 2)

```

#Test balances with large bins and only PRO & DEF
```{r}
ggplot(inhibitor_effect_chromatin_RPE1 %>% filter(condition == "DNAPKi" & binsize == 2000 & cell_line %in% c("RPEPro","RPEDef")), aes(dam_H3K27me3,mean_diff)) +
  geom_point() +
  geom_smooth(se = F, method = "lm") + 
  ggpubr::stat_cor(method = "pearson") +
  facet_wrap(~ fct_relevel(cell_line, cells)) +
  theme_bw() + geom_hline(yintercept = 0, linetype = 2)

ggplot(inhibitor_effect_chromatin_RPE1 %>% filter(condition == "DNAPKi" & binsize == 2000 & cell_line %in% c("RPEPro","RPEDef")), aes(dam_H3K9me3,mean_diff)) +
  geom_point() +
  geom_smooth(se = F, method = "lm") + 
  ggpubr::stat_cor(method = "pearson") +
  facet_wrap(~ fct_relevel(cell_line, cells)) +
  theme_bw() + geom_hline(yintercept = 0, linetype = 2)

ggplot(inhibitor_effect_chromatin_RPE1 %>% filter(condition == "DNAPKi" & binsize == 2000 & cell_line %in% c("RPEPro","RPEDef")), aes(chip_H3K36me3,mean_diff)) +
  geom_point() +
  geom_smooth(se = F, method = "lm") + 
  ggpubr::stat_cor(method = "pearson") +
  facet_wrap(~ fct_relevel(cell_line, cells)) +
  theme_bw() + geom_hline(yintercept = 0, linetype = 2)

```
#ATM inhibitor
```{r}
ggplot(inhibitor_effect_chromatin_RPE1 %>% filter(condition == "ATMi" & binsize == 2000 & cell_line %in% c("RPEPro","RPEDef")), aes(dam_H3K27me3,mean_diff)) +
  geom_point() +
  geom_smooth(se = F, method = "lm") + 
  ggpubr::stat_cor(method = "pearson") +
  facet_wrap(~ fct_relevel(cell_line, cells)) +
  theme_bw() + geom_hline(yintercept = 0, linetype = 2)

ggplot(inhibitor_effect_chromatin_RPE1 %>% filter(condition == "ATMi" & binsize == 2000 & cell_line %in% c("RPEPro","RPEDef")), aes(dam_H3K9me3,mean_diff)) +
  geom_point() +
  geom_smooth(se = F, method = "lm") + 
  ggpubr::stat_cor(method = "pearson") +
  facet_wrap(~ fct_relevel(cell_line, cells)) +
  theme_bw() + geom_hline(yintercept = 0, linetype = 2)

ggplot(inhibitor_effect_chromatin_RPE1 %>% filter(condition == "ATMi" & binsize == 2000 & cell_line %in% c("RPEPro","RPEDef")), aes(chip_H3K36me3,mean_diff)) +
  geom_point() +
  geom_smooth(se = F, method = "lm") + 
  ggpubr::stat_cor(method = "pearson") +
  facet_wrap(~ fct_relevel(cell_line, cells)) +
  theme_bw() + geom_hline(yintercept = 0, linetype = 2)

```

#PCR modeling: RPE1 data (only reliable dataset)
```{r}
#Create an empty dt with CCDs of DDR proteins
drug_CCDs_dt_RPE1_test <- tibble(cell_line = NA, drug = NA,binsize = NA, r.squared = NA, adj.r.squared = NA,p.value = NA)
for (j in c("RPEPro","RPEDef")){
  for (i in unique(inhibitor_effect_chromatin_RPE1$condition)){
    gene.library.dt <- filter(inhibitor_effect_chromatin_RPE1, condition == i & cell_line == j & binsize == 2000)
    set.seed(1)
    PCR_model_DDR_test <- pls::pcr(mean_diff~ dam_H3K9me3+dam_H3K27me3+chip_H3K36me3, data=gene.library.dt , validation="CV") #Run principal component regression
    pcr_pred <- predict(PCR_model_DDR_test, gene.library.dt, ncomp = 3) #Run model with three PC
    combined.dt <- tibble(measured = gene.library.dt$mean_diff, predicted = as.numeric(pcr_pred)) #Create table with real and predicted differentials
    pred_vs_estim <- lm(formula = measured ~ predicted, data = combined.dt) %>% broom::glance() #Predicted vs. measured correlation plot
    drug_CCDs_dt_RPE1_test <- drug_CCDs_dt_RPE1_test %>% add_row(cell_line = j, drug = i,binsize = 2000, r.squared = pred_vs_estim %>% pull(r.squared), adj.r.squared = pred_vs_estim %>% pull(adj.r.squared), p.value = pred_vs_estim %>% pull(p.value)) #Extract valuable metrics
  }
  }

#Adjust per cell line
adj_drug_dt_RPE1_adjs_pro <- map_dfr(cells, function(x) {
  drug_CCDs_dt_RPE1_test %>% filter(cell_line == x) %>% mutate(p.adj = p.adjust(p.value, method = "BH"))
})
```



#Export data table
```{r}
write_rds(CCD_dt, file = "~/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/data/revisions/pools_balance/xv20230814_CCD_analysis_summary.rds")

```