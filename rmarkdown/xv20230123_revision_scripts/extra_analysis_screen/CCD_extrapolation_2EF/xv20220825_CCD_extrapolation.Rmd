---
title: "xv20220623_CCD_preprocessing"
author: "x.vergara"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output:
  html_document:
    theme: journal #cerulean
    highlight: monochrome
    toc: true
    toc_float: true
    code_folding: show
  editor_options:
    chunk_output_type: console
---

In this document, I will go over different calculations of epistasis.4 different workflows:
First decision is whether to use log2 MMEJscore or MMEJscore
Second decision is comparing slopes or statistic differences between WT vs. KO slopes
```{r setup, include=FALSE} 
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
```


```{r}
knitr::opts_chunk$set(root.dir = '/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/rmarkdown/xv20210920_paper_scripts/short_version/knit_html/')

StartTime <-Sys.time()
library(knitr)

# 8-digit Date tag:
Date <- substr(gsub("-","",Sys.time()),1,8)

#Change in.dir accordingly
in.dir <- "/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/"

#Check if output contain datetag
saveRDS_proof <- function(object, file) {
  document_path <- rstudioapi::getSourceEditorContext()$path %>% str_split(pattern = "/") %>% unlist()
  document_name <- document_path[length(document_path)]
  log_path <- paste0(in.dir,"log")
  sys_time <- Sys.time()
  if (grepl(Date, file) == T) {
    #print(mode(log_path))
    #base::write(c("test", as.character(sys_time),"Output", object), file = log_path, ncolumns = 4, sep = "\t", append = T)
    saveRDS(object, file)
  }
  else {
    print("Incorrect datetag!")
  }
}

#Read rds check through different versions
readRDS_proof <- function(path, pat) {
  full.path <- paste0(in.dir, path)
  document_path <- rstudioapi::getSourceEditorContext()$path %>% str_split(pattern = "/") %>% unlist()
  document_name <- document_path[length(document_path)]
  sys_time <- Sys.time()
  
  if(file.exists(full.path) == T){
    if(paste0(in.dir,path) != getwd()){
      setwd(paste0(in.dir, path))
  }
    file.list <- list.files(pattern = pat)
    correct_file <- str_sort(file.list, decreasing = T)[1]
    print(correct_file)
    write(c(document_name,as.character(sys_time) ,"Input", correct_file), file = paste0(in.dir,"log"), ncolumns = 4, sep = "\t", append = T)
    readRDS(correct_file)
    
  }
  else{
  setwd(path)
  file.list <- list.files(pattern = pat)
  correct_file <- str_sort(file.list, decreasing = T)[1]
  print(correct_file)
  write(c(document_name, as.character(sys_time),"Input", correct_file),file = paste0(in.dir,"log"), ncolumns = 4, sep = "\t", append = T)
  readRDS(correct_file)
  }
}
```

# Libraries
```{r libraries, warning = FALSE}
# libraries:
library(tidyverse)
library(reshape2)
library(broom)
library(dendextend)
library(pls)
library(broom)
library(stats)
library(MASS)
library(rstatix)
library(parallel)
library(data.table)
library(readxl)
```

#Import data for extrapolation
```{r}
setwd(in.dir)
#delta log2 MMEJ::NHEJ data for CCD extrapolation
log2.distance.ratio <- readRDS(file = "data/processed_data/CCD_analysis/xv20220819_log2_MMEJNHEJ_differentials_chromatin_KO.rds")

#Main result table for comparison with other data
export_screen_result_TS7 <- readRDS(file = "data/processed_data/xv20220927_Table_S7_DR_screen_results.rds")


#Chromatin features of the DSB-TRIP pool
chromatin_features_pool <-  clone5_z.score_chrom_tib %>% filter(grepl("RSTP2",pool))

```

# First approach: Use linear regression of individual features to predict pool data
```{r}


```

# Substep B: Principal component regression to identify repair proteins with CCDs
```{r}
#Filter genes that do not significantly perturb balance and add chromatin info
DDR.KO.CCD.dt <- log2.distance.ratio %>%
  filter(sample == "KO") %>%
  left_join(clone5_z.score_chrom_tib, by = c("barcode" = "ID")) %>% #Join chromatin info
  left_join(fit.z.scores.ratio.IPR.filtered, by = c("gene", "well", "plate","sample")) %>% na.omit() #Filter genes that do not perturb MMEJ:NHEJ balance

#Create an empty dt with CCDs of DDR proteins
DDR_KO_CCDs_dt <- tibble(gene = NA, r.squared = NA, adj.r.squared = NA,p.value = NA)

for (i in unique(DDR.KO.CCD.dt$gene)){
gene.library.dt <- filter(DDR.KO.CCD.dt, gene == i)
set.seed(1)
PCR_model_DDR_test <- pcr(mean.log2foldchange~CTCF+EZH2+H2AFZ+H3K27ac+H3K27me3+H3K36me3+H3K4me1+H3K4me2+H3K4me3+H3K79me2+H3K9me2+H3K9me3+H4K5acK8ac+HDAC1+HDAC2+HDAC3+POL2+POL2AS2+SMC3+LMNB1+Dam+DNAse+m5C+late_replicating+TTseq, data=gene.library.dt , validation="CV") #Run principal component regression

pcr_pred <- predict(PCR_model_DDR_test, gene.library.dt, ncomp = 3) #Run model with three PC
combined.dt <- tibble(measured = gene.library.dt$mean.log2foldchange, predicted = as.numeric(pcr_pred)) #Create table with real and predicted differentials
pred_vs_estim <- lm(formula = measured ~ predicted, data = combined.dt) %>% glance() #Predicted vs. measured correlation plot
DDR_KO_CCDs_dt <- DDR_KO_CCDs_dt %>% add_row(gene = i, r.squared = pred_vs_estim %>% pull(r.squared), adj.r.squared = pred_vs_estim %>% pull(adj.r.squared), p.value = pred_vs_estim %>% pull(p.value)) #Extract valuable metrics
}

```


#Bind both and correct p-value
```{r}
#non-targeting (2 non-targeting values are selected with this value)
adj_p.value_model <- DDR_NT_CCDs_model %>% mutate(sample = "WT") %>% 
  bind_rows(DDR_KO_CCDs_dt %>%
              mutate(sample = "KO")) %>% 
  na.omit() %>%
  dplyr::select(p.value, gene,sample)  %>% 
  mutate(p.adj = p.adjust(p.value, method = "BH")) %>% 
  dplyr::select(gene,p.value,p.adj, sample)

#Check the number of significant hits per WT and KO
samples_significant_CCDs <- adj_p.value_model %>% 
  filter(p.adj < 0.05) %>% #5% FDR
  dplyr::group_by(sample) %>%
  dplyr::summarise(counts = n())#1 mock values have significant CCDs (3% of total proteins) & 89 KO proteins

#Do these proteins favor MMEJ or NHEJ
summary_genes <- adj_p.value_model %>% 
  filter(p.adj < 0.05 & sample == "KO") %>% #5% FDR
  left_join(fit.z.scores.ratio.IPR.filtered) %>%
  dplyr::group_by(pathway_signif) %>%
  dplyr::summarise(count = n())

#Print
print(paste("We identified a total of",samples_significant_CCDs[1,"counts"], "DR proteins with significant CCD with a estimated FDR 5%"))
print(paste("We empirically tested the FDR and found that ",samples_significant_CCDs[2,"counts"], " out of 33 mock KO samples (3%) were called significant confirming low FDR"))
```

#Predict max and min DSB-TRIP values based on linear regression from clone 5 (only for combinations with CCDs)
```{r}
#All comparisons to be made between proteins with
comparison_to_make <- export_screen_result_TS7 %>% 
  filter(CCD_model_p_adj < 0.05 & CCD_synergy_score != 0) %>%
  select(gene, chrom_feature) %>%
  distinct()

#Create empty dataframe to calculate synergy scores
DR_KO_CCD_slopes <- tibble(gene = NA, feature = NA, slope.log2 = NA, term = NA,p.value = NA)

#Loop to run linear models on the values
DSB_TRIP_predictions <- map2_dfr(comparison_to_make$gene, comparison_to_make$chrom_feature, function(x,y) {
  model.dt <- log2.distance.ratio %>%
    filter(gene == x)
  model.epistasis.log2 <- lm(formula = mean.log2foldchange ~ unlist(model.dt[y]), data = model.dt)
  predicted_values <- predict(model.epistasis.log2, as.data.frame(unlist(chromatin_features_pool[y])))
  tibble(gene = x,
         feature = y,
         min_predict = min(predicted_values),
         perc_05_predict = quantile(predicted_values, 0.005),
         perc_025_predict = quantile(predicted_values, 0.025),
         mean_predict = mean(predicted_values),
         perc_975_predict = quantile(predicted_values, 0.975),
         perc_995_predict = quantile(predicted_values, 0.995),
         max_predict = max(predicted_values),
         delta_99 = abs(perc_995_predict - perc_05_predict),
         delta_95 = abs(perc_975_predict - perc_025_predict))
})

```

#Step 6: Compute estimated ∆log2MMEJ:NHEJ scores for CCD effects and compared to global ∆log2MMEJ:NHEJ
##Pre-processing chunk: load all ChIP track z-scores
```{r}
#


##99% CI for each feature
CI99_chromatin_features <- chromatin_features_plot %>% dplyr::group_by(variable) %>% dplyr::summarise(CI0.5 = quantile(value, 0.005), CI99.5 = quantile(value, 0.995), range = CI99.5 - CI0.5, mean = mean(value))

##DNA repair protein class (CCD, global, both)
global_effect_proteins <- mean.diff.balance.export %>% filter(p.adj < 0.001) %>% pull(gene) %>% unique() #Filter genes with significant global ∆log2MMEJ:NHEJ scores
CCD_proteins <- DR_KO_CCD_all_values %>% filter(model_p.adj < 0.05) %>% pull(gene) %>% unique() #Filter genes with significand CCD ∆log2MMEJ:NHEJ scores
#All classes
both_CCD_global_proteins <- intersect(global_effect_proteins, CCD_proteins) #Check for overlap
only_global <- setdiff(global_effect_proteins, both_CCD_global_proteins) #Only global effects
only_CCD <- setdiff(CCD_proteins, both_CCD_global_proteins) #Only CCDs

# Create a summary table with three protein classes
classes_summary <- tibble(gene = c(both_CCD_global_proteins,only_global,only_CCD), 
                          class = c(rep("both", length(both_CCD_global_proteins)),rep("global",length(only_global)), rep("CCD", length(only_CCD))))

##Compute estimated CCD ∆log2MMEJ:NHEJ score
estimated_FC_CCD <- DR_KO_CCD_all_values %>% 
  left_join(CI99_chromatin_features, by = c("feature" ="variable")) %>% #Join 99% CI for chromatin
  mutate(estim_fc_CCD = range*CCD_value) %>% #Calculate range
  full_join(classes_summary, by = "gene") #Join class they belong

##Select the maximum estimated effect for each gene
max_estimated_FC_CCD_gene <- estimated_FC_CCD %>% 
  dplyr::group_by(gene) %>% 
  dplyr::summarise(m_CCD_FC_nhej = max(estim_fc_CCD), 
                   m_CCD_FC_mmej = min(estim_fc_CCD)) %>% 
  reshape2::melt(value.name = "m_CCD_FC", id.vars = "gene") %>% 
  filter(m_CCD_FC != 0)

## Filter max(CCDs)
max_estimated_CCD_FC <- estimated_FC_CCD %>% 
  mutate(m_CCD_FC = estim_fc_CCD) %>% 
  right_join(max_estimated_FC_CCD_gene) %>% 
  dplyr::select(-m_CCD_FC) %>%
  full_join(classes_summary)

#Left_join mean.fc
estimated_CCD_global <- max_estimated_CCD_FC %>% 
  full_join(mean.diff.balance.export, by = "gene")

#Summary table class of DR proteins
summary_DR_prot_class <- estimated_CCD_global %>% dplyr::select(class,gene) %>% distinct() %>% dplyr::group_by(class) %>% dplyr::summarise(count = n())

#Print output of the chunk
print(paste("We find",summary_DR_prot_class$count[1] + summary_DR_prot_class$count[2], "DR proteins with CCD. Among these,", summary_DR_prot_class$count[1],"have global effects as well and", summary_DR_prot_class$count[2], "have exclusively CCD effect. Additionally, we find", summary_DR_prot_class$count[3], "DR proteins that have global effect only"))

```

#Step 7: Data visualization
This step will be performed with the output files in separate scripts 

#Create table S4: Mean ∆log2MMEJ:NHEJ balance of each well.
```{r}
export_screen_result_TS4 <- log2.distance.ratio %>% 
  mutate(screen_position = paste0(plate, "_", well),
         KO_type = case_when(sample == "KO" ~ "KO_gRNA",
                             sample == "WT" ~ "mock_KO",
                             sample == "POLQ" ~ "POLQ_KO")) %>% 
  dplyr::select(gene,KO_type,screen_position, IPR_barcode = "barcode", delta_log2_MMEJ_NHEJ = "mean.log2foldchange", number_replicates = "n_rep")
```

#Create table S6: 
Genomic coordinates and chromatin feature scores for clone 5 (19 IPR).
```{r}
#load genomic locations of 19 IPRs
IPR_locations <- read.csv("/DATA/projects/DSBrepair/data/cl20220222_mapping_RSTP2_clones.csv", header = F)
colnames(IPR_locations) <- c("IPR_barcode","clone","chr","position", "strand")

# Data table to export
export_screen_result_TS6 <- IPR_locations %>% right_join(clone5_z.score_chrom_tib %>% filter(ID %in% barcodes.list), by = c("IPR_barcode" = "ID")) %>% dplyr::select(-pool,-binsize, -clone)
```

#Create table S7: Data to export all major features
```{r}
export_screen_result_TS7 <- estimated_FC_CCD %>% 
  mutate(screen_position = paste0(plate, "_", well)) %>% 
  left_join(mean.diff.balance.export, by = "gene") %>%
  dplyr::select(gene,screen_position, CCD_model_p_adj = "model_p.adj",chrom_feature = "feature", CCD_synergy_score = "CCD_value",CCD_estim_diff = "estim_fc_CCD", global_diff = "mean.balance.diff", global_p_adj = "p.adj", DR_effect_type = "class")

```


#Output files: Export all files needed for making figures
```{r, eval = FALSE, echo = FALSE}
setwd(in.dir)

#Step 1: Raw freqCut & log2MMEJNHEJ values
saveRDS_proof(screen.data.names.tib, file = "data/processed_data/CCD_analysis/xv20220819_screening_raw_data_repair_metrics.rds")

#Step 2: dcast data table for 
saveRDS_proof(log2.distance.ratio, file = "data/processed_data/CCD_analysis/xv20220819_differentials_log2_MMEJ_NHEJ_balance.rds")

#Step 3: z-scores every step
saveRDS_proof(fit.null.distribtution.log2Ratio, file = "data/processed_data/CCD_analysis/xv20220819_z_test_null_distribution_parameters.rds") #Null distribution parameters
saveRDS_proof(fit.z.scores.ratio.IPR, file = "data/processed_data/CCD_analysis/xv20220819_z_test_per_replicate_transformation.rds") #Z-test without any averaging
saveRDS_proof(fit.z.scores.ratio.mean, file = "data/processed_data/CCD_analysis/xv20220819_z_test_final_values.rds") #Z-test values

#Step 4: diff log2 MMEJ:NHEJ values for DR proteins with chromatin scores
saveRDS_proof(DDR.KO.CCD.dt, file = "data/processed_data/CCD_analysis/xv20220819_log2_MMEJNHEJ_differentials_chromatin_KO.rds")

#Step 5: save global changes for all proteins
saveRDS_proof(mean.diff.balance.export, file = "data/processed_data/CCD_analysis/xv20220819_global_diff_MMEJNHEJ.rds")

#Save final results as rds
saveRDS_proof(export_screen_result_TS7, file = "data/processed_data/xv20220927_Table_S7_DR_screen_results.rds")

```

#Export supplementary tables in the paper
```{r, eval = FALSE, echo = FALSE}
setwd(in.dir)
#Export for supplementary files (.xlsx file)

#Table S4: ∆log2MMEJ:NHEJ scores for 519 proteins and 19 IPRs.
write.xlsx(export_screen_result_TS4, file = "data/supplementary_tables/xv20220819_Table_S4a_delta_log2_MMEJ_NHEJ.xlsx")

#Table S6: Genomic coordinates, chromatin feature scores and barcodes of 19 IPRs in K562 clone 5
write.xlsx(export_screen_result_TS6, file = "data/supplementary_tables/xv20220819_Table_S6_clone_5_chromatin_features.xlsx")

#Table S7: Chromatin context dependent effects of proteins in the screen.
write.xlsx(export_screen_result_TS7, file = "data/supplementary_tables/xv20220927_Table_S7a_global_CCD_MMEJ_NHEJ_results.xlsx")

```
