---
title: "xv20230329_RPE1_pool_pathway assay"
author: "Xabier Vergara"
date: "2023-07-26"
output:
  html_document: default
  pdf_document: default
---
#Date: 28th August 2023
#Author: Xabier Vergara

#Aim: The aim of this file is to start with the first checks on the screening validation data. Answer questions like, do we need more sequencing depth, did all cell lines work, did all replicates work nicely?
I will only focus on DEF cells for this.

#Conclusions: Overall, it looks better than last experiment. But, the conclusions remain very similar to the previous experiment. With the weird result on U2OS cells, that show positive correlation between balance and TIF.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(plotly)
library(ggbeeswarm)
library(pheatmap)
```

## Import data
```{r, warning=F, message=F}

# List files in mcclintock
pathway_assay_files <- list.files("/DATA/projects/DSBrepair/data/xv20230714_E2286_pool_pathway_assay/indelPCR_counts",pattern = '*[.]co', full.names = T) 

#Read and parse files
clone_pools_pathway_assay <- map_dfr(pathway_assay_files, function(x){
  read_delim(x, show_col_types = F) %>% 
  mutate(filename = gsub("/DATA/projects/DSBrepair/data/xv20230714_E2286_pool_pathway_assay/indelPCR_counts/","",x),
         outcome = paste(call, indel, sep = "_")) %>%
  separate(filename, into = c("exp_n","sample_ID","cell_line","gRNA","bio_rep","t_rep"))
})

```


#Number of mapped IPRs with indel data (most optimistic)
```{r}
#Export data frame
chromatin_data_RPE1 <- readRDS(file = "/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/data/revisions/validation_screen/xv20230919_chromatin_data_RPE1.rds")
```
#CONCLUSION: We are recovering the whole complexity for U2OS & PRO (input 400 ng). With DEF & RPE we are not capturing full complexity (input 200 ng).

#Combine
```{r}
#Filter by replicate
indel_data <- clone_pools_pathway_assay %>% 
  dplyr::group_by(barcode,outcome, cell_line, gRNA, bio_rep) %>%
  mutate(cell_line = case_when(cell_line == "RPEPro" ~ "PRO",
                               cell_line == "RPEDef" ~ "DEF",
                               T ~ cell_line)) %>%
  dplyr::summarise(counts = sum(count, na.rm = F)) %>% left_join(chromatin_data_RPE1) %>% filter(cell_line != "U2OS" & bio_rep != "R4") %>% na.omit()
```


#Calculate total reads per sample and per barcode
```{r}
#Reads per sample
total_sample_reads <- indel_data %>%
  dplyr::group_by(cell_line, gRNA,bio_rep) %>%
  dplyr::summarise(total_sample_reads = sum(counts))

#Reads per barcode 
total_IPR_reads <- indel_data %>%
  dplyr::group_by(cell_line, gRNA, bio_rep, barcode) %>%
  dplyr::summarise(total_IPR_reads = sum(counts))

#Left_join
relative_barcode_reads <- left_join(total_sample_reads, total_IPR_reads) %>%
  mutate(IPR_read_freq = total_IPR_reads/total_sample_reads) %>% distinct()

```


#Compute pathway balance in controls
```{r}
#Filter signature indels in control samples
control_balance_bio <- indel_data %>% filter( outcome %in% c("ins_1","del_-7","wt_0"))

#Look at read numbers
control_balance_bio_dcast <- control_balance_bio %>% reshape2::dcast(barcode + cell_line + gRNA + bio_rep ~ outcome, value.var = "counts", fill = 0, fun.aggregate = mean)

#Control_measurements (bio_rep)
pathway_metric_control_bio <- control_balance_bio_dcast %>%
  mutate(log2_bal = log2((`del_-7` + 1)/(ins_1 + 1))) %>%
  na.omit() %>% left_join(relative_barcode_reads)
```


#Plot relative read frequency in some samples
```{r, fig.height = 2.5, fig.width=5}
#Make plots IPR frequency plot
ggplot(pathway_metric_control_bio) +
  geom_quasirandom(aes(bio_rep, IPR_read_freq)) + 
  facet_grid(cell_line~gRNA, scales = "free") +
  theme_bw() +
  ggtitle("Frequency of IPR") +
  ylab("IPR frequency in pool") + xlab("Biological replicate")

```


#Plot relative abundance to balance
```{r,fig.width=9,fig.height=3.5}
#Make plots gRNA
ggplot(pathway_metric_control_bio %>% filter(gRNA != "empty")) +
  geom_point(aes(IPR_read_freq,log2((`del_-7`+1)/(ins_1+1)))) + 
  theme_bw() + facet_grid(bio_rep ~ cell_line, scales = "free") +
  ylab("log2 MMEJ:NHEJ") + xlab("IPR frequency in pool") +
  ggtitle("Frequency of IPR vs. log2 MMEJ:NHEJ", subtitle = "RPE1-hTERT p53-BRCA1 dKO DSB-TRIP pool")
```

#Compute data by minimum read number
```{r}
#Filter by read number and plot noise level
read_count <- c(0,0.001,0.0025,0.005,0.0075,0.01)

filter_read_count_test <- map_dfr(read_count , function(x) {
  barcodes_filter <- pathway_metric_control_bio %>%
    group_by(barcode, gRNA, cell_line) %>%
    dplyr::mutate(mean_freq = mean(IPR_read_freq)) %>%
    filter(mean_freq > x) %>%
    mutate(read_filter = x)
})

#Number of IPRs in each
IPR_summary <- filter_read_count_test %>% 
  dplyr::group_by(cell_line, gRNA, read_filter, bio_rep) %>% 
  dplyr::summarize(IPR_n = n()) 

IPR_summary_dcast <- IPR_summary %>% 
  reshape2::dcast(cell_line + gRNA + bio_rep ~ read_filter, value.var  = "IPR_n")

```
#Conclusion: we always get some barcodes, but these are extremely low in RPE1 cells


#Check reproducibility among replicates
```{r}
#Calculate co-ocurrence per replicate
replicates_IPR <- filter_read_count_test %>%
  dplyr::group_by(barcode,cell_line, read_filter,gRNA) %>%
  dplyr::summarise(rep_n = n()) %>%
  ungroup() %>%
  dplyr::group_by(cell_line, read_filter,rep_n,gRNA) %>%
  dplyr::summarise(capture_IPR = n())

total_IPR_rep <- filter_read_count_test %>%
  select(cell_line, barcode, read_filter,gRNA) %>% 
  distinct() %>%
  dplyr::group_by(cell_line,read_filter,gRNA) %>%
  dplyr::summarise(total_IPR = n())

#Calculate frequency
freq_IPR_capture <- replicates_IPR %>% 
  left_join(total_IPR_rep) %>%
  mutate(freq_capture = capture_IPR/total_IPR)

#Absolute_numbers
IPR_reps <- replicates_IPR %>% reshape2::dcast(cell_line + gRNA + rep_n ~ read_filter)

```

#Is pathway balance reproducible among replicates?
```{r, message=F, warning=F}
read_counts_filter_reprod <- filter_read_count_test %>%
  reshape2::dcast(barcode + cell_line + gRNA + read_filter ~ bio_rep, value.var = "log2_bal")

#Calculate mean & sd
read_counts_filter_reprod_summary <- read_counts_filter_reprod %>% 
  rowwise() %>% 
  mutate(mean_bal = mean(c(R1,R2,R3),na.rm = T),
         sd_bal = sd(c(R1,R2,R3), na.rm = T),
         reps = 3 - sum(is.na(c(R1,R2,R3)))) %>%
  distinct()


#R1 vs. R2
ggplot(read_counts_filter_reprod_summary, aes(R1,R2)) +
  geom_point() + 
  geom_smooth(method = "lm") +
  ggpubr::stat_cor() +
  facet_wrap(~ read_filter) +
  theme_bw()

#R1 vs. R2
ggplot(read_counts_filter_reprod_summary, aes(R2,R3)) +
  geom_point() + 
  geom_smooth(method = "lm") +
  ggpubr::stat_cor() +
  facet_wrap(~ read_filter) +
  theme_bw()

#R1 vs. R2
ggplot(read_counts_filter_reprod_summary, aes(R1,R3)) +
  geom_point() + 
  geom_smooth(method = "lm") +
  ggpubr::stat_cor() +
  facet_wrap(~ read_filter, scales = "free") +
  theme_bw()
```

#Conclusion: To get high reproducibility in the results, we really need to be very stringent with the cut-off. I will try to repeat a similar filtering with total number of read cut-off and see how it looks.


#Calculate delta log2 MMEJ:NHEJ (frequency of 0.0075)
```{r}
#Filter barcodes with reads
filtered_indel_data_DEF <- pathway_metric_control_bio %>%
  filter(IPR_read_freq > 0.008 & gRNA != "tracr" & bio_rep != "R4" & cell_line == "DEF") %>% #In this file, I will remove the viability note
  group_by(barcode, gRNA) %>%
  dplyr::mutate(reps = n()) %>%
  ungroup() %>%
  filter(reps == 3)

#Aproximately 20 retained

#extract control data
control_indel_data_DEF <- filtered_indel_data_DEF %>%
  filter(gRNA == "LBR2") %>%
  ungroup() %>%
  select(barcode, cell_line, bio_rep, ntc_log2_bal = log2_bal)

#Prepare data frame
diff_data_DEF <- filtered_indel_data_DEF %>%
  left_join(control_indel_data_DEF) %>%
  mutate(diff_balance = log2_bal - ntc_log2_bal)

#combine replicates
combined_diff_data_DEF <- diff_data_DEF %>%
  dplyr::group_by(barcode, cell_line, gRNA) %>%
  dplyr::summarise(mean_diff_balance = mean(diff_balance, na.rm = T),
                   reps = n()) %>% na.omit()

#20 are lost (17 ~ 18)
```

#PRO cells
```{r}
#Filter barcodes with reads
filtered_indel_data_PRO <- pathway_metric_control_bio %>%
  filter(IPR_read_freq > 0.002 & gRNA != "tracr" & bio_rep != "R4" & cell_line == "PRO") %>% #In this file, I will remove the viability note
  group_by(barcode, gRNA) %>%
  dplyr::mutate(reps = n()) %>%
  ungroup() %>%
  filter(reps == 3)

#Aproximately 20 retained

#extract control data
control_indel_data_PRO <- filtered_indel_data_PRO %>%
  filter(gRNA == "LBR2") %>%
  ungroup() %>%
  select(barcode, cell_line, bio_rep, ntc_log2_bal = log2_bal)

#Prepare data frame
diff_data_PRO <- filtered_indel_data_PRO %>%
  left_join(control_indel_data_PRO) %>%
  mutate(diff_balance = log2_bal - ntc_log2_bal)

#combine replicates
combined_diff_data_PRO <- diff_data_PRO %>%
  dplyr::group_by(barcode, cell_line, gRNA) %>%
  dplyr::summarise(mean_diff_balance = mean(diff_balance, na.rm = T),
                   reps = n()) %>% na.omit()

#20 are lost (~ 40 left)
```

#RPE1 cells
```{r}
#Filter barcodes with reads
filtered_indel_data_RPE1_freq <- pathway_metric_control_bio %>%
  filter(IPR_read_freq > 0.008 & gRNA != "tracr" & bio_rep != "R4" & cell_line == "RPE1") %>% #In this file, I will remove the viability note
  group_by(barcode, gRNA) %>%
  dplyr::mutate(reps = n()) %>%
  ungroup() %>%
  filter(reps == 3)

#There are only 5 barcodes left, due to the drift. I need to filter data differently
filtered_indel_data_barcodes <- pathway_metric_control_bio %>%
  filter(`del_-7` > 5 & ins_1 > 5 & gRNA == "LBR2" & bio_rep != "R4" & cell_line == "RPE1") %>% #In this file, I will remove the viability note
  group_by(barcode, gRNA) %>%
  dplyr::mutate(reps = n()) %>%
  ungroup() %>%
  filter(reps == 3) %>% pull(barcode) %>% unique()

#Select these barcodes here
filtered_indel_data_RPE1 <- pathway_metric_control_bio %>%
  filter(barcode %in% filtered_indel_data_barcodes & gRNA != "tracr" & bio_rep != "R4" & cell_line == "RPE1") %>% #In this file, I will remove the viability note
  group_by(barcode, gRNA)



```

#Combine both filtered data
```{r}
filtered_data_PRO_DEF <- filtered_indel_data_PRO %>% bind_rows(filtered_indel_data_DEF,filtered_indel_data_RPE1)


```

#Plot plot control log2 MMEJ"NHEJ balance
```{r,fig.width=7,fig.height=3.5}
#Plot balance in filtered samples
filtered_data_plot <- pathway_metric_control_bio %>%
  group_by(barcode, gRNA) %>%
  dplyr::mutate(mean_freq = mean(IPR_read_freq),
                mean_bal = mean(log2_bal),
                reps = n()) %>%
  filter(IPR_read_freq > 0.005 & reps > 2 & is.finite(log2_bal) & gRNA != "tracr")

#Make plots gRNA
ggplot(filtered_data_plot) +
  geom_quasirandom(aes(gRNA,log2(`del_-7`/ins_1))) + 
  theme_bw() + facet_grid(cell_line~ bio_rep) +
  ylab("log2 MMEJ:NHEJ") + xlab("Sample in experiment") +
  ggtitle("log2 MMEJ:NHEJ balance", subtitle = "RPE1-hTERT p53-BRCA1 dKO DSB-TRIP pool")
```


#Plot point kept in the fish-tail plots
```{r, fig.width=10, fig.height=4}
#Make plots gRNA
ggplot() +
  geom_point(data=pathway_metric_control_bio %>% filter(gRNA != "empty"), 
             aes(IPR_read_freq,log2((`del_-7`+1)/(ins_1+1)))) + 
  geom_point(data=filtered_indel_data %>% filter(gRNA != "empty"), 
             aes(IPR_read_freq,log2((`del_-7`+1)/(ins_1+1))), color ="red") + 
  theme_bw() + facet_wrap(~ bio_rep) +
  ylab("log2 MMEJ:NHEJ") + xlab("IPR frequency in pool") +
  ggtitle("Frequency of IPR vs. log2 MMEJ:NHEJ", subtitle = "RPE1-hTERT p53-BRCA1 dKO DSB-TRIP pool")
```

#Plot deltas per replicate
```{r}
#Plot balance
ggplot(diff_data %>% filter(reps > 2)) + 
  geom_quasirandom(aes(gRNA,diff_balance)) +
  facet_grid(cell_line ~ bio_rep) + theme_bw()
```


#Plot mean values per cell line
```{r}
mean_per_cell_line <- combined_diff_data %>%
  filter(!gRNA %in% c("NTC","LBR2","halfLBR2","empty")) %>%
  dplyr::group_by(cell_line, gRNA) %>%
  dplyr::summarise(global_effect = mean(mean_diff_balance, na.rm = T),
                   sd_global = sd(mean_diff_balance, na.rm = T))

mean_per_cell_line_dcast <- mean_per_cell_line %>% 
  reshape2::dcast(gRNA ~ cell_line, value.var = "global_effect")

```

#Plot global effect similarity in RPE1 and K562 cells
```{r, fig.width=6, fig.height = 3}
#Gene order based on K562 data
ggplot(combined_diff_data %>% filter(reps > 2 & cell_line != "RPE1" & gRNA != "LBR2")) +
  geom_quasirandom(aes(cell_line,mean_diff_balance)) + 
  facet_wrap(~ gRNA) + 
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90,
                                   hjust = 1,
                                   vjust = 0.5),
        legend.position = "top",
        axis.title.x = element_blank()) +
  geom_hline(yintercept = 0, linetype = 2) +
  ylab("log2 MMEJ::NHEJ") +
  labs(fill = "Cell line")

#ATM inhibitor effect BRCA1 positive and BRCA1 negative cells
wilcox_test <- combined_diff_data %>% 
  filter(cell_line != "RPE1" & gRNA != "LBR2" & reps > 2) %>% 
  dplyr::group_by(gRNA) %>% 
  wilcox_test(mean_diff_balance ~ cell_line, alternative = "greater")

```

#Some stats about filtered data
```{r}
#Number of mean IPRs per gRNA
mean_IPR_per_sample <- filtered_indel_data %>%
  select(gRNA, barcode,bio_rep) %>%
  distinct() %>%
  dplyr::group_by(gRNA,bio_rep) %>%
  dplyr::summarise(IPR_n = n()) %>%
  ungroup() %>%
  dplyr::group_by(bio_rep) %>%
  dplyr::summarise(mean_IPR = mean(IPR_n),
                   total_mapped_IPR = 261)

#Total mapped in pool
mean_read_per_sample <- filtered_indel_data %>%
  select(gRNA,total_sample_reads,bio_rep) %>%
  distinct() %>%
  dplyr::group_by(bio_rep) %>%
  dplyr::summarise(median_read_sample = median(total_sample_reads))

#Total reads per sample
median_read_per_sample <- filtered_indel_data %>%
  select(gRNA,total_sample_reads,bio_rep) %>%
  distinct() %>%
  dplyr::group_by(bio_rep) %>%
  dplyr::summarise(median_read_sample = median(total_sample_reads))


#Total reads per sample
median_read_per_IPR <- filtered_indel_data %>%
  select(gRNA,barcode,total_IPR_reads,bio_rep) %>%
  distinct() %>%
  dplyr::group_by(bio_rep) %>%
  dplyr::summarise(median_read_sample = min(total_IPR_reads))

#NTC reads per sample
median_read_NTC<- filtered_indel_data %>%
  filter(gRNA == "NTC") %>%
  select(barcode,total_IPR_reads,bio_rep) %>%
  distinct() %>%
  dplyr::group_by(bio_rep) %>%
  dplyr::summarise(mean_read_IPR = median(total_IPR_reads))


```

#Export data
```{r}
write_rds(filtered_data_PRO_DEF, file = "/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/data/revisions/inhibitors/xv20230919_inhibitors_PRO_DEF_freq.rds")

#Create data table for controls
#Filter barcodes with reads
controls_filter_data <- pathway_metric_control_bio %>%
  filter(IPR_read_freq > 0.005 & gRNA %in% c("LBR2"))

write_rds(controls_filter_data, file = "/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/data/revisions/inhibitors/xv20230919_inhibitors_control_data.rds")

```
