---
title: "xv20230329_RPE1_mapping_clone"
author: "Xabier Vergara"
date: "2023-03-29"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(plotly)
library(ggbeeswarm)
library(pheatmap)
library(broom)
library(scales)
```

## Import data: Balance data and some other details
```{r, warning=F}
# Import data for high confidence reporters and calculate mean
high_confidence_IPR <- readRDS("~/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/data/revisions/validation_screen/xv20230830_pathway_balance_5reads_per_indel.rds") %>% 
  filter(!gRNA %in% c("LBR2","halfLBR2","empty") & cell_line == "RPE1")


#Pools used in the experiment
selected_pools <- c("RPE1_Low_1000","RPE1Deff_Low_1000","RPE1Proff_Low_250","U2OS_High_100")

#Cell_line 
cells <- c("RPE1","PRO","DEF","U2OS")

```
#Calculate differentials per replicate
```{r}
dmso_balance <- high_confidence_IPR %>% filter(gRNA == "NTC") %>% select(barcode, cell_line, bio_rep, dmso_bal = log2_bal)

inhibitor_balance_calculation <- high_confidence_IPR %>% 
  filter(gRNA != "NTC") %>% 
  left_join(dmso_balance) %>% 
  mutate(diff_bal = log2_bal - dmso_bal) %>%
  na.omit()

mean_inhibitor_effect <- inhibitor_balance_calculation %>%
  dplyr::group_by(barcode, cell_line, gRNA) %>%
  dplyr::summarise(mean_diff = mean(diff_bal),
                   sd_diff = sd(diff_bal),
                   reps = n())
```

#Plot pathway balance changes
```{R}
ggplot(mean_inhibitor_effect) +
  ggbeeswarm::geom_quasirandom(aes(cell_line, mean_diff)) +
  facet_wrap(~ gRNA) +
  geom_hline(yintercept = 0, linetype = 2) +
  theme_bw()
```

#Bin chromatin data
```{r}
melt_chromatin <- chromatin_pools_binsize %>%
  filter(binsize == 2000) %>%
  reshape2::melt() %>%
  separate(variable, into = c("tech", "antibody")) %>%
  select(-tech)

#Calculate bins per antibody
binned_chromatin_pools <- map_dfr(unique(melt_chromatin$antibody), function(x) {
  map_dfr(unique(melt_chromatin$cell_line), function(y) {
  melt_chromatin %>%
    filter(antibody == x & cell_line == y) %>%
    mutate(percentile = ntile(value, n = 20)) %>%
    group_by(percentile,antibody,cell_line) %>%
    dplyr::mutate(bin_min = case_when(percentile == 1 ~ -10,
                                         T ~ min(value)),
                     bin_max = case_when(percentile == 20 ~ 10,
                                         T ~ max(value)),
                     bin_mean_chrom = mean(value),
                     IPR_n = n()) %>% distinct()
})
})

#dcast_binned_data 
dcast_binned_data <- binned_chromatin_pools %>%
  reshape2::dcast(barcode + cell_line + binsize ~ antibody, value.var = "bin_mean_chrom")

```


#Join chromatin data
```{r}
#Create RPE1 dataframe
inhibitor_effect_chromatin_RPE1 <- mean_inhibitor_effect %>%
  left_join() %>%
  na.omit()
```

#POLL vs. H3K4me1
```{r}


```


#Conclusion: Some quick plots suggest that CCDs might be conserved in RPE1!!!! Data in PRO and DEF is not so clear yet.


#Calculate global differences
```{r}
#Calculate mean effect
mean_effects <- mean_inhibitor_effect %>% 
  dplyr::group_by(cell_line, gRNA) %>%
  dplyr::summarise(global_diff = mean(mean_diff, na.rm = T))

#Calculate p.value calculation
p_val_global <- mean_inhibitor_effect %>% 
  dplyr::group_by(cell_line, gRNA) %>%
  rstatix::t_test(mean_diff ~ 0)

#Adjust p-value
adj_pvalue <- map_dfr(cells, function(x) {
  p_val_global %>% filter(cell_line == x) %>% mutate(global_p_adj = p.adjust(p, method = "BH"))
}) 

#Create data frame
global_effects <- mean_effects %>% 
  left_join(adj_pvalue) %>%
  select(cell_line, gRNA, global_diff, global_p_adj)

```


#PCR modeling: RPE1 data
```{r}

#Create an empty dt with CCDs of DDR proteins
drug_CCDs_dt_RPE1 <- tibble(cell_line = NA, gRNA = NA,binsize = NA, r.squared = NA, adj.r.squared = NA,p.value = NA)
for (j in c("PRO","DEF","RPE1")){
  for (i in unique(inhibitor_effect_chromatin_RPE1$gRNA)){
    gene.library.dt <- filter(inhibitor_effect_chromatin_RPE1, gRNA == i & cell_line == j & binsize == 2000)
    set.seed(1)
       if (nrow(gene.library.dt) < 9) {
next
}
    PCR_model_DDR_test <- pls::pcr(mean_diff~ chip_H3K27ac + chip_H3K36me3 + chip_H3K4me1 + chip_H3K4me3 + chip_H3K4me2 + dam_H3K27me3 + dam_H3K9me3 + dam_H3K9me3 + dam_LMNB1 + dam_LMNB2 + late_replicating, data=gene.library.dt , validation="CV") #Run principal component regression
    pcr_pred <- predict(PCR_model_DDR_test, gene.library.dt, ncomp = 3) #Run model with three PC
    combined.dt <- tibble(measured = gene.library.dt$mean_diff, predicted = as.numeric(pcr_pred)) #Create table with real and predicted differentials
    pred_vs_estim <- lm(formula = measured ~ predicted, data = combined.dt) %>% broom::glance() #Predicted vs. measured correlation plot
    drug_CCDs_dt_RPE1 <- drug_CCDs_dt_RPE1 %>% add_row(cell_line = j, gRNA = i,binsize = 2000, r.squared = pred_vs_estim %>% pull(r.squared), adj.r.squared = pred_vs_estim %>% pull(adj.r.squared), p.value = pred_vs_estim %>% pull(p.value)) #Extract valuable metrics
  }
  }

#Adjust per cell line
tmp <-  drug_CCDs_dt_RPE1 %>% dplyr::group_by(cell_line) %>% mutate(p.adj = p.adjust(p.value, method = "fdr"))

```

#Calculate slopes for RPE
```{r}
#Create empty dataframe to calculate synergy scores
drug_CCD_slopes_RPE <- tibble(gRNA = NA, feature = NA, slope.log2 = NA, term = NA,p.value = NA, cell_line = NA, binsize = NA)

#Loop to run linear models on the values
for (h in unique(inhibitor_effect_chromatin_RPE1$gRNA)) {
  for(i in unique(inhibitor_effect_chromatin_RPE1$cell_line)) {
  for (j in colnames(inhibitor_effect_chromatin_RPE1)[7:17]) { #Run this function for each of the 25 high quality chromatin features
    model.dt <- inhibitor_effect_chromatin_RPE1 %>% filter(gRNA == h & cell_line == i & binsize == 2000) # And For each gene
   if (nrow(model.dt) == 0) {
next
}
    model.epistasis.log2 <- lm(formula = mean_diff ~ unlist(model.dt[j]), data = model.dt) %>% tidy() #Correlation analysis
   drug_CCD_slopes_RPE <- drug_CCD_slopes_RPE %>% add_row(gRNA = h,binsize =2000, feature = j,cell_line = i, slope.log2 = model.epistasis.log2 %>% pull(estimate), term = model.epistasis.log2 %>% pull(term), p.value = model.epistasis.log2 %>% pull(p.value)) #Select valuable parameters and save them in data frame
  }
  }
}

#Retain slopes that 
drug_CCD_all_values <- drug_CCD_slopes_RPE %>% 
  reshape2::dcast(gRNA + feature + cell_line ~ term, value.var = "slope.log2") %>%  #dcast table
  dplyr::select(gRNA, cell_line,feature,intercept = '(Intercept)', slope = 'unlist(model.dt[j])') %>% #Extract information for slopes only 
mutate(CCD_value = case_when(intercept < 0 & slope < 0 ~ slope,
                               intercept < 0 & slope > 0 ~ 0,
                               intercept > 0 & slope > 0 ~ slope,
                               intercept > 0 & slope < 0 ~ 0, T ~ slope)) %>% #Call M-synergies, N-synergies or no synergies based on the slope and MMEJ:NHEJ differentials
  na.omit() 
```

#Calculate slopes for U2OS
```{r}
#Create empty dataframe to calculate synergy scores
drug_CCD_slopes_U2OS <- tibble(drug = NA, feature = NA, slope.log2 = NA, term = NA,p.value = NA, cell_line = NA, binsize = NA)

#Loop to run linear models on the values
for (h in unique(inhibitor_effect_chromatin_U2OS$condition)) {
  for(i in unique(inhibitor_effect_chromatin_U2OS$cell_line)) {
  for (j in colnames(inhibitor_effect_chromatin_U2OS)[7:15]) { #Run this function for each of the 25 high quality chromatin features
    model.dt <- inhibitor_effect_chromatin_U2OS %>% filter(condition == h & cell_line == i & binsize == 2000) # And For each gene
   if (nrow(model.dt) == 0) {
next
}
    model.epistasis.log2 <- lm(formula = mean_diff ~ unlist(model.dt[j]), data = model.dt) %>% tidy() #Correlation analysis
   drug_CCD_slopes_U2OS <- drug_CCD_slopes_U2OS %>% add_row(drug = h, binsize = 2000, feature = j,cell_line = i, slope.log2 = model.epistasis.log2 %>% pull(estimate), term = model.epistasis.log2 %>% pull(term), p.value = model.epistasis.log2 %>% pull(p.value)) #Select valuable parameters and save them in data frame
  }
  }
}

#Retain slopes that 
drug_CCD_all_values_U2OS <- drug_CCD_slopes_U2OS %>% 
  reshape2::dcast(drug + feature + cell_line ~ term, value.var = "slope.log2") %>%  #dcast table
  dplyr::select(drug, cell_line,feature,intercept = '(Intercept)', slope = 'unlist(model.dt[j])') %>% #Extract information for slopes only
  left_join(adj_drug_dt_U2OS) %>%
  left_join(global_effects) %>%
  mutate(CCD_value = case_when(drug == "ATMi" & slope < 0 ~ slope, drug == "ATMi"& slope > 0 ~ 0, drug == "DNAPKi" & slope > 0 ~ slope, drug == "DNAPKi" & slope < 0 ~ 0, T ~ slope)) %>% #Call M-synergies, N-synergies or no synergies based on the slope and MMEJ:NHEJ differentials
  na.omit() 
```


#Plot CCDs of ATM and DNAPK inhibitors
```{r}
chromatin_features <- c("late_replicating","LMNB1","LMNB2","H3K9me2","H3K9me3","H3K27me3","H3K36me3","H3K4me1","H3K4me2","H3K4me3","H3K27ac")


#Import K562_data
CCD_K562 <- readRDS("/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/data/processed_data/xv20220816_drug_CCD_results.rds") %>%
  mutate(cell_line = "K562")

CCD_RPE <- drug_CCD_all_values %>% mutate(chrom_feature = gsub("(c|d).*_","",feature)) %>% dplyr::select(CCD_synergy_score = CCD_value, drug, cell_line, chrom_feature, CCD_model_p_adj = p.adj, global_diff, global_p_adj)

CCD_U2OS <- drug_CCD_all_values_U2OS %>% mutate(chrom_feature =gsub(".*_","",feature)) %>% dplyr::select(CCD_synergy_score = CCD_value, drug, cell_line, chrom_feature, CCD_model_p_adj = p.adj, global_diff,global_p_adj)

CCD_dt <- bind_rows(CCD_K562, CCD_RPE, CCD_U2OS)

#Plot in the same style as 
ggplot(CCD_dt %>% filter(CCD_model_p_adj < 0.1)) + 
  geom_tile(aes(fct_relevel(cell_line,c("K562","RPE1","RPEPro","RPEDef")), fct_relevel(chrom_feature,chromatin_features), fill = CCD_synergy_score)) + 
  geom_point(data = CCD_dt %>% filter(CCD_synergy_score != 0 & CCD_model_p_adj < 0.1), aes(cell_line, fct_relevel(chrom_feature)))+
  scale_fill_gradient2(low = "#8c510a" ,mid = "#f5f5f5", high = "#01665e", breaks = c(-1,-0.5,0, 0.5,1), limits = c(-1,1), oob = squish)  + 
  coord_fixed(expand = F) + theme_bw() + theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5), axis.title = element_blank(), legend.position = "top") + facet_wrap(~ drug)

```
#CONCLUSION: There are chromatin context dependencies and some of them seem to be conserved. Others dependent on the cell type. 
ATM inhibitor has H3K27me3 CCD in most cell lines and DNAPK inhibitor H3K36me3.

#Plot correlation plots for H3K27me3 & LMNB1 with ATMi and DNAPKi with H3K36me3
```{r, message=F, warning=F}
#With H3K27me3 and ATMi
ggplot(inhibitor_effect_chromatin_RPE1 %>% filter(condition == "ATMi" & binsize == 2000), aes(dam_H3K27me3,mean_diff)) +
  geom_point() +
  geom_smooth(se = F, method = "lm") + 
  ggpubr::stat_cor(method = "pearson") +
  facet_wrap(~ fct_relevel(cell_line, cells)) +
  theme_bw() + geom_hline(yintercept = 0, linetype = 2)


#With H3K36me3 and DNAPKi
ggplot(inhibitor_effect_chromatin_RPE1 %>% filter(condition == "DNAPKi" & binsize == 2000), aes(chip_H3K36me3,mean_diff)) +
  geom_point() +
  geom_smooth(se = F, method = "lm") + 
  ggpubr::stat_cor(method = "pearson") +
  facet_wrap(~ fct_relevel(cell_line, cells)) +
  theme_bw() + geom_hline(yintercept = 0, linetype = 2)

```

#Test balances with large bins and only PRO & DEF
```{r}
ggplot(inhibitor_effect_chromatin_RPE1 %>% filter(condition == "ATMi" & binsize == 20000 & cell_line %in% c("RPEPro","RPEDef")), aes(dam_H3K27me3,mean_diff)) +
  geom_point() +
  geom_smooth(se = F, method = "lm") + 
  ggpubr::stat_cor(method = "pearson") +
  facet_wrap(~ fct_relevel(cell_line, cells)) +
  theme_bw() + geom_hline(yintercept = 0, linetype = 2)

ggplot(inhibitor_effect_chromatin_RPE1 %>% filter(condition == "ATMi" & binsize == 20000 & cell_line %in% c("RPEPro","RPEDef")), aes(dam_H3K9me3,mean_diff)) +
  geom_point() +
  geom_smooth(se = F, method = "lm") + 
  ggpubr::stat_cor(method = "pearson") +
  facet_wrap(~ fct_relevel(cell_line, cells)) +
  theme_bw() + geom_hline(yintercept = 0, linetype = 2)

ggplot(inhibitor_effect_chromatin_RPE1 %>% filter(condition == "ATMi" & binsize == 20000 & cell_line %in% c("RPEPro","RPEDef")), aes(chip_H3K27ac,mean_diff)) +
  geom_point() +
  geom_smooth(se = F, method = "lm") + 
  ggpubr::stat_cor(method = "pearson") +
  facet_wrap(~ fct_relevel(cell_line, cells)) +
  theme_bw() + geom_hline(yintercept = 0, linetype = 2)

```

#Test balances with large bins and only PRO & DEF
```{r}
ggplot(inhibitor_effect_chromatin_RPE1 %>% filter(condition == "DNAPKi" & binsize == 2000 & cell_line %in% c("RPEPro","RPEDef")), aes(dam_H3K27me3,mean_diff)) +
  geom_point() +
  geom_smooth(se = F, method = "lm") + 
  ggpubr::stat_cor(method = "pearson") +
  facet_wrap(~ fct_relevel(cell_line, cells)) +
  theme_bw() + geom_hline(yintercept = 0, linetype = 2)

ggplot(inhibitor_effect_chromatin_RPE1 %>% filter(condition == "DNAPKi" & binsize == 2000 & cell_line %in% c("RPEPro","RPEDef")), aes(dam_H3K9me3,mean_diff)) +
  geom_point() +
  geom_smooth(se = F, method = "lm") + 
  ggpubr::stat_cor(method = "pearson") +
  facet_wrap(~ fct_relevel(cell_line, cells)) +
  theme_bw() + geom_hline(yintercept = 0, linetype = 2)

ggplot(inhibitor_effect_chromatin_RPE1 %>% filter(condition == "DNAPKi" & binsize == 2000 & cell_line %in% c("RPEPro","RPEDef")), aes(chip_H3K36me3,mean_diff)) +
  geom_point() +
  geom_smooth(se = F, method = "lm") + 
  ggpubr::stat_cor(method = "pearson") +
  facet_wrap(~ fct_relevel(cell_line, cells)) +
  theme_bw() + geom_hline(yintercept = 0, linetype = 2)

```
#ATM inhibitor
```{r}
ggplot(inhibitor_effect_chromatin_RPE1 %>% filter(condition == "ATMi" & binsize == 2000 & cell_line %in% c("RPEPro","RPEDef")), aes(dam_H3K27me3,mean_diff)) +
  geom_point() +
  geom_smooth(se = F, method = "lm") + 
  ggpubr::stat_cor(method = "pearson") +
  facet_wrap(~ fct_relevel(cell_line, cells)) +
  theme_bw() + geom_hline(yintercept = 0, linetype = 2)

ggplot(inhibitor_effect_chromatin_RPE1 %>% filter(condition == "ATMi" & binsize == 2000 & cell_line %in% c("RPEPro","RPEDef")), aes(dam_H3K9me3,mean_diff)) +
  geom_point() +
  geom_smooth(se = F, method = "lm") + 
  ggpubr::stat_cor(method = "pearson") +
  facet_wrap(~ fct_relevel(cell_line, cells)) +
  theme_bw() + geom_hline(yintercept = 0, linetype = 2)

ggplot(inhibitor_effect_chromatin_RPE1 %>% filter(condition == "ATMi" & binsize == 2000 & cell_line %in% c("RPEPro","RPEDef")), aes(chip_H3K36me3,mean_diff)) +
  geom_point() +
  geom_smooth(se = F, method = "lm") + 
  ggpubr::stat_cor(method = "pearson") +
  facet_wrap(~ fct_relevel(cell_line, cells)) +
  theme_bw() + geom_hline(yintercept = 0, linetype = 2)

```

#PCR modeling: RPE1 data (only reliable dataset)
```{r}
#Create an empty dt with CCDs of DDR proteins
drug_CCDs_dt_RPE1_test <- tibble(cell_line = NA, drug = NA,binsize = NA, r.squared = NA, adj.r.squared = NA,p.value = NA)
for (j in c("RPEPro","RPEDef")){
  for (i in unique(inhibitor_effect_chromatin_RPE1$condition)){
    gene.library.dt <- filter(inhibitor_effect_chromatin_RPE1, condition == i & cell_line == j & binsize == 2000)
    set.seed(1)
    PCR_model_DDR_test <- pls::pcr(mean_diff~ dam_H3K9me3+dam_H3K27me3+chip_H3K36me3, data=gene.library.dt , validation="CV") #Run principal component regression
    pcr_pred <- predict(PCR_model_DDR_test, gene.library.dt, ncomp = 3) #Run model with three PC
    combined.dt <- tibble(measured = gene.library.dt$mean_diff, predicted = as.numeric(pcr_pred)) #Create table with real and predicted differentials
    pred_vs_estim <- lm(formula = measured ~ predicted, data = combined.dt) %>% broom::glance() #Predicted vs. measured correlation plot
    drug_CCDs_dt_RPE1_test <- drug_CCDs_dt_RPE1_test %>% add_row(cell_line = j, drug = i,binsize = 2000, r.squared = pred_vs_estim %>% pull(r.squared), adj.r.squared = pred_vs_estim %>% pull(adj.r.squared), p.value = pred_vs_estim %>% pull(p.value)) #Extract valuable metrics
  }
  }

#Adjust per cell line
adj_drug_dt_RPE1_adjs_pro <- map_dfr(cells, function(x) {
  drug_CCDs_dt_RPE1_test %>% filter(cell_line == x) %>% mutate(p.adj = p.adjust(p.value, method = "BH"))
})
```



#Export data table
```{r}
write_rds(CCD_dt, file = "~/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/data/revisions/pools_balance/xv20230814_CCD_analysis_summary.rds")

```