---
title: "xv20230830_validation_screen_chromatin_bias_controls"
author: "Xabier Vergara"
date: "2023-07-26"
output:
  html_document: default
  pdf_document: default
---
#Date: 30th August 2023
#Author: Xabier Vergara
#Aim: The aim of this file is to wrap up the filtering strategy and measure if pathway balance in control samples has chromatin biases in the control samples

#Load libraries
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(plotly)
library(ggbeeswarm)
library(pheatmap)
```


## Import data: Balance data and some other details
```{r, warning=F}
# Import data for high confidence reporters and calculate mean
high_confidence_IPR <- readRDS("~/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/data/revisions/validation_screen/xv20230830_pathway_balance_5reads_per_indel.rds") %>%
  dplyr::group_by(barcode, cell_line, gRNA) %>%
  dplyr::summarise(mean_bal = mean(log2_bal, na.rm = T),
                   reps = n())


#Pools used in the experiment
selected_pools <- c("RPE1_Low_1000","RPE1Deff_Low_1000","RPE1Proff_Low_250","U2OS_High_100")

#Pair of 
```

#Add chromatin info for RPE1 cells
#Load chromatin info of the IPRs in RPE cells (2000)
```{r, warning=F}
setwd("/DATA/projects/DSBrepair/data/DSB_TRIP_cell_lines_mapping/xv20230519_all_RPE_pools_mapping/")
# Load chip data
chip_files <- list.files(path = "chip/site_means", pattern = "2000_", full.names = T)
dam_files <- list.files(path = "dam", pattern = "2000_", full.names = T)
repli_files <- "coverage/RPE1_DSB_TRIP_pools-2000_summary.tsv"

#Make a dataframe with all the files
chromatin_features_pools_chip <- map(chip_files, function(x) {
  read.delim(x, header = T) %>%
    dplyr::select(ID, z_score) %>%
    na.omit() %>%
    mutate(file = paste0("chip_",str_extract(x, "H.*(?=_)"))) %>%
    reshape2::dcast(ID ~ file, value.var = "z_score")
}) %>% purrr::reduce(left_join, by = "ID")

#Make a dataframe with dam files
chromatin_features_pools_dam <- map(dam_files, function(x) {
  read.delim(x, header = T) %>%
    dplyr::select(name, z_score) %>%
    na.omit() %>%
    mutate(file = paste0("dam_",str_extract(x, "(?<=2000_).*(?=.txt)"))) %>%
    reshape2::dcast(name ~ file, value.var = "z_score")
}) %>% purrr::reduce(left_join, by = "name")

#Make a column for repliseq
repliseq_dataframe <- map_dfr(repli_files, function(x) {
  read.delim(x, header = T) %>%
    na.omit() %>%
    mutate(ratio_r1 = repliseq_r1_late - repliseq_r1_early, ratio_r2 = repliseq_r2_late - repliseq_r2_early) %>%
    mutate(late_replicating = scale((ratio_r1 + ratio_r2)/2)) %>%
    dplyr::select("ID" = barcode, late_replicating)
})

#Bind both
chromatin_features_pools_2000 <-  left_join(chromatin_features_pools_chip, chromatin_features_pools_dam, by = c("ID"="name")) %>%
  left_join(repliseq_dataframe) %>%
  separate(ID, into = c("barcode","iPCR_cell","iPCR_transfection","iPCR_complexity")) %>%
  mutate(pool = paste(iPCR_cell, iPCR_transfection,iPCR_complexity, sep = "_")) %>% 
  filter(pool %in% selected_pools) %>%
  mutate(cell_line = case_when(iPCR_cell == "RPE1Deff" ~ "DEF",
                               iPCR_cell == "RPE1Proff" ~ "PRO",
                               T ~ iPCR_cell)) %>%
  select(-pool, -iPCR_cell, -iPCR_transfection, -iPCR_complexity, - dam_LMNNB2) %>%
  mutate(binsize = "2000")
```


#Load chromatin info of the IPRs in RPE cells (5000)
```{r, warning=F}
setwd("/DATA/projects/DSBrepair/data/DSB_TRIP_cell_lines_mapping/xv20230519_all_RPE_pools_mapping/")
# Load chip data
chip_files <- list.files(path = "chip/site_means", pattern = "5000", full.names = T)
dam_files <- list.files(path = "dam", pattern = "5000", full.names = T)
repli_files <- "coverage/RPE1_DSB_TRIP_pools-5000_summary.tsv"

#Make a dataframe with all the files
chromatin_features_pools_chip <- map(chip_files, function(x) {
  read.delim(x, header = T) %>%
    dplyr::select(ID, z_score) %>%
    na.omit() %>%
    mutate(file = paste0("chip_",str_extract(x, "H.*(?=_)"))) %>%
    reshape2::dcast(ID ~ file, value.var = "z_score")
}) %>% purrr::reduce(left_join, by = "ID")

#Make a dataframe with dam files
chromatin_features_pools_dam <- map(dam_files, function(x) {
  read.delim(x, header = T) %>%
    dplyr::select(name, z_score) %>%
    na.omit() %>%
    mutate(file = paste0("dam_",str_extract(x, "(?<=5000_).*(?=.txt)"))) %>%
    reshape2::dcast(name ~ file, value.var = "z_score")
}) %>% purrr::reduce(left_join, by = "name")

#Make a column for repliseq
repliseq_dataframe <- map_dfr(repli_files, function(x) {
  read.delim(x, header = T) %>%
    na.omit() %>%
    mutate(ratio_r1 = repliseq_r1_late - repliseq_r1_early, ratio_r2 = repliseq_r2_late - repliseq_r2_early) %>%
    mutate(late_replicating = scale((ratio_r1 + ratio_r2)/2)) %>%
    dplyr::select("ID" = barcode, late_replicating)
})

#Bind both
chromatin_features_pools_5000 <-  left_join(chromatin_features_pools_chip, chromatin_features_pools_dam, by = c("ID"="name")) %>%
  left_join(repliseq_dataframe) %>%
  separate(ID, into = c("barcode","iPCR_cell","iPCR_transfection","iPCR_complexity")) %>%
  mutate(pool = paste(iPCR_cell, iPCR_transfection,iPCR_complexity, sep = "_")) %>% 
  filter(pool %in% selected_pools) %>%
  mutate(cell_line = case_when(iPCR_cell == "RPE1Deff" ~ "DEF",
                               iPCR_cell == "RPE1Proff" ~ "PRO",
                               T ~ iPCR_cell)) %>%
  select(-pool, -iPCR_cell, -iPCR_transfection, -iPCR_complexity, -dam_LMNNB2)  %>%
  mutate(binsize = "5000")
```


#Load chromatin info of the IPRs in RPE cells (10000)
```{r, warning=F}
setwd("/DATA/projects/DSBrepair/data/DSB_TRIP_cell_lines_mapping/xv20230519_all_RPE_pools_mapping/")
# Load chip data
chip_files <- list.files(path = "chip/site_means", pattern = "10000", full.names = T)
dam_files <- list.files(path = "dam", pattern = "10000", full.names = T)
repli_files <- "coverage/RPE1_DSB_TRIP_pools-10000_summary.tsv"

#Make a dataframe with all the files
chromatin_features_pools_chip <- map(chip_files, function(x) {
  read.delim(x, header = T) %>%
    dplyr::select(ID, z_score) %>%
    na.omit() %>%
    mutate(file = paste0("chip_",str_extract(x, "H.*(?=_)"))) %>%
    reshape2::dcast(ID ~ file, value.var = "z_score")
}) %>% purrr::reduce(left_join, by = "ID")

#Make a dataframe with dam files
chromatin_features_pools_dam <- map(dam_files, function(x) {
  read.delim(x, header = T) %>%
    dplyr::select(name, z_score) %>%
    na.omit() %>%
    mutate(file = paste0("dam_",str_extract(x, "(?<=10000_).*(?=.txt)"))) %>%
    reshape2::dcast(name ~ file, value.var = "z_score")
}) %>% purrr::reduce(left_join, by = "name")

#Make a column for repliseq
repliseq_dataframe <- map_dfr(repli_files, function(x) {
  read.delim(x, header = T) %>%
    na.omit() %>%
    mutate(ratio_r1 = repliseq_r1_late - repliseq_r1_early, ratio_r2 = repliseq_r2_late - repliseq_r2_early) %>%
    mutate(late_replicating = scale((ratio_r1 + ratio_r2)/2)) %>%
    dplyr::select("ID" = barcode, late_replicating)
})

#Bind both
chromatin_features_pools_10000 <-  left_join(chromatin_features_pools_chip, chromatin_features_pools_dam, by = c("ID"="name")) %>%
  left_join(repliseq_dataframe) %>%
  separate(ID, into = c("barcode","iPCR_cell","iPCR_transfection","iPCR_complexity")) %>%
  mutate(pool = paste(iPCR_cell, iPCR_transfection,iPCR_complexity, sep = "_")) %>% 
  filter(pool %in% selected_pools) %>%
  mutate(cell_line = case_when(iPCR_cell == "RPE1Deff" ~ "DEF",
                               iPCR_cell == "RPE1Proff" ~ "PRO",
                               T ~ iPCR_cell)) %>%
  select(-pool, -iPCR_cell, -iPCR_transfection, -iPCR_complexity)  %>%
  mutate(binsize = "10000")
```

#Load chromatin info of the IPRs in RPE cells (20000)
```{r, warning=F}
setwd("/DATA/projects/DSBrepair/data/DSB_TRIP_cell_lines_mapping/xv20230519_all_RPE_pools_mapping/")
# Load chip data
chip_files <- list.files(path = "chip/site_means", pattern = "20000", full.names = T)
dam_files <- list.files(path = "dam", pattern = "20000", full.names = T)
repli_files <- "coverage/RPE1_DSB_TRIP_pools-20000_summary.tsv"

#Make a dataframe with all the files
chromatin_features_pools_chip <- map(chip_files, function(x) {
  read.delim(x, header = T) %>%
    dplyr::select(ID, z_score) %>%
    na.omit() %>%
    mutate(file = paste0("chip_",str_extract(x, "H.*(?=_)"))) %>%
    reshape2::dcast(ID ~ file, value.var = "z_score")
}) %>% purrr::reduce(left_join, by = "ID")

#Make a dataframe with dam files
chromatin_features_pools_dam <- map(dam_files, function(x) {
  read.delim(x, header = T) %>%
    dplyr::select(name, z_score) %>%
    na.omit() %>%
    mutate(file = paste0("dam_",str_extract(x, "(?<=20000_).*(?=.txt)"))) %>%
    reshape2::dcast(name ~ file, value.var = "z_score")
}) %>% purrr::reduce(left_join, by = "name")

#Make a column for repliseq
repliseq_dataframe <- map_dfr(repli_files, function(x) {
  read.delim(x, header = T) %>%
    na.omit() %>%
    mutate(ratio_r1 = repliseq_r1_late - repliseq_r1_early, ratio_r2 = repliseq_r2_late - repliseq_r2_early) %>%
    mutate(late_replicating = scale((ratio_r1 + ratio_r2)/2)) %>%
    dplyr::select("ID" = barcode, late_replicating)
})

#Bind both
chromatin_features_pools_20000 <-  left_join(chromatin_features_pools_chip, chromatin_features_pools_dam, by = c("ID"="name")) %>%
  left_join(repliseq_dataframe) %>%
  separate(ID, into = c("barcode","iPCR_cell","iPCR_transfection","iPCR_complexity")) %>%
  mutate(pool = paste(iPCR_cell, iPCR_transfection,iPCR_complexity, sep = "_")) %>% 
  filter(pool %in% selected_pools) %>%
  mutate(cell_line = case_when(iPCR_cell == "RPE1Deff" ~ "DEF",
                               iPCR_cell == "RPE1Proff" ~ "PRO",
                               T ~ iPCR_cell)) %>%
  select(-pool, -iPCR_cell, -iPCR_transfection, -iPCR_complexity) %>%
  mutate(binsize = "20000")
```

#Import genomewide ranges for global range calculation
```{r}
setwd("/DATA/projects/DSBrepair/data/DSB_TRIP_cell_lines_mapping/xv20230519_all_RPE_pools_mapping/")
# Load chip data
dam_files_genomewide <- list.files(path = "track", pattern = "2kb", full.names = T)

#Make a dataframe with dam values at the IPRs (mean values, check dynamic range)
chromatin_features_pools_dam_genomewide <- map_dfr(dam_files_genomewide, function(x) {
  import(x) %>%
    as_tibble() %>%
    mutate(file = paste0("dam_",str_extract(x, "(?<=track/).*(?=-2kb)")))
})

# Load chip data
setwd("/DATA/projects/DSBrepair/data/DSB_TRIP_cell_lines_mapping/hg38/tracks/hTERT-RPE1/")
chip_files <- c(list.files(path = "Friskes2022/2kb", full.names = T)[c(2,4,5,6)],list.files(path = "Sun2018/2kb",pattern = "H3K4me2", full.names = T))
#chip_files_Sun <- list.files(path = "Sun2018/2kb",pattern = "H3K4me2", full.names = T)


#Make a dataframe with dam values at the IPRs (mean values, check dynamic range)
chromatin_features_pools_chip_genomewide <- map_dfr(chip_files, function(x) {
  import(x) %>%
    as_tibble() %>%
    mutate(file = paste0("chip_",str_extract(x, "H3.*(?=_GS)")))
})

# Load late_replicating
setwd("/DATA/projects/DSBrepair/data/DSB_TRIP_cell_lines_mapping/source_data/4DN_nucleome/RPE_repliseq/")
repli_files <-list.files(pattern= ".bw", full.names = T)

#Make a dataframe with dam values at the IPRs (mean values, check dynamic range)
chromatin_features_pools_repli_genomewide <- map_dfr(repli_files, function(x) {
  import(x) %>%
    as_tibble() %>%
    mutate(file = x)
}) %>% reshape2::dcast(seqnames + start + end + width ~ file, value.var = "score")

colnames(chromatin_features_pools_repli_genomewide) <- c("seqnames","start","end","width","repliseq_r1_early","repliseq_r2_late","repliseq_r1_late","repliseq_r2_early")

repli_genomewide <- chromatin_features_pools_repli_genomewide %>% mutate(repli_r1 = log2(repliseq_r1_late/repliseq_r1_early), repli_r2 = log2(repliseq_r2_late/repliseq_r2_early)) %>%
  mutate(score = (repli_r1 + repli_r2)/2, file = "late_replicating") %>% na.omit() %>% filter(is.finite(score)) %>% select(score, file, seqnames, start,end, width)



chromatin_features_pools_genomewide <- bind_rows(chromatin_features_pools_dam_genomewide,chromatin_features_pools_chip_genomewide, repli_genomewide)

#Calculate genomewide range (summarize and calculate CI0.005 and CI99.5)
summary_CI99_genomewide <- chromatin_features_pools_genomewide %>%
  dplyr::group_by(file) %>%
  mutate(z_score = scale(score)) %>%
  dplyr::summarise(CI0.5 = quantile(z_score, 0.005),
                   CI99.5 = quantile(z_score, 0.995),
                   range = CI99.5 - CI0.5,
                   mean = mean(z_score))

#Export genomewide ranges
export_RPE1_ranges <- saveRDS(summary_CI99_genomewide, file = "/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/data/revisions/pools_balance/xv202301009_RPE1_genomewide_ranges.rds")

```



#Merge all binsizes in one data table
```{r}
#Bind the chromatin data for all binsizes
chromatin_pools_binsize <- bind_rows(chromatin_features_pools_20000,
                                     chromatin_features_pools_10000,
                                     chromatin_features_pools_5000,
                                     chromatin_features_pools_2000)

#Write rds
write_rds(chromatin_pools_binsize, file = "/home/x.vergara/XV_P3_ChromDSBScreen/xv_CRISPR_screen_figures/data/revisions/validation_screen/xv20230919_chromatin_data_RPE1.rds")
```

